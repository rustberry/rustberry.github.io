<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.1" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.1">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.1" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.4.1',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="programming and free market">
<meta property="og:type" content="website">
<meta property="og:title" content="Rust Shrugged">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Rust Shrugged">
<meta property="og:description" content="programming and free market">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Rust Shrugged">
<meta name="twitter:description" content="programming and free market">






  <link rel="canonical" href="http://yoursite.com/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Rust Shrugged</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Rust Shrugged</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about" rel="section">
      <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />About</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />Tags</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories" rel="section">
      <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />Categories</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives" rel="section">
      <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />Archives</a>
  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/22/Zookeeper/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Rust">
      <meta itemprop="description" content="programming and free market">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/22/Zookeeper/" itemprop="url">
                  ZooKeeper：分布式过程协同技术详解 -- 读书笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-09-22 00:18:40 / Modified: 00:23:57" itemprop="dateCreated datePublished" datetime="2019-09-22T00:18:40+08:00">2019-09-22</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/ZooKeeper/" itemprop="url" rel="index"><span itemprop="name">ZooKeeper</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ZooKeeper：分布式过程协同技术详解-–-读书笔记"><a href="#ZooKeeper：分布式过程协同技术详解-–-读书笔记" class="headerlink" title="ZooKeeper：分布式过程协同技术详解 – 读书笔记"></a>ZooKeeper：分布式过程协同技术详解 – 读书笔记</h1><blockquote>
<p>要点：第九章 Zab 协议、ZK 对写事务日志的优化。</p>
</blockquote>
<h2 id="Installation-amp-configuration"><a href="#Installation-amp-configuration" class="headerlink" title="Installation &amp; configuration"></a>Installation &amp; configuration</h2><p>Todo: <code>/tmp/zookeeper</code> –&gt; <code>/var/lib/zookeeper</code></p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><h4 id="chapter-2"><a href="#chapter-2" class="headerlink" title="chapter 2"></a>chapter 2</h4><p>types of <code>znode</code>:</p>
<ul>
<li>persistent, ephemeral, persistent_sequential, ephemeral_sequential；</li>
<li>持久节点、临时节点、持久有序节点、临时有序节点；</li>
<li>被创建为有序的节点被分配一个递增的整数，总而，形成了一个全局唯一的名字；</li>
<li>节点除了拥有名字（父节点名字 + 自身名字），还可以像文件夹一样，存有数据；</li>
</ul>
<p>通知</p>
<p>Zookeeper 中可以在节点上注册事件，而不需要轮询。事件可以包括 znode 数据的变化、子节点的变化、znode 的创建删除。</p>
<p>会话 session</p>
<p>客户端通过 TCP 与服务端通信。当此前会话无法继续（掉线，超过延迟时限），客户端的会话会被透明地转移到下一个服务器。</p>
<p>Zookeeper 保证，在同一个会话中的请求是以 FIFO 的顺序执行。但是如果客户端拥有多个并发的会话，则不保证。</p>
<p>会话状态</p>
<p>NOT_CONNECTED –&gt; CONNECTING &lt;==&gt; CONNECTED –&gt; CLOSED</p>
<p>客户端不能声明自己的会话到期（timedout），但是可以显示关闭会话。</p>
<p>进阶：事务标识符 zkid 在客户端连接中的使用。</p>
<h5 id="端口"><a href="#端口" class="headerlink" title="端口"></a>端口</h5><p>Zookeeper 可以配置三种 TCP 端口。前两种是关于服务端的，第三种在 <code>zoo.cfg</code> 中称为  <code>clientPort</code>。一个仲裁模式（quorum）的配置示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tickTime=2000</span><br><span class="line">initLimit=10</span><br><span class="line">syncLimit=5</span><br><span class="line">dataDir=./data</span><br><span class="line">clientPort=2181</span><br><span class="line"></span><br><span class="line">server.1=127.0.0.1:2222:2223</span><br><span class="line">server.2=127.0.0.1:3333:3334</span><br><span class="line">server.3=127.0.0.1:4444:4445</span><br></pre></td></tr></table></figure>
<p>在对服务器的配置 <code>server.1=127.0.0.1:2222:2223</code> 中，第一个端口 <code>2222</code> 是<em>仲裁通信</em>，follower 通过这个端口来接受 leader 传达的更新指令；第二个端口用于 leader 选举。</p>
<h4 id="connectString"><a href="#connectString" class="headerlink" title="connectString"></a>connectString</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zookeeper/bin/zkCli.sh -server 127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183</span><br></pre></td></tr></table></figure>
<p>上面的 <code>127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183</code> 就是所谓连接字符串（connectString）。不仅在命令行的 <code>zkCli</code> 中使用，API 库也是同样的道理。连接字符串列出了本客户端可以连接的所有服务器。其中的端口，就是在各个 Zookeeper 服务器的 <code>zoo.cfg</code> 配置文件中的 <code>clientPort</code>。</p>
<h4 id="chap-3-使用-Zookeeper-API-库"><a href="#chap-3-使用-Zookeeper-API-库" class="headerlink" title="chap 3 使用 Zookeeper API 库"></a>chap 3 使用 Zookeeper API 库</h4><p>创建 Zookeeper 句柄（handle）；实现 Watcher、认识 Zookeeper 自动管理与服务端的断连；同步地创建节点 <code>zk.create(...)</code>；同步地获取 znode 中的数据 <code>byte[] getData(...)</code>、处理 <code>ConnectionLossException</code> ；异步创建节点、实践：异步创建元数据 path；<code>StatCallback</code>；</p>
<p>关于回调的注意：回调函数中的 <code>Object ctx</code> 在需要在回调中再次调用自身的场景中被使用到，如处理返回码为 <code>ConnectionLossException</code> 时，再次调用自身这个回调函数。</p>
<p>chap 4 Dealing with State Change</p>
<p>当一个监视点（watch）被一个事件（event）触发，就会产生一个通知（notification）。</p>
<p>在某些 ZooKeeper 的封装库（wrapper ）中，对 ConnectionLoss 的处理就是自动重新发送相应指令。某些情况这会带来大问题，比如通过 <code>create</code> 创建 <code>/master</code> 节点来获取领导权。如果客户端在 <code>create</code> 成功之后丢失连接，此时 wrapper 库自动重发指令，就会收到创建失败的响应，因为节点之前已经被创建好了。但是如果不知道这一细节，应用就会认为是其它节点已经创建了 master 节点获得了领导权。</p>
<h4 id="chap-9-原理"><a href="#chap-9-原理" class="headerlink" title="chap 9 原理"></a>chap 9 原理</h4><p>ZK 要求，新的 Quorum 数量的服务器中，必须有一台以上的机器是属于上一个群首的 Quorum。</p>
<p>ZK 服务器的分类方式：分为 Leader 和 Follower，或者分为 Participant 和 Observer。Observer 和 Follower 可以统称为 Learner，因为它们“学习”群首的指示。</p>
<p>对于 Follower 有两类广播：</p>
<ul>
<li><code>proposal</code>：包含有 transaction 的内容。</li>
<li><code>commit</code>：只包含 zxid。</li>
</ul>
<p>对于 Observer 只有一类：</p>
<ul>
<li><code>INFORM</code>：已被 commit 了的 proposal 的内容。</li>
</ul>
<h5 id="ZAB-协议"><a href="#ZAB-协议" class="headerlink" title="ZAB 协议"></a>ZAB 协议</h5><ul>
<li>两阶段提交：对于一个写请求操作，群首广播出一个 Proposal。对于这个 Proposal，追随者收到之后返回 ACK 消息，通知群首其已接收此 Proposal。在收到达到仲裁数量（群首自己也算在内）的服务器发送的 ACK 之后，群首发出 <code>commit</code> 的广播。</li>
<li>Zab 提供的顺序保障：<ul>
<li>如果群首按顺序广播了事务 <code>T1</code> 和 <code>T2</code>，那么每个服务器在 commit <code>T2</code> 之前保证 <code>T1</code> 已经被提交；</li>
<li>如果某个服务器按照 <code>T1</code> 、<code>T2</code> 的顺序提交事务，那么其它服务器也保证是按这个顺序提交的。</li>
</ul>
</li>
<li>epoch 时间戳：每次群首选举中递增 <code>1</code></li>
<li>Zab 提供的脑裂保障：<ul>
<li>新群首必须要确保所有之前的时间戳内需要提交的事务被全部提交完，然后才开始新的广播；</li>
<li>在任何时间点，都不会同时出现两个被仲裁数量支持的群首。</li>
</ul>
</li>
</ul>
<p>由于在选举群首时，选举上的是 <code>zxid</code> 最大的服务器，我们就不需要将最新状态从跟随服务器更新到群首服务器，因为群首就是代表最新状态；我们所需要的，就是直接发送更新到追随者。</p>
<h5 id="ZK-有效写入事务日志"><a href="#ZK-有效写入事务日志" class="headerlink" title="ZK 有效写入事务日志"></a>ZK 有效写入事务日志</h5><p>ZK 如何有效写入事务日志：写事务日志是写请求操作的关键，ZK 用了两种方式来优化：1）组团提交 2）预先填充（padding）。</p>
<p>实际上，对于组团提交，就是在需要 flush 到磁盘（来保证事务已被持久化）时，把所有队列中的事务都<em>顺带</em> flush 到磁盘。注意，ZK 服务器只有在事务已经写入日志之后才会确认对应的 Proposal，也就是在确认事务之前，该事务已经被持久化到磁盘了。为了保证在 <code>commit</code> 方法返回后写入的数据已经存在于磁盘（而不是操作系统的写缓冲区），磁盘写缓存必须被关闭。</p>
<p><strong>预先填充（padding）</strong>是指预先为日志文件分配多余的磁盘块。在 Linux 系统中，一个文件中的数据储存在一个个分配给它的块（block）中。当向文件中写入时，如果当前分配的磁盘块用尽了，就要花时间请求分配新的磁盘块。这种请求需要修改该文件所对应的元数据，因此预先分配就会减少这一次磁盘寻道。</p>
<h5 id="会话"><a href="#会话" class="headerlink" title="会话"></a>会话</h5><p>Standalone 模式下的单独服务器与仲裁模式（Quorum）下的群首服务器负责跟踪<em>所有会话</em>。追随者只是将客户端的会话信息转发给群首。</p>
<h5 id="监视点"><a href="#监视点" class="headerlink" title="监视点"></a>监视点</h5><p>服务端不会持久化监视点，因此监视点的数据在<em>客户端</em>保存。在掉线重连之后，客户端将监视点的信息同步到服务端</p>
<h3 id="机翻问题。。"><a href="#机翻问题。。" class="headerlink" title="机翻问题。。"></a>机翻问题。。</h3><p>机翻</p>
<p>P58：</p>
<p>异步方法调用会简单化队列对 Zookeeper 服务器的请求，并在另一个线程中传输请求。</p>
<p>当接收到响应信息，这些请求就会在一个专用回调线程中被处理。</p>
<p>为了保持顺序，只会有一个单独的线程按照接收顺序处理响应包</p>
<p>原文：</p>
<p>The asynchronous method simply queues the request to the ZooKeeper server. Transmission happens on another thread. When responses are received, they are processed on a dedicated callback thread. To preserve order, there is a single callback thread and responses are processed in the order they are received.</p>
<p>我认为好的翻译：</p>
<p>这个异步方法只是简单地把请求加入 ZooKeeper 服务器的请求队列中。传输请求的任务由另一个线程完成。</p>
<p>收到响应之后，<strong>响应</strong>由一个专门的回调线程处理。</p>
<p>为了保证顺序，只会有一个单独的回调线程，按照接收到的顺序处理响应。</p>
<p>Returns the result of the call：返回调用的结构。</p>
<h3 id="关于-InterruptedException"><a href="#关于-InterruptedException" class="headerlink" title="关于 InterruptedException"></a>关于 <code>InterruptedException</code></h3><p>使用 ZK 的 API 库时会遇到不少的方法，抛出 <code>InterruptedException</code>。作者在书中也表示很无奈，没有一劳永逸的解决办法，还是要取决于具体状况，来决定是让这个异常沿着调用栈上浮，还是其它办法：</p>
<blockquote>
<p>In our example, we simply pass the InterruptedException to the caller and thus let it bubble up. Unfortunately, in Java there aren’t clear guidelines for how to deal with thread interruption, or even what it means. Sometimes the interruptions are used to signal threads that things are being shut down and they need to clean up. In other cases, an interruption is used to get control of a thread, but execution of the application continues.<br>Our handling of InterruptedException depends on our context. If the InterruptedException will bubble up and eventually close our zk handle, we can let it go up the stack and everything will get cleaned up when the handle is closed. If the zk handle is not closed, we need to figure out if we are the master before rethrowing the exception or asynchronously continuing the operation. This latter case is particularly tricky and requires careful design to handle properly.</p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/03/Netty 线程模型（二）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Rust">
      <meta itemprop="description" content="programming and free market">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/03/Netty 线程模型（二）/" itemprop="url">
                  Netty（二）线程模型与 Bytebuf
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-09-03 23:26:08 / Modified: 23:44:34" itemprop="dateCreated datePublished" datetime="2019-09-03T23:26:08+08:00">2019-09-03</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Netty/" itemprop="url" rel="index"><span itemprop="name">Netty</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Netty（二）线程模型与-Bytebuf"><a href="#Netty（二）线程模型与-Bytebuf" class="headerlink" title="Netty（二）线程模型与 Bytebuf"></a>Netty（二）线程模型与 Bytebuf</h1><h2 id="ServerBootStrap-中的-EventLoopGroup"><a href="#ServerBootStrap-中的-EventLoopGroup" class="headerlink" title="ServerBootStrap 中的 EventLoopGroup"></a>ServerBootStrap 中的 EventLoopGroup</h2><p>ServerBootStrap 实际上内部是两个 group，解释：</p>
<blockquote>
<p>Most of the times using the same group for accepting and handling the accepted connections is working out quite well and so allows you to save some threads. The only time when you may not want to do this is if the handling logic of the accepted connections will keep the EventLoops so busy that you are not able to accept fast enough. </p>
<p>– <a href="https://stackoverflow.com/a/28342821/8144090" target="_blank" rel="noopener">Norman SO answer</a></p>
</blockquote>
<p>Vert.x 是一个基于 Netty 的框架，但是其初始化是将一个线程组（EventLoopGroup）同时用于 boss 与 worker。Norman回答到，这种方法大多数时候都挺不错，并且节省了一些线程。我认为这里说的节省了的线程是 boss 线程，在没有新的连接进来的时候可以参与到 handler 的任务中。然而，当 handler 要处理的任务消耗太多 CPU 时间时，EventLoopGroup 中的所有 EventLoop，也就是线程，会全都忙于处理任务，不能很快地、甚至无法 accept 新进来的连接。</p>
<p>对于 boss EventLoopGroup，什么情况下使用超过一个线程？</p>
<p>在构造函数中可以选择线程数：<code>NioEventLoopGroup(threadsAmount)</code>。但是，既然 boss group 的职责只是接受 accept 新连接并且分发，按照 Proactor 的模型，一个线程足矣。当一个 EventLoopGroup 被多个 ServerBoostrap 分享，则按需增加线程。</p>
<h3 id="EventLoopGroup-默认线程数"><a href="#EventLoopGroup-默认线程数" class="headerlink" title="EventLoopGroup 默认线程数"></a>EventLoopGroup 默认线程数</h3><p>如果在 EventLoopGroup 初始化时没有指定线程数，则由以下的静态初始块设置默认线程数。代码出自<a href="https://github.com/netty/netty/blob/9621a5b98120f9596b5d2a337330339dda199bde/transport/src/main/java/io/netty/channel/MultithreadEventLoopGroup.java#L40" target="_blank" rel="noopener">MultithreadEventLoopGroup.java</a> 第 40 行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">	DEFAULT_EVENT_LOOP_THREADS = Math.max(<span class="number">1</span>, SystemPropertyUtil.getInt(</span><br><span class="line">    	<span class="string">"io.netty.eventLoopThreads"</span>, NettyRuntime.availableProcessors() * <span class="number">2</span>));</span><br><span class="line"><span class="comment">// 在本人的双核机器上，有四个逻辑处理器，乘以二之后 DEFAULT_EVENT_LOOP_THREADS 为 8</span></span><br></pre></td></tr></table></figure>
<h2 id="ChannelHandler-与-EventLoopGroup-中的线程"><a href="#ChannelHandler-与-EventLoopGroup-中的线程" class="headerlink" title="ChannelHandler 与 EventLoopGroup 中的线程"></a>ChannelHandler 与 EventLoopGroup 中的线程</h2><p>用自己语言更具体解释一下“Netty 4中的Handler处理在IO线程中，如果Handler处理中有耗时的操作（如数据库相关），会让IO线程等待，影响性能。”</p>
<blockquote>
<p>我们之前已经阐明了不要阻塞当前 I/O 线程的重要性。我们再以另一种方式重申一次：“永远不要将一个长时间运行的任务放入到执行队列中，因为它将阻塞需要在同一线程执行的任何其他任务。” 如果必须要进行阻塞调用或者执行长时间运行的任务，我们建议使用一个专门的 EventExecutor。（见 6.2.1 节的“ChannelHandler 的执行和阻塞”）。</p>
<p>– 摘自 Netty in Action P96</p>
</blockquote>
<p><img src="/content/images/2019/EventLoop 执行逻辑.png" alt="EventLoop 执行逻辑"></p>
<p>总结一下，EventLoop 中的线程又被称为 I/O 线程，一个 Channel 中的所有事件（出站/入站）都只会被其所绑定的这个 I/O 线程处理。一个 Channel 永远一个 EventLoop I/O 线程绑定，而一个 I/O 线程则可能被分配给多个 Channel。如果这个 I/O 线程陷入执行一个 CPU 时间耗时长的任务，所有与之关联的 Channel 中的任务都会被搁置。</p>
<p>源码如下，来自 <a href="https://github.com/netty/netty/blob/00a9a25f29cf07728794089affdd735af29209de/transport/src/main/java/io/netty/channel/AbstractChannelHandlerContext.java#L787" target="_blank" rel="noopener">AbstractChannelHandlerContext.java</a>#write()。在执行写任务时，先判断了执行线程是否是该 Channel 绑定的线程，如果是则交由执行，如果不是则新增一个 <code>WriteTask</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">EventExecutor executor = next.executor();</span><br><span class="line"><span class="keyword">if</span> (executor.inEventLoop()) &#123;</span><br><span class="line">	<span class="keyword">if</span> (flush) &#123;</span><br><span class="line">		next.invokeWriteAndFlush(m, promise);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		next.invokeWrite(m, promise);</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="keyword">final</span> AbstractWriteTask task;</span><br><span class="line">	<span class="keyword">if</span> (flush) &#123;</span><br><span class="line">		task = WriteAndFlushTask.newInstance(next, m, promise);</span><br><span class="line">	&#125;  <span class="keyword">else</span> &#123;</span><br><span class="line">		task = WriteTask.newInstance(next, m, promise);</span><br><span class="line">		...</span><br><span class="line">		...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Netty-3-中的不和谐"><a href="#Netty-3-中的不和谐" class="headerlink" title="Netty 3 中的不和谐"></a>Netty 3 中的不和谐</h3><p>这里需要注意一下，某个给定的 EventLoop 中的所有<em>事件</em>，都是由同一个线程处理。这是 Netty 4 对 Netty 3 的改进。在 Netty 3 中，出站事件可以由 I/O 线程执行，也可以由调用线程执行，这就使得 Race Condition 成为可能，比如一个 Channel 上的 <code>Channel.write()</code> 被同时调用时。</p>
<p>官方 Wiki 上有一个 <a href="https://github.com/netty/netty/wiki/Thread-model" target="_blank" rel="noopener">Thread model 的页面</a>是针对 Netty 3 的过期信息，可以看看当时开发者对这个问题的考量。</p>
<h2 id="Bytebuf-源码"><a href="#Bytebuf-源码" class="headerlink" title="Bytebuf 源码"></a>Bytebuf 源码</h2><p><code>UnpooledHeapByteBuf</code> 基于 JVM 堆内存进行内存分配，每次使用，都从头创建一个新的 实例。性能：相比堆外内存的分配和释放，成本仍然更低一些。</p>
<p><code>UnpooledHeapByteBuf</code> 拥有三个成员变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ByteBufAllocator alloc;  <span class="comment">// 用于分配内存</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">byte</span>[] array;  <span class="comment">// 以数组作为缓冲区</span></span><br><span class="line"><span class="keyword">private</span> ByteBuffer tmpNioBuf;  <span class="comment">// ByteBuf 与 ByteBuffer 转换时使用</span></span><br></pre></td></tr></table></figure>
<p>注意这里为了<strong>提升性能与位操作</strong>，Netty 并没有直接使用原生的 ByteBuffer，而是使用数组作为缓存。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/29/Netty 基础组件与线程模型--概述/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Rust">
      <meta itemprop="description" content="programming and free market">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/29/Netty 基础组件与线程模型--概述/" itemprop="url">
                  Netty 基础组件与线程模型--概述
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-08-29 00:05:16" itemprop="dateCreated datePublished" datetime="2019-08-29T00:05:16+08:00">2019-08-29</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-09-03 23:44:05" itemprop="dateModified" datetime="2019-09-03T23:44:05+08:00">2019-09-03</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Netty/" itemprop="url" rel="index"><span itemprop="name">Netty</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Netty-基础组件与线程模型–概述"><a href="#Netty-基础组件与线程模型–概述" class="headerlink" title="Netty 基础组件与线程模型–概述"></a>Netty 基础组件与线程模型–概述</h1><p>即使仅仅谈论这两个话题：Netty 组件和 Netty 线程模型，也不是一两篇文章可以 cover 的。这里做一个小尝试，也对这几天看的 <em>Netty in Action</em> 总结一下。</p>
<h2 id="Netty-想要解决什么问题"><a href="#Netty-想要解决什么问题" class="headerlink" title="Netty 想要解决什么问题"></a>Netty 想要解决什么问题</h2><p>一项新技术/开源项目，问问自己，这个技术想要解决的是什么问题，是如何解决的。</p>
<p>以我目前的水平回答，是为了弥补 Java 标准库在 I/O 上的不足。这种不足我现在看来有两部分：性能与易用性。</p>
<p>性能方面，作为标准库，API 稳定、统一的需求更重要，从而无法在提升性能上下狠功夫。Netty 则在各种角落实行了优化。最明显的是对垃圾回收与内存分配的修改，使得 ByteBuf 一定程度由使用者手动管理；以及针对不同平台提供与底层实现紧密相关的优化，比如针对 Linux 的 EpollEventLoopGroup，从而能提供边缘触发，而非 Java NIO 默认的水平触发。另外，据 Norman Maurer <a href="https://stackoverflow.com/a/36058105/8144090" target="_blank" rel="noopener">自己所说</a>，还有更低的 GC。其它细节包括使用 OpenSSL 替换 Java 标准库，等等。</p>
<p>另一方面，NIO 在使用上不够直观。仅仅 <code>flip</code> 这个方法的设计就很迷惑——像 Netty 一样为读和写单独设置两个指针多方便。</p>
<h2 id="Netty-自测问题"><a href="#Netty-自测问题" class="headerlink" title="Netty 自测问题"></a>Netty 自测问题</h2><p>看完 Netty in Action 之后我反问自己都了解到了些什么，想到了如下的问题：</p>
<p><code>EventLoop</code>  与 <code>EventLoopGroup</code> 的区别，之间的关系是什么？EventLoopGroup 拥有几个线程？EventLoop 呢？</p>
<p>EventLoop 与 Channel 是什么关系？</p>
<p>ChannelHandler 与 ChannelPipeline 是什么关系？</p>
<p>ChannelHandlerAdapter 对 ChannelHandler 区别是什么，有何改进？</p>
<p>Channel、ChannelHandler 生命周期？</p>
<p>我发现很多问题自己居然都给不出回答，然后立刻回去看书的三、六、七章，有一种开窍的感觉。之前看第一遍时无感，并且不知道重点的内容，这一次都变成了问题的答案，看的过程也津津有味起来。</p>
<h2 id="简单梳理"><a href="#简单梳理" class="headerlink" title="简单梳理"></a>简单梳理</h2><p>简单梳理一下基础的概念，下图来自《Netty in Action》，侵删：</p>
<p><img src="/content/images/2019/Channel EventLoop and EventLoopGroup.png" alt="Channel EventLoop and EventLoopGroup"></p>
<ul>
<li>Channel 就是一种“传输（transport）”，一个 Socket 就属于 Channel，所以最简单可以理解为，Channel 就是一个 Socket；</li>
<li>一个 Channel 在它的生命周期内只注册于一个 EventLoop；</li>
<li>一个 EventLoop 在它的生命周期中只与一个 Thread 绑定。实际上，最常用的实现 NioEventLoop 扩展自 SingleThreadEventLoop；</li>
<li>一个 EventLoop 可能会被分配给一个或多个 Channel（这样一来，不必每个 Socket 连接就分配一个线程，用有限的线程支撑更多的连接）；</li>
</ul>
<p>这种设计消除了同步（synchronization）的需求，因为一个 Channel 的所有 I/O 操作都是由同一个线程（异步地）完成的。</p>
<ul>
<li>ChannelPipeline 提供了 ChannelHandler 链的容器</li>
</ul>
<h2 id="线程模型"><a href="#线程模型" class="headerlink" title="线程模型"></a>线程模型</h2><h3 id="Reactor-pattern-amp-Proactor-pattern"><a href="#Reactor-pattern-amp-Proactor-pattern" class="headerlink" title="Reactor pattern &amp; Proactor pattern"></a>Reactor pattern &amp; Proactor pattern</h3><p>在学习阅读 Netty 的时候，我意识到书的作者以及文档作者都假定了，读者对于所谓的 Proactor 模式、Reactor 模式有所了解。所以我认为有必要先简要了解一下这两种模式。</p>
<p><a href="https://en.wikipedia.org/wiki/Reactor_pattern" target="_blank" rel="noopener">Reactor pattern</a> 有<strong>一个</strong>主线程，从多个 input 读取服务请求，然后把这些请求<strong>同步地</strong>分发给对应的服务处理线程。通常主线程使用同步的 <code>select</code> 来监听多个文件描述符，当一个阻塞操作，比如 <code>read()</code> 准备完毕，<code>select</code> 获得通知，就将其转发给服务处理线程。</p>
<p>关于 <a href="https://en.wikipedia.org/wiki/Proactor_pattern" target="_blank" rel="noopener">Proactor pattern</a>：</p>
<blockquote>
<p>The proactor pattern can be considered to be an <a href="https://en.wiktionary.org/wiki/asynchronous" target="_blank" rel="noopener">asynchronous</a> variant of the <a href="https://en.wikipedia.org/wiki/Synchronization_(computer_science" target="_blank" rel="noopener">synchronous</a>) <a href="https://en.wikipedia.org/wiki/Reactor_pattern" target="_blank" rel="noopener">reactor pattern</a>.</p>
<p>– Wikipedia</p>
</blockquote>
<p>Proactor 模式可以视作 Reactor 模式的异步形式。耗时长的任务异步地完成，在结束时发送通知。</p>
<h3 id="Netty-的-Boss-Worker-EventLoopGroup"><a href="#Netty-的-Boss-Worker-EventLoopGroup" class="headerlink" title="Netty 的 Boss-Worker EventLoopGroup"></a>Netty 的 Boss-Worker EventLoopGroup</h3><p>了解了有这种主-从线程池的区分之后，就能理解，为什么很多 Netty 示例程序中 Server 的 <code>ServerBootStrap#group(EventLoopGroup, EventLoopGroup)</code> 会有绑定两个 EventLoopGroup。即使某些简单的 demo 实现中只绑定了一个，如： <code>group(EventLoopGroup)</code>，这一方法其实只是绑定主从 EventLoopGroup 的重载方法，源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ServerBootstrap <span class="title">group</span><span class="params">(EventLoopGroup group)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> group(group, group);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>官方 <a href="https://netty.io/wiki/user-guide-for-4.x.html" target="_blank" rel="noopener">User Guide</a> 的解释如下：</p>
<blockquote>
<p>The first one, often called ‘boss’, accepts an incoming connection. The second one, often called ‘worker’, handles the traffic of the accepted connection once the boss accepts the connection and registers the accepted connection to the worker. </p>
</blockquote>
<p>第一个是被称为 boss 的 EventLoopGroup，负责接受连接，第二个则被称为 worker，负责处理由 boss 分配给它的已接受的连接。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/03/java.io 梳理与其中的三种设计模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Rust">
      <meta itemprop="description" content="programming and free market">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/03/java.io 梳理与其中的三种设计模式/" itemprop="url">
                  java.io 梳理与其中的三种设计模式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-08-03 00:00:09 / Modified: 00:29:51" itemprop="dateCreated datePublished" datetime="2019-08-03T00:00:09+08:00">2019-08-03</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Design-Patterns/" itemprop="url" rel="index"><span itemprop="name">Design Patterns</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="java-io-梳理与其中的三种设计模式"><a href="#java-io-梳理与其中的三种设计模式" class="headerlink" title="java.io 梳理与其中的三种设计模式"></a>java.io 梳理与其中的三种设计模式</h1><p>以 <code>Reader</code> 抽象类下的类为例。它们的主要构造函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FilterReader(Reader)</span><br><span class="line">BufferedReader(Reader)</span><br><span class="line"></span><br><span class="line">FileReader(File)</span><br><span class="line">StringReader(String)</span><br><span class="line">InputStreamReader(InputStream [, Charset])</span><br></pre></td></tr></table></figure>
<p><img src="/content/images/2019/ReaderUML.png" alt="Reader UML"></p>
<p>大致上，<code>java.io</code> 可以分为：</p>
<ol>
<li>字节流操作：<code>InputStream</code>、<code>OutputStream</code></li>
<li>字符操作：<code>Reader</code>、<code>Writer</code></li>
<li>针对磁盘操作：<code>File</code></li>
</ol>
<h2 id="适配器模式-Adapter-pattern"><a href="#适配器模式-Adapter-pattern" class="headerlink" title="适配器模式 Adapter pattern"></a>适配器模式 Adapter pattern</h2><p><code>InputStreamReader</code> 是字节流与字符流之间的桥梁，它的实现使用了适配器模式。适配器模式通过聚合将某个接口适配成为另一个接口来方便使用，类图如下：</p>
<p><img src="/content/images/2019/InputStreamReaderAdapterPattern.png" alt="InputStreamReader Adapter Pattern"></p>
<p>在开头的代码可以看到，<code>InputStreamReader</code> 的构造器需要传入一个字节流 <code>InputSream</code>，以及可选的字符集。如果没有传入字符集就会使用默认的。通过持有一个 <code>InputStream</code>，<code>InputStreamReader</code> 拥有了该接口的功能。同时，<code>InputStreamReader</code> 还是一个实现了 <code>Reader</code> 类，这样一来它就把 <code>InputStream</code> 适配成了一个 <code>Reader</code> 类。</p>
<h2 id="装饰器模式-Decorator-pattern"><a href="#装饰器模式-Decorator-pattern" class="headerlink" title="装饰器模式 Decorator pattern"></a>装饰器模式 Decorator pattern</h2><p>这个应该是 <code>java.io</code> 更为人熟知的，装饰器模式与适配器模式都可以看作包装模式 Wrapper。通过对类的层层包裹，装饰器模式增强了目标类的功能。类图示意如下：</p>
<p><img src="/content/images/2019/IODecoratorPattern.png" alt="IO Decorator Pattern"></p>
<p><code>Decorator</code> 是 <code>Component</code> 的实现类，但是其内部也持有一个 <code>Decorator</code> 类。不同的 <code>Decorator</code> 类下的 <code>ConcreteDecorator</code> 子类包含了需要增强的功能。</p>
<p>在 <code>java.io</code> 中的典型使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FilterReader pbr = <span class="keyword">new</span> PushbackReader(</span><br><span class="line">        <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(System.in)))</span><br></pre></td></tr></table></figure>
<h3 id="二者的不同"><a href="#二者的不同" class="headerlink" title="二者的不同"></a>二者的不同</h3><p>装饰器模式更多的是对目标类的功能上的增强；适配器没有对功能进行增进，只是为了使目标类能适应调用方的接口，方便被调用。</p>
<h2 id="模板方法"><a href="#模板方法" class="headerlink" title="模板方法"></a>模板方法</h2><p>在模板方法模式中，大的算法框架在抽象父类中被定义好，某些业务相关的实现则延迟到子类。</p>
<p>在 <code>Reader</code> 抽象类中，<code>read</code> 方法的默认实现都留给了被重载的 <code>read(char[], int, int)</code>，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">read</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>[] cbuf)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>[] cbuf, <span class="keyword">int</span> offset, <span class="keyword">int</span> len)</span></span></span><br></pre></td></tr></table></figure>
<p>具体的 <code>read</code> 的实现留给子类。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/25/tiny-spring 踩坑记录（一）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Rust">
      <meta itemprop="description" content="programming and free market">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/25/tiny-spring 踩坑记录（一）/" itemprop="url">
                  tiny-spring 踩坑记录（一）可变长泛型参数与堆污染
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-07-25 09:23:11 / Modified: 09:29:12" itemprop="dateCreated datePublished" datetime="2019-07-25T09:23:11+08:00">2019-07-25</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="可变长泛型参数与堆污染"><a href="#可变长泛型参数与堆污染" class="headerlink" title="可变长泛型参数与堆污染"></a>可变长泛型参数与堆污染</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><blockquote>
<p>什么是堆污染</p>
</blockquote>
<p>一个类型为泛型 <code>T</code> 的变量被指向一个类型不是 <code>T</code> 的对象，这就是堆污染。典型的情况是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;T&gt; listOfTs = <span class="keyword">new</span> ArrayList&lt;&gt;(Arrays.asList(t));</span><br><span class="line">List&lt;E&gt; listOfEs = (List&lt;E&gt;)(Object)listOfTs; <span class="comment">// 此时指向了含有 T 的 List, 但是不会抛出异常，只是在 Object -&gt; List&lt;E&gt; 的转型中抛出警告</span></span><br><span class="line"></span><br><span class="line">E e = listOfEs.get(<span class="number">0</span>);  <span class="comment">// 运行时错误，java.lang.ClassCastException</span></span><br></pre></td></tr></table></figure>
<p>之所以编译器无法在转型时检查出类型转换错误，是因为 Java 泛型是通过类型擦除实现的，在泛型代码内部无法获得任何有关泛型参数类型的信息。</p>
<p>一个更好一点的关于可变长泛型参数和堆污染一起的例子，来自 <a href="https://docs.oracle.com/javase/tutorial/java/generics/nonReifiableVarargsType.html" target="_blank" rel="noopener">Oracle 官方文档</a>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">faultyMethod</span><span class="params">(List&lt;String&gt;... l)</span> </span>&#123;</span><br><span class="line">    Object[] objectArray = l;     <span class="comment">// Valid</span></span><br><span class="line">    objectArray[<span class="number">0</span>] = Arrays.asList(<span class="number">42</span>);</span><br><span class="line">    String s = l[<span class="number">0</span>].get(<span class="number">0</span>);       <span class="comment">// ClassCastException thrown here</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于泛型的<a href="https://docs.oracle.com/javase/tutorial/java/generics/restrictions.html" target="_blank" rel="noopener">几大限制</a>中，最明显的一个就是不能创造泛型数组，如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt;[] arrayOfLists = <span class="keyword">new</span> List&lt;Integer&gt;[<span class="number">2</span>];  <span class="comment">// compile-time error</span></span><br></pre></td></tr></table></figure>
<p>但是这一限制在可变长的泛型参数中被打破了。在可变长参数中，一个数组会在函数调用时建立（Effective Java，Item 53），每次调用都会引起一次数组分配和初始化。当可变长参数是泛型时，一个泛型数组就被创造出来了。</p>
<h3 id="实操时的问题"><a href="#实操时的问题" class="headerlink" title="实操时的问题"></a>实操时的问题</h3><p>我在 tiny-spring 中写了一个方法，给定注解参数，获取所有带有该注解的类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getClassSetByAnnotation(Class&lt;? extends Annotation&gt;... cls) &#123;</span><br><span class="line">    Set&lt;Class&lt;?&gt;&gt; classSet = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; c : getClassSet(basePkg)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;? extends Annotation&gt; annotationCls : cls) &#123;</span><br><span class="line">            <span class="keyword">if</span> (c.isAnnotationPresent(annotationCls)) &#123;</span><br><span class="line">                classSet.add(c);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> classSet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就出现了一个可变长泛型参数的问题。另一个隐藏的问题是，这个方法并没有对传入的注解参数的数量检查参数为零的情况，而可变长参数允许传入零个参数。一个优美一点的解决方案是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SafeVarargs</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getClassSetByAnnotation(Class&lt;? extends Annotation&gt; firstCls, Class&lt;? extends Annotation&gt;... cls) &#123;</span><br><span class="line">    Set&lt;Class&lt;?&gt;&gt; classSet = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; c : getClassSet(basePkg)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (c.isAnnotationPresent(firstCls)) &#123;</span><br><span class="line">            classSet.add(c);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;? extends Annotation&gt; annotationCls : cls) &#123;</span><br><span class="line">            <span class="keyword">if</span> (c.isAnnotationPresent(annotationCls)) &#123;</span><br><span class="line">                classSet.add(c);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> classSet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样既省去明显的检查参数数量，又能在调用处强制调用者传入至少一个参数，这也是这个方法的本意。</p>
<h3 id="SafeVarargs-的使用标准"><a href="#SafeVarargs-的使用标准" class="headerlink" title="@SafeVarargs 的使用标准"></a>@SafeVarargs 的使用标准</h3><p>如上所见，可以将报警用 <code>@SafeVarargs</code> 注解掉。但是我们知道，这个注解仅仅是消除编译警告，完全不能保证消除这个错误。那么什么时候应该使用这个注解呢？</p>
<p>在 StackOverflow 有一个票的<a href="https://stackoverflow.com/a/14252221" target="_blank" rel="noopener">回答</a>：</p>
<p>If your method has an argument of type <code>T...</code> (where T is any type parameter), then:</p>
<ul>
<li>Safe: If your method only depends on the fact that the elements of the array are instances of <code>T</code></li>
<li>Unsafe: If it depends on the fact that the array is an instance of <code>T[]</code></li>
</ul>
<p>Effective Java 也表示了类似的意思：如果你的方法使用可变长泛型参数的时候，只是用来一次传入多个参数，并且实际使用的时候只是把它们当作多个参数来看，那么就没有问题。如果你的方法体中把可变长参数当作数组来使用，那就会有问题，不要使用这个注解。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/20/并发编程bug之源：死锁成因与重排序/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Rust">
      <meta itemprop="description" content="programming and free market">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/20/并发编程bug之源：死锁成因与重排序/" itemprop="url">
                  并发编程bug之源：死锁成因与重排序
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-06-20 00:00:00 / Modified: 23:44:08" itemprop="dateCreated datePublished" datetime="2019-06-20T00:00:00+08:00">2019-06-20</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Concurrency/" itemprop="url" rel="index"><span itemprop="name">Concurrency</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Java-内存模型"><a href="#Java-内存模型" class="headerlink" title="Java 内存模型"></a>Java 内存模型</h1><p>每学习一个新概念时，一个有效的办法就是问自己，为什么需要这个技术，这个技术试图解决什么问题？怎么解决的？套用在 Java 内存模型 JMM 上，就是如下的问题：</p>
<ul>
<li>为什么需要JMM，它试图解决什么问题？</li>
<li>JMM是如何解决可见性等各种问题的？类似volatile，体现在具体用例中有什么效果？</li>
</ul>
<p>这篇文章先分析为什么需要 JMM，然后顺便分析另一大并发 bug 来源，死锁。</p>
<h3 id="从源代码到机器码会经历重排序"><a href="#从源代码到机器码会经历重排序" class="headerlink" title="从源代码到机器码会经历重排序"></a>从源代码到机器码会经历重排序</h3><p>重排序，这就是需要一个统一 JMM 模型的原因。</p>
<ol>
<li>编译器在<em>不改变程序语义</em>的前提下，重新安排语句执行顺序。（例子）</li>
<li>指令级并行 Instruction Level Parallelism（搜索关键词：ILP），改变机器指令的执行顺序。（用于方便流水线，提高并行度 parallelism）</li>
<li>内存系统重排序。现代的处理器使用写缓冲区（CPU cache）临时保存向内存写入的数据。<br><strong>为什么内存重排：</strong>写缓冲区可以保证指令流水线持续运行，它可以避免由于处理器停顿下来等待向内存写入数据而产生的延迟。同时，通过以批处理的方式刷新写缓冲区，以及合并写缓冲区中对同一内存地址的多次写，减少对内存总线的占用。<br><strong>导致的问题：</strong>当多个CPU同时（在另一个CPU写回之前）将同一个变量读入cache，任意一个CPU对该块内存的操作对于其他CPU来说都是不可见的。到写回内存时，先写入内存的就会被后写入的覆盖。</li>
</ol>
<p>编译器重排序：1，处理器重排序：2，3。</p>
<p>ILP 重排应对方式：在编译生成指令序列时，插入由CPU支持的内存屏障 Memory Barriers（搜索关键词：Intel Memory Fence）</p>
<p>重排的依据：</p>
<p><strong>数据依赖性：</strong>如果两个操作访问同一个变量，且这两个操作中有一个为写操作，此时这两个操作之间就存在数据依赖性。</p>
<p><strong>控制依赖性：</strong>看一段程序：<code>if (flag) int i *= 3;</code>。在这里，<code>if</code>这个操作A 和<code>i *= 3</code>这个操作B 存在控制依赖关系，只有操作A 完成了，才能确定是否执行操作 B。这样，并行度就被降低了。处理器通过猜测执行（Speculation），可以在执行操作A的同时计算 <code>i</code> 的值，如果操作A 为 true 就让 <code>i</code> 等于计算结果，否则不等于。</p>
<p>给（应用）程序员提供统一的内存模型还有一个原因是覆盖掉各种不同底层机器的差异，Intel，AMD，PowerPC，不同处理器有些内存一致（Cache Coherence）有些不遵循。</p>
<h1 id="死锁的成因与各种应对"><a href="#死锁的成因与各种应对" class="headerlink" title="死锁的成因与各种应对"></a>死锁的成因与各种应对</h1><p>银行两个账户之间的 Transfer 是很好的例子。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Account from, Account to, <span class="keyword">int</span> amnt)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(from) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(to) &#123;</span><br><span class="line">            from.setAmount(from.getAmount() - amnt);</span><br><span class="line">            to.setAmount(to.getAmount() + amnt);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要形成死锁 Deadlock，必备的四个条件，缺一不可：</p>
<ol>
<li>互斥。某一代码块同一时刻只能一个线程执行。一般都会存在。</li>
<li>hold and wait。抢到锁却继续等待其他资源（锁）</li>
<li>循环等待。两个线程互相等待对方</li>
<li>无法超时/剥夺的等待。</li>
</ol>
<p>对应方法：</p>
<ol>
<li>一般是基础条件，无法破除</li>
<li>用一把锁一次性获得所有资源。例子中，可以加上全局锁，确保<code>from</code> 和 <code>to</code> 可以被同时拿到。缺点：效率低下。</li>
<li>在锁之间创造先后顺序。需要获取两个锁时，优先尝试 <code>id</code> 大的那个。</li>
<li>加入超时。缺点：等待时间太久。拿到锁 <code>from</code> 后尝试获取锁 <code>to</code>，失败则立即释放锁 <code>from</code>，过一段时间（）再尝试。</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/22/程序员必知的内存知识/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Rust">
      <meta itemprop="description" content="programming and free market">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/22/程序员必知的内存知识/" itemprop="url">
                  程序员必知的内存知识
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-05-22 00:00:00 / Modified: 23:50:00" itemprop="dateCreated datePublished" datetime="2019-05-22T00:00:00+08:00">2019-05-22</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Computer-Organization/" itemprop="url" rel="index"><span itemprop="name">Computer Organization</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>原文地址：<a href="https://lwn.net/Articles/252125/" target="_blank" rel="noopener">https://lwn.net/Articles/252125/</a></p>
</blockquote>
<h1 id="What-every-programmer-should-know-about-memory"><a href="#What-every-programmer-should-know-about-memory" class="headerlink" title="What every programmer should know about memory"></a>What every programmer should know about memory</h1><h2 id="Part-2-CPU-Caches"><a href="#Part-2-CPU-Caches" class="headerlink" title="Part 2: CPU Caches"></a>Part 2: CPU Caches</h2><h2 id="程序员必知的内存知识"><a href="#程序员必知的内存知识" class="headerlink" title="程序员必知的内存知识"></a>程序员必知的内存知识</h2><h2 id="第二部分：CPU-缓存"><a href="#第二部分：CPU-缓存" class="headerlink" title="第二部分：CPU 缓存"></a>第二部分：CPU 缓存</h2><p>[Editor’s note: This is the second installment in Ulrich Drepper’s “What every programmer should know about memory” document. Those who have not read the first part will likely want to start there. This is good stuff, and we once again thank Ulrich for allowing us to publish it.]<br>[编者注：这是Ulrich Drepper的文章“程序员必知的内存知识”的第二部分。那些没有阅读过第一部分的人可能会想从那看起。这篇文章很棒，再次感谢Ulrich允许我们发布它。]</p>
<p>CPUs are today much more sophisticated than they were only 25 years ago. In those days, the frequency of the CPU core was at a level equivalent to that of the memory bus. Memory access was only a bit slower than register access. But this changed dramatically in the early 90s, when CPU designers increased the frequency of the CPU core but the frequency of the memory bus and the performance of RAM chips did not increase proportionally. This is not due to the fact that faster RAM could not be built, as explained in the previous section. It is possible but it is not economical. RAM as fast as current CPU cores is orders of magnitude more expensive than any dynamic RAM.<br>如今的CPU比25年前更加复杂。25年前，CPU内核的频率处于与内存总线相当的水平。访问内存只比访问寄存器慢一点。但是在90年代早期，当CPU设计人员提高CPU内核的频率而内存总线的频率和RAM（random-access memory，内存；随机存取存储器）芯片的性能没有按比例增加时，这种情况发生了巨大的变化。如上一节所述，这不是因为无法建造更快的RAM。造更快的RAM是可能的，但这样做不经济。与当前CPU内核一样快的RAM比任何动态RAM都要贵上几个数量级。</p>
<p>If the choice is between a machine with very little, very fast RAM and a machine with a lot of relatively fast RAM, the second will always win given a working set size which exceeds the small RAM size and the cost of accessing secondary storage media such as hard drives. The problem here is the speed of secondary storage, usually hard disks, which must be used to hold the swapped out part of the working set. Accessing those disks is orders of magnitude slower than even DRAM access.<br>如果非要在在具有非常小、非常快的RAM的机器和具有大量相对较快RAM的机器之间做一个选择，那么第二个方案总是更好的选择，如果给定的工作集大小超过小RAM的大小和访问硬盘之类的二级辅助存储介质的成本。问题在于二级存储的速度。二级储存通常是硬盘，它必须够大来保存工作集中从内存交换给它的部分。访问这些磁盘的速度比访问DRAM（动态随机存取存储器，Dynamic Random Access Memory）慢几个数量级。</p>
<p>Fortunately it does not have to be an all-or-nothing decision. A computer can have a small amount of high-speed SRAM in addition to the large amount of DRAM. One possible implementation would be to dedicate a certain area of the address space of the processor as containing the SRAM and the rest the DRAM. The task of the operating system would then be to optimally distribute data to make use of the SRAM. Basically, the SRAM serves in this situation as an extension of the register set of the processor.<br>幸运的是，我们并不需要做这种非黑即白的决定。计算机可以在拥有大量DRAM的同时带有少量的高速SRAM（静态随机存储器，Static Random Access Memory）。一种可能的实现方式是将处理器地址空间的某个区域用SRAM存储而将其余部分用DRAM。接下来，操作系统的任务就是最佳地分配数据以利用SRAM。基本上，SRAM在这种情况下被用作处理器寄存器组的扩展。</p>
<p>While this is a possible implementation, it is not viable. Ignoring the problem of mapping the physical resources of such SRAM-backed memory to the virtual address spaces of the processes (which by itself is terribly hard) this approach would require each process to administer in software the allocation of this memory region. The size of the memory region can vary from processor to processor (i.e., processors have different amounts of the expensive SRAM-backed memory). Each module which makes up part of a program will claim its share of the fast memory, which introduces additional costs through synchronization requirements. In short, the gains of having fast memory would be eaten up completely by the overhead of administering the resources.<br>虽然这是一种可能的实现方式，但它并不可行。即使先忽略将这种SRAM支持的内存的物理地址映射到进程的虚拟地址空间（这本身就非常困难）所产生的问题，这种方法要求每个进程直接在软件中管理该存储区域的分配。存储区域的大小将随处理器而变化（即，不同处理器具有不同数量的昂贵的SRAM支持的内存）。构成一个程序的每个模块都将试图占用其快速存储器的份额，这又会因为协调不同要求而引入额外的成本。简而言之，拥有快速内存的收益将完全被管理资源带来的开销所抵消。</p>
<p>So, instead of putting the SRAM under the control of the OS or user, it becomes a resource which is transparently used and administered by the processors. In this mode, SRAM is used to make temporary copies of (to cache, in other words) data in main memory which is likely to be used soon by the processor. This is possible because program code and data has temporal and spatial locality. This means that, over short periods of time, there is a good chance that the same code or data gets reused. For code this means that there are most likely loops in the code so that the same code gets executed over and over again (the perfect case for spatial locality). Data accesses are also ideally limited to small regions. Even if the memory used over short time periods is not close together there is a high chance that the same data will be reused before long (temporal locality). For code this means, for instance, that in a loop a function call is made and that function is located elsewhere in the address space. The function may be distant in memory, but calls to that function will be close in time. For data it means that the total amount of memory used at one time (the working set size) is ideally limited but the memory used, as a result of the random access nature of RAM, is not close together. Realizing that locality exists is key to the concept of CPU caches as we use them today.<br>因此，我们不应该将SRAM置于操作系统或用户的控制之下，而应该让它成为由处理器透明地使用和管理的资源。这时，SRAM用于临时复制（或者缓存）主存中那些可能即将被处理器使用的数据。这种做法是可行的，因为程序代码和数据具有时间和空间局部性。这意味着，在很短的时间内，曾经被使用过的代码和数据很有可能被再次使用。从代码的层面来说，这意味着代码中很可能存在循环，所以相同的代码一次又一次地执行（空间局部性的完美情况）。理想情况下，数据访问也仅限于很小的内存区域内。即使在短时间段内访问的内存不紧凑，也很有可能不久之后重复使用相同的数据（时间局部性）。从代码的层面来说，这时可能在循环中进行函数调用，并且该函数位于地址空间的其他位置。该函数可能在内存中相距甚远，但时间上对该函数的调用并不遥远。对于数据，这意味着每次使用的内存的总量（工作集大小）是有限的，但由于RAM 的随机访问性质，所使用的内存并不需要被紧凑地存储在一起。当我们今天使用CPU缓存时，意识到存在局部性理解是CPU缓存概念的关键。</p>
<p>A simple computation can show how effective caches can theoretically be. Assume access to main memory takes 200 cycles and access to the cache memory take 15 cycles. Then code using 100 data elements 100 times each will spend 2,000,000 cycles on memory operations if there is no cache and only 168,500 cycles if all data can be cached. That is an improvement of 91.5%.<br>一个简单的计算可以显示理论上缓存有多有效。假设访问主存储器需要200个时钟周期而访问高速缓冲存储器需要15个周期。然后，如果没有缓存，则对100个数据元素使用100次的代码将在内存操作上花费2,000,000个周期，如果所有数据都可以缓存，则仅花费168,500个周期。这可是91.5％的改善。</p>
<p>The size of the SRAM used for caches is many times smaller than the main memory. In the author’s experience with workstations with CPU caches the cache size has always been around 1/1000th of the size of the main memory (today: 4MB cache and 4GB main memory). This alone does not constitute a problem. If the size of the working set (the set of data currently worked on) is smaller than the cache size it does not matter. But computers do not have large main memories for no reason. The working set is bound to be larger than the cache. This is especially true for systems running multiple processes where the size of the working set is the sum of the sizes of all the individual processes and the kernel.<br>用于缓存的SRAM的大小比主存小许多倍。在作者使用带CPU缓存的工作站的经验中，缓存大小一直是主内存大小的1/1000（现在：4MB缓存和4GB主存）。仅这一点不构成问题。如果工作集的大小（当前处理的数据的大小）小于缓存大小则无关紧要。但计算机不是无缘无故配有大容量主存的。工作集一定会大于缓存。对于运行多个进程的系统尤其如此：其工作集的大小是所有单个进程和内核的大小的总和。</p>
<p>What is needed to deal with the limited size of the cache is a set of good strategies to determine what should be cached at any given time. Since not all data of the working set is used at exactly the same time we can use techniques to temporarily replace some data in the cache with other data. And maybe this can be done before the data is actually needed. This prefetching would remove some of the costs of accessing main memory since it happens asynchronously with respect to the execution of the program. All these techniques and more can be used to make the cache appear bigger than it actually is. We will discuss them in Section 3.3. Once all these techniques are exploited it is up to the programmer to help the processor. How this can be done will be discussed in Section 6.<br>处理缓存大小有限问题所需要的是一组好的策略，来确定在什么时间应该缓存什么。由于工作组的数据不会被同时全部访问，我们可以用技术来将缓存中的一些数据暂时替换成其它数据。这种替换可以在实际需要这些数据之前完成。预先缓存数据将消除访问主存的一些成本，因为它与程序的执行异步发生。这种技术和更多其它技术可使得缓存显得比实际容量更大。我们将在3.3节讨论这一点。在所有这些技术被使用之后，就需要靠程序员来帮助处理器了。如何做到这一点将在第6节中讨论。</p>
<p>3.1 CPU Caches in the Big Picture<br>3.1 CPU 缓存在计算机整体层面上的地位<br>Before diving into technical details of the implementation of CPU caches some readers might find it useful to first see in some more details how caches fit into the “big picture” of a modern computer system.<br>在深入研究实现CPU缓存的技术细节之前，一些读者可能会觉得，首先更多了解缓存在现代计算机系统的“大局”中的地位会有帮助。</p>
<p>Figure 3.1: Minimum Cache Configuration<br>图 3.1：最小缓存配置<br>Figure 3.1 shows the minimum cache configuration. It corresponds to the architecture which could be found in early systems which deployed CPU caches. The CPU core is no longer directly connected to the main memory. {In even earlier systems the cache was attached to the system bus just like the CPU and the main memory. This was more a hack than a real solution.} All loads and stores have to go through the cache. The connection between the CPU core and the cache is a special, fast connection. In a simplified representation, the main memory and the cache are connected to the system bus which can also be used for communication with other components of the system. We introduced the system bus as “FSB” which is the name in use today; see Section 2.2. In this section we ignore the Northbridge; it is assumed to be present to facilitate the communication of the CPU(s) with the main memory.<br>图3.1显示了最小缓存配置的情况。它所对应的架构可以在早期部署CPU缓存的系统中找到。CPU内核不再直接连接到主内存。（在更早的系统中，缓存像CPU和主存一样连接到系统总线。这更像是一种权宜之计而不是真正的解决方案。）所有加载和存储都必须通过缓存。CPU内核和缓存之间的连接是一种特殊的快速连接。简单来说，主存和高速缓存连接到系统总线，系统总线也可用于与系统的其他组件通信。我们介绍系统总线时叫它“FSB”，这是目前使用的名称; 见2.2节。在本节中，我们忽略北桥，只有在帮助 CPU与主存储器的通信时我们才假设它存在。</p>
<p>Even though computers for the last several decades have used the von Neumann architecture, experience has shown that it is of advantage to separate the caches used for code and for data. Intel has used separate code and data caches since 1993 and never looked back. The memory regions needed for code and data are pretty much independent of each other, which is why independent caches work better. In recent years another advantage emerged: the instruction decoding step for the most common processors is slow; caching decoded instructions can speed up the execution, especially when the pipeline is empty due to incorrectly predicted or impossible-to-predict branches.<br>尽管在过去几十年中计算机一直在使用冯诺伊曼（von Neumann）架构，但实践表明，把用于代码和数据的高速缓存分离是有利的。Intel（英特尔）自1993年以来一直使用分开的代码和数据缓存，从未改变过。代码和数据所需的内存区域几乎彼此独立地储存着，这就是独立缓存更有效的原因。近年来出现了另一个优点：处理器的指令解码步骤一般都很慢; 缓存解码过的指令可以加速执行，特别是当流水线由于错误预测或无法预测的分支而为空时。</p>
<p>Soon after the introduction of the cache, the system got more complicated. The speed difference between the cache and the main memory increased again, to a point that another level of cache was added, bigger and slower than the first-level cache. Only increasing the size of the first-level cache was not an option for economical reasons. Today, there are even machines with three levels of cache in regular use. A system with such a processor looks like Figure 3.2. With the increase on the number of cores in a single CPU the number of cache levels might increase in the future even more.<br>引入缓存后不久，系统变得更加复杂。缓存和主存之间的速度差异再次增大，以至于增加了另一级缓存，比第一级缓存更大，更慢。出于经济原因，仅增加第一级缓存的大小不是一种选择。今天，甚至有常规的使用三级缓存的机器。具有这种处理器的系统如图3.2所示。随着单个CPU中核心数量的增加，未来缓存级别的数量可能会增加。</p>
<p>Figure 3.2: Processor with Level 3 Cache<br>图3.2：具有3级缓存的处理器</p>
<p>Figure 3.2 shows three levels of cache and introduces the nomenclature we will use in the remainder of the document. L1d is the level 1 data cache, L1i the level 1 instruction cache, etc. Note that this is a schematic; the data flow in reality need not pass through any of the higher-level caches on the way from the core to the main memory. CPU designers have a lot of freedom designing the interfaces of the caches. For programmers these design choices are invisible.<br>图3.2显示了三级缓存，并介绍了我们将在本文档的其余部分中使用的命名法。L1d代表1级数据高速缓存，L1i代表1级指令高速缓存，以此类推。注意这是一个原理图; 实际中，数据流可以在从核心到主存的路上不通过任何更高级别的高速缓存。CPU设计人员可以自由设计高速缓存的接口。对于程序员来说，这些设计选择是不可见的。</p>
<p>In addition we have processors which have multiple cores and each core can have multiple “threads”. The difference between a core and a thread is that separate cores have separate copies of (almost {Early multi-core processors even had separate 2nd level caches and no 3rd level cache.}) all the hardware resources. The cores can run completely independently unless they are using the same resources—e.g., the connections to the outside—at the same time. Threads, on the other hand, share almost all of the processor’s resources. Intel’s implementation of threads has only separate registers for the threads and even that is limited, some registers are shared. The complete picture for a modern CPU therefore looks like Figure 3.3.<br>此外，我们的处理器具有多个内核，每个内核可以有多个“线程”。核心和线程之间的区别在于，单独的核心具有（几乎{ 早期多核处理器甚至具有单独的第二级高速缓存而没有第三级高速缓存。 }）所有硬件资源的单独副本。核心可以完全彼此独立运行，除非它们使用到了相同的资源——例如与外部的连接——并且在同一时刻用到。另一方面，线程几乎共享处理器的所有资源。英特尔的线程实现中，线程只有寄存器是各自使用的。即使这一点也是有限的，一些寄存器是共享的。因此，现代CPU的完整图片如图3.3所示。</p>
<p>Figure 3.3: Multi processor, multi-core, multi-thread<br>图3.3：多处理器，多核，多线程<br>In this figure we have two processors, each with two cores, each of which has two threads. The threads share the Level 1 caches. The cores (shaded in the darker gray) have individual Level 1 caches. All cores of the CPU share the higher-level caches. The two processors (the two big boxes shaded in the lighter gray) of course do not share any caches. All this will be important, especially when we are discussing the cache effects on multi-process and multi-thread applications.<br>在这个图中有两个处理器，每个处理器有两个内核，每个内核有两个线程。线程共享1级缓存。核心（深灰色阴影）具有单独的1级缓存。CPU的所有核心共享更高级别的缓存。两个处理器（两个浅灰色阴影的大框）不共享任何缓存。所有这些都很重要，尤其是当我们讨论多进程和多线程应用程序的缓存效果时。</p>
<p>3.2 Cache Operation at High Level<br>3.2高级别的缓存操作<br>To understand the costs and savings of using a cache we have to combine the knowledge about the machine architecture and RAM technology from Section 2 with the structure of caches described in the previous section.<br>要了解使用缓存的成本和优点，我们必须将第2节中的机器架构和RAM技术的知识与上一节中描述的缓存结构相结合</p>
<p>By default all data read or written by the CPU cores is stored in the cache. There are memory regions which cannot be cached but this is something only the OS implementers have to be concerned about; it is not visible to the application programmer. There are also instructions which allow the programmer to deliberately bypass certain caches. This will be discussed in Section 6.<br>默认情况下，CPU内核读取或写入的所有数据都存储在缓存中。有些内存区域无法缓存，但这只是操作系统实现人员必须关注的问题; 它对应用程序员来说是不可见的。还有一些指令允许程序员故意绕过某些缓存，将在第6节中讨论这些。</p>
<p>If the CPU needs a data word the caches are searched first. Obviously, the cache cannot contain the content of the entire main memory (otherwise we would need no cache), but since all memory addresses are cacheable, each cache entry is tagged using the address of the data word in the main memory. This way a request to read or write to an address can search the caches for a matching tag. The address in this context can be either the virtual or physical address, varying based on the cache implementation.<br>如果CPU需要一个字的数据，则首先搜索高速缓存。显然，缓存不能包含整个主存储器的内容（否则我们不需要缓存），但由于所有内存地址都是可缓存的，因此每个缓存条目都使用主存中数据字的地址进行标记。这样，读取或写入地址的请求可以在高速缓存中搜索匹配的标记。在这种情况下，地址可以是虚拟内存地址或物理地址，基于缓存的具体实现而变化。</p>
<p>Since the tag requires space in addition to the actual memory, it is inefficient to choose a word as the granularity of the cache. For a 32-bit word on an x86 machine the tag itself might need 32 bits or more. Furthermore, since spatial locality is one of the principles on which caches are based, it would be bad to not take this into account. Since neighboring memory is likely to be used together it should also be loaded into the cache together. Remember also what we learned in Section 2.2.1: RAM modules are much more effective if they can transport many data words in a row without a new CAS or even RAS signal. So the entries stored in the caches are not single words but, instead, “lines” of several contiguous words. In early caches these lines were 32 bytes long; now the norm is 64 bytes. If the memory bus is 64 bits wide this means 8 transfers per cache line. DDR supports this transport mode efficiently。<br>由于标签除了实际存储器之外还需要空间，因此选择字作为高速缓存的单位是低效的。对于x86机器上的32位字，标签本身大小可能需要32位或更多。此外，由于空间局部性是高速缓存的基本原则之一，也必须把这一点考虑进去。由于相邻内存区域可能被一起访问，因此它们也应该一起加载到高速缓存中。还要记住我们在第2.2.1节中学到的内容：如果RAM模块可以在不发送新CAS或甚至RAS信号的情况下连续传输多个数据字，则它们会更有效。因此，存储在高速缓存中的条目不是字，而是有着几个连续字的“行”。在早期的缓存中，这些行的长度为32个字节; 现在的规范是64字节。如果存储器总线是64位宽，则这意味着每个高速缓存行需要8次传输。DDR能有效地支持这种传输模式。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/05/二叉堆与堆排序要点/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Rust">
      <meta itemprop="description" content="programming and free market">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/05/二叉堆与堆排序要点/" itemprop="url">
                  二叉堆与堆排序要点
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-05 00:00:00" itemprop="dateCreated datePublished" datetime="2019-04-05T00:00:00+08:00">2019-04-05</time>
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Algorithm/" itemprop="url" rel="index"><span itemprop="name">Algorithm</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="二叉堆，堆排序，与优先队列要点"><a href="#二叉堆，堆排序，与优先队列要点" class="headerlink" title="二叉堆，堆排序，与优先队列要点"></a>二叉堆，堆排序，与优先队列要点</h1><p>今天看完了红皮《算法》第二章的优先队列那一节。二叉堆，堆排序，优先队列，这些都是难舍难分密切相关的几个概念。一句话来说，优先队列作为一种高效的数据结构，其实现依赖于二叉堆这么一种数据结构。借助于优先队列，能实现一种时间复杂度为<code>logn</code>的<strong>原地</strong>排序算法，堆排序。</p>
<p>要点：</p>
<ol>
<li>二叉堆定义（用数组表示时的细节）</li>
<li><strong>插入</strong>（尾端叶子节点）与<strong>删除</strong>（根节点）的过程</li>
<li>建堆方式 + sink 下沉操作 = 堆排序——堆排序的过程</li>
<li>堆排序的优点与缺点<ol>
<li><strong>优点</strong>：内存使用，原地排序</li>
<li><strong>缺点</strong>：CPU cache 缓存命中，非稳定排序，比较次数大于快排</li>
</ol>
</li>
<li>复杂度得出过程</li>
</ol>
<p>[TOC]</p>
<h2 id="二叉堆定义与数组表示"><a href="#二叉堆定义与数组表示" class="headerlink" title="二叉堆定义与数组表示"></a>二叉堆定义与数组表示</h2><p>根节点大于<strong>等于</strong>左右两个子节点。当储存为数组时，根节点放在索引 1 的位置，为了计算便利数组的索引零不存储数据。位置为 k 的节点的父节点位置是 p &lt;= k/2，子节点在数组中的位置是 2k 和 2k+1。如图：</p>
<p><img src="/content/images/2019/HeapRepresentations.png" alt="Heap Representations"></p>
<p>另外，二叉堆<strong>属于</strong>完全二叉树。</p>
<h2 id="二叉堆删除最大节点与插入数据过程"><a href="#二叉堆删除最大节点与插入数据过程" class="headerlink" title="二叉堆删除最大节点与插入数据过程"></a>二叉堆删除最大节点与插入数据过程</h2><h3 id="上浮、下沉操作"><a href="#上浮、下沉操作" class="headerlink" title="上浮、下沉操作"></a>上浮、下沉操作</h3><p>这两个操作是插入、删除 API 的基础操作。</p>
<p><strong>上浮 swim</strong> 是指当某节点的子节点大于其父节点，破坏了堆的有序性，则将这个过大的子节点与它的父节点交换。如果交换之后，该子节点仍然大于交换位置之后的父节点，继续交换。这个过程就被形象化称为上浮。最终，节点上浮到正确的位置，它的父节点大于它，所有子节点小于它。每上浮一次需要 <code>1</code> 次比较。</p>
<p><strong>下沉 sink</strong> 是相反的操作，由上至下比较。如果某节点小于它的子节点，则发生交换。每次下沉需要两次比较。首先比较找出两个子节点中较大的那个，然后比较较大子节点与父节点，如果父节点小于则交换。</p>
<h3 id="删除最大-根节点"><a href="#删除最大-根节点" class="headerlink" title="删除最大/根节点"></a>删除最大/根节点</h3><p>在大端二叉堆中，根节点就是堆中最大元素。将根节点删除/取出之后，把堆中最末尾的元素（也就是树中最大一层最右边的叶子节点）放在根节点的位置，然后对这个节点进行<code>下沉</code>操作。</p>
<p>每次删除操作，需要的时间复杂度最坏为 $\log n$，也就是从根节点一直比较、交换到叶子节点。假设树高度为 h，最坏情况下需要 h 次交换，2h 次比较。与此同时，作为一颗完全二叉树，二叉堆的高度 h 始终小于等于 $\log$~2~$n$，也就是 $\logn$ 复杂度。</p>
<h3 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h3><p>插入的数据将被放在最末端/最右端的叶子节点，然后对其使用上浮操作。最坏情况下需要 h 次比较，h 次交换，所以复杂度也为 $\log n$。</p>
<h2 id="堆排序对数据的初始化：建堆"><a href="#堆排序对数据的初始化：建堆" class="headerlink" title="堆排序对数据的初始化：建堆"></a>堆排序对数据的初始化：建堆</h2><h2 id="优先队列实现注意小细节"><a href="#优先队列实现注意小细节" class="headerlink" title="优先队列实现注意小细节"></a>优先队列实现注意小细节</h2><ol>
<li><p><code>sink</code> 的调用条件是当前被下沉节点的子节点索引<strong>小于等于</strong>优先队列元素数量。否则，在边界条件时，就会导致有元素没有被下沉。举个例子，当队列还有三个元素，<code>star, was, worst</code>， 删除顶端元素之后在顶端插入末尾元素 <code>worst</code>，此时 <code>worst</code> 子节点为 <code>was</code>，索引为 <code>1*2 = 2</code>，大于等于优先队列的元素总数量，<code>sink</code> 操作没有调用，<code>worst</code> 元素先于 <code>was</code> 被取出队列。</p>
</li>
<li><p>在下沉 <code>sink</code> 操作时，在将当前节点与子节点比较之前，应该先比较两个子节点。如果是大顶堆，则选出更大的节点来与父节点比较，小顶堆则选出两者中更小的节点。</p>
</li>
<li><p>在比较两子节点时，也要注意子节点索引不能越界。同样在只有两个元素时进行 <code>sink</code> 操作的情况下，只有一个子节点，试图寻找此子节点的下一个子节点将会超越数组边界。例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sink</span><span class="params">(<span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> j = <span class="number">2</span> * k;</span><br><span class="line">    <span class="keyword">while</span> (j &lt;= N) &#123;</span><br><span class="line">        <span class="keyword">if</span> (j+<span class="number">1</span> &lt;= N &amp;&amp; less((j + <span class="number">1</span>), j)) &#123;</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (less(j, k)) &#123;</span><br><span class="line">            exch(j, k);</span><br><span class="line">            k = j;</span><br><span class="line">            j *= <span class="number">2</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/09/Flask Web Development Notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Rust">
      <meta itemprop="description" content="programming and free market">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/09/Flask Web Development Notes/" itemprop="url">
                  Flask Web Development Notes
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-08-09 22:54:00" itemprop="dateCreated datePublished" datetime="2018-08-09T22:54:00+08:00">2018-08-09</time>
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/技术笔记/" itemprop="url" rel="index"><span itemprop="name">技术笔记</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/技术笔记/读书笔记/" itemprop="url" rel="index"><span itemprop="name">读书笔记</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Flask-Web-Development-Notes"><a href="#Flask-Web-Development-Notes" class="headerlink" title="Flask Web Development Notes"></a>Flask Web Development Notes</h1><blockquote>
<p>这是我暑假看 Miguel 的那本著名狗书时的笔记，书的版本是最新的 second edition。当时看的是原文版，以后会写一篇文章说阅读英语原文的经验</p>
</blockquote>
<h2 id="Ch2-Basic-Application-Structure"><a href="#Ch2-Basic-Application-Structure" class="headerlink" title="Ch2 Basic Application Structure"></a>Ch2 Basic Application Structure</h2><h3 id="Run-an-app"><a href="#Run-an-app" class="headerlink" title="Run an app"></a>Run an app</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> FLASK_APP=name.py</span><br><span class="line"><span class="built_in">export</span> FLASK_DEBUG=1</span><br><span class="line">flask run</span><br></pre></td></tr></table></figure>
<h3 id="Dynamic-route"><a href="#Dynamic-route" class="headerlink" title="Dynamic route"></a>Dynamic route</h3><p>Flask supports the types <code>string</code>, <code>int</code>, <code>float</code>, and <code>path</code> for routes. The <code>path</code> type is a special <code>string</code> type.</p>
<h3 id="Response"><a href="#Response" class="headerlink" title="Response"></a>Response</h3><p><em>view function</em> could take as much as three arguments, <em>status code</em> and a <em>dictionary of headers</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">return</span> <span class="string">'&lt;h1&gt;Bad Request&lt;/h1&gt;'</span>, <span class="number">400</span></span><br></pre></td></tr></table></figure>
<h3 id="Compatibility-with-older-version"><a href="#Compatibility-with-older-version" class="headerlink" title="Compatibility with older version"></a>Compatibility with older version</h3><p><code>app.run(debug=True)</code></p>
<p><code>app.add_url_rule()</code>: builds the map between URL and view function</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flask run --host 0.0.0.0</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install sqlite3 libsqlite3-dev</span><br></pre></td></tr></table></figure>
<h2 id="Ch3-Templates"><a href="#Ch3-Templates" class="headerlink" title="Ch3 Templates"></a>Ch3 Templates</h2><p><em>business logic</em> and <em>presentation logic</em>, Jinja2 takes the work of <em>presentation</em>. More specifically, the application only sends variables to Jinja2, after that how the HTML page is presented is up to Jinja2.</p>
<h3 id="What-this-chapter’s-mainly-about"><a href="#What-this-chapter’s-mainly-about" class="headerlink" title="What this chapter’s mainly about"></a>What this chapter’s mainly about</h3><p>Static web pages. Topics in this chapter:</p>
<ul>
<li>What are templates; how to inherit</li>
<li>How to write URLs in Flask; <code>url_for()</code> helper function; relative &amp; absolute URLs, the latter one less useful</li>
<li>How to send static files (in template format)</li>
<li>Miscellaneous: Bootstrap integration</li>
</ul>
<h2 id="Ch4-Web-Forms"><a href="#Ch4-Web-Forms" class="headerlink" title="Ch4 Web Forms"></a>Ch4 Web Forms</h2><h3 id="Form-classes-（technical"><a href="#Form-classes-（technical" class="headerlink" title="Form classes （technical)"></a>Form classes （technical)</h3><p><code>FlaskForm</code> defines the list of <code>field</code>s in each form, each represented by an object. Each <code>field</code> object have one or more <em>validators</em> attached. A <em>validator</em> is a function. Note the three terms here, <em>FlaskForm, field, validator</em>.</p>
<h3 id="Form-submission-with-GET"><a href="#Form-submission-with-GET" class="headerlink" title="Form submission with GET"></a>Form submission with GET</h3><p>Bad. GET doesn’t have a <em>body</em>, so if submit with GET method, the <em>data</em> will be appended to the URL as a <em>query string</em>, and becomes visible in the browser’s address bar.</p>
<p>Therefore, in <em>view function</em> that deals with forms, add a <code>POST</code> method like that:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/', methods=['GET', 'POST'])</span></span><br></pre></td></tr></table></figure>
<h3 id="Miscellaneous"><a href="#Miscellaneous" class="headerlink" title="Miscellaneous"></a>Miscellaneous</h3><p>This method returns <code>True</code> when form is <del>submitted</del> submitted using POST method, and the data accepted by all <em>field validators</em>; used to <em>determine</em>, whether the form needs to be <em>rendered</em> or <em>processed</em>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">	<span class="comment">###</span></span><br></pre></td></tr></table></figure>
<p>The first and only required argument to <code>url_for()</code> is the <em>endpoint</em> name.  By default, the endpoint of a route is the name of the view function attached to it. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br></pre></td></tr></table></figure>
<h2 id="Ch5-Databases"><a href="#Ch5-Databases" class="headerlink" title="Ch5 Databases"></a>Ch5 Databases</h2><h3 id="Terms"><a href="#Terms" class="headerlink" title="Terms"></a>Terms</h3><p>column: attribute of the entity; row: actual data element that <em>assigns</em> values to columns.</p>
<p>table, record –&gt; collection, document, from Relational to NoSQL</p>
<p><em>primary key</em>: a special <em>column</em>; <em>foreign keys</em>: columns</p>
<h3 id="Sum"><a href="#Sum" class="headerlink" title="Sum"></a>Sum</h3><ul>
<li>With ORM middleman, one doesn’t have to SQL semantics</li>
<li>Apply different URLs in config could migrate from different (relational) databases</li>
<li>Databases migration:<ul>
<li>Framework: <em>Flask-Migrate</em>, the <em>Alembic wrapper</em></li>
<li>Procedures: <code>flask db init</code>, creates a <em>migrations</em> directory (optional, only on a new project); <code>flask db migrate -m &quot;message&quot;</code>, <em>automatically</em> creates <em>migration script</em>, while <code>revision</code> manually; <code>flask db upgrade</code></li>
<li><code>flask db downgrade</code> and <code>... upgrade</code> gives db migrations log history like <em>git</em></li>
</ul>
</li>
</ul>
<h2 id="Ch7-Large-Application-Structure"><a href="#Ch7-Large-Application-Structure" class="headerlink" title="Ch7 Large Application Structure"></a>Ch7 Large Application Structure</h2><h3 id="Add-custom-commands-via-click"><a href="#Add-custom-commands-via-click" class="headerlink" title="Add custom commands via click"></a>Add custom commands via <em>click</em></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.cli.command()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">thatWillBetheNameofCommand</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="string">"""This will be shown in the help messages"""</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<h3 id="Blueprint-detail"><a href="#Blueprint-detail" class="headerlink" title="Blueprint detail"></a>Blueprint detail</h3><ul>
<li><p>In chapter 7 about <em>blueprint</em>, the module where blueprint object is must import its routes’ view functions, because</p>
<blockquote>
<p>Importing these modules causes the routes and error handlers to be associated with the blueprint. </p>
</blockquote>
</li>
<li><p>From Eg.7.7: the blueprint name before <em>endpoint</em> can be omitted, as <code>url_for(&#39;.index&#39;)</code>. <em>Redirects</em> within the same blueprint could use the shorter form, while crossing blueprints requires the fully qualified endpoint name that includes the blueprint name.</p>
</li>
</ul>
<h2 id="Ch8-User-Authentication"><a href="#Ch8-User-Authentication" class="headerlink" title="Ch8 User Authentication"></a>Ch8 User Authentication</h2><blockquote>
<p>Hashing functions are repeatable.</p>
</blockquote>
<ul>
<li><strong>Q:</strong> How could the <code>check_password_hash(hash, password)</code> check pwd without knowing the <em>salt</em> of it?</li>
</ul>
<h3 id="WTForm-write-your-own-validator-with-validate-prefix"><a href="#WTForm-write-your-own-validator-with-validate-prefix" class="headerlink" title="WTForm: write your own validator with validate_ prefix"></a>WTForm: write your own validator with <em>validate_</em> prefix</h3><ul>
<li>for <code>wtforms</code> <em>validate_</em> prefix defines custom validators; while in Python standard library <code>unittest</code> the <em>test_</em> prefix is used.</li>
<li>any function referred the database, is defined in <code>model.py</code>, as methods in those ORM models. They access the database using <code>self.attribute</code>.</li>
</ul>
<h3 id="Flask-Login-detail"><a href="#Flask-Login-detail" class="headerlink" title="Flask-Login detail"></a>Flask-Login detail</h3><p>Flask-Login requires the application to designate a function to be invoked when the extension needs to load a user from the database given its identifier, registered with <code>@login_manager.user_loader</code> decorator.</p>
<p><code>_get_user()</code> searches for a user ID in the <em>user session</em> –&gt; invoke the function registered with the <code>user_loader</code> decorator, with the ID as argument</p>
<h2 id="Ch14-API"><a href="#Ch14-API" class="headerlink" title="Ch14 API"></a>Ch14 API</h2><p>The process of converting an internal representation to a transport format such as JSON is called <strong>serialization</strong>.</p>
<h2 id="Todo"><a href="#Todo" class="headerlink" title="Todo"></a>Todo</h2><ul>
<li><p>[ ] decorators in Python<br>They are functions that takes  a func as an arg then returns another arg</p>
</li>
<li><p>[ ] <strong>OOP</strong> concepts: constructor, method&amp;attribute<br>(so far I <em>assume</em> that) Methods are funcs, attributes are data.</p>
</li>
<li><p>[x] How blocks are really defined in bootstrap/base.html</p>
</li>
<li><p>[ ] what <code>&lt;&gt;</code> means in Python code (<code>&lt;{&#39;key1&#39;: v, &#39;k2&#39;: v2}&gt;</code>)</p>
</li>
<li><p>[x] What is <em>label</em> in HTML<br>makes the form text clickable; same style with it.</p>
</li>
<li><p>[ ] &gt; The remaining class variables are the attributes of the model, defined as instances of the <code>db.Column</code> class.</p>
<p>what is <em>instance, class variable, attribute</em></p>
</li>
<li><p>[ ] <code>with</code> keyword in Python</p>
</li>
<li><p>[x] <code>__name__</code>, <code>__file__</code> and other dunder variable (<code>basedir = os.path.abspath(os.path.dirname(__file__))</code>)</p>
<ul>
<li><code>__name__</code> has two values, <code>&quot;__main__&quot;</code> (when being executed) or the module’s name (when imported). With respect to Object, <code>__name__</code> is the special attribute of a class, function, method, descriptor, or generator instance. </li>
<li><code>__file__</code>, the absolute path of the module</li>
</ul>
</li>
<li><p>[ ] functionality of the <code>__init__.py</code> file in a directory</p>
</li>
<li><p>[ ] <strong>OOP:</strong> <code>@property</code> decorator in a class</p>
</li>
<li><p>[ ] <strong>DB:</strong> <code>users = db.relationship(&#39;User&#39;, backref=&#39;role&#39;, lazy=&#39;dynamic&#39;)</code>. “users” is a <em>column</em> of the table <em>role</em>. What does <code>lazy</code> kwarg mean</p>
</li>
<li><p>[x] <strong>DB:</strong> <code>Role.query.filter_by(name=&#39;Administrator&#39;).first()</code>, type of the return value</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User.query.filter_by(username=<span class="string">'galt'</span>).first()  <span class="comment"># output: &lt;User 'john'&gt;</span></span><br><span class="line">a = User.query.filter_by(username=<span class="string">'galt'</span>).first()</span><br><span class="line">type(a)  <span class="comment"># output: &lt;class 'app.models.User'&gt;</span></span><br></pre></td></tr></table></figure>
<p>On success, return value is the <em>row</em> in the table. <code>a.id</code> would return the <code>id</code> <em>column</em> of user <code>galt</code>.</p>
</li>
</ul>
<hr>
<ul>
<li style="list-style: none"><input type="checkbox"> Linux command <code>export</code></li>
<li style="list-style: none"><input type="checkbox"> <code>form.hidden_tag()</code> element for CSRF protection</li>
<li style="list-style: none"><input type="checkbox" checked> How much freedom does ORM/ODM provide in choosing DB, only different <em>rational databases</em>?<br>Yes.</li>
<li style="list-style: none"><input type="checkbox"> <figure class="highlight plain"><figcaption><span>wtf.quick_form(form) &#125;&#125;```, how will this template be rendered, search keyword in the book</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">  - `&#123;&#123; name &#125;&#125;` construct references a **variable**, a **placeholder**</span><br><span class="line">- [ ] How to initialize `SelectField`, 7.31</span><br><span class="line">- [ ] `Post.query.order_by` will this query affect rows? 8.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### After Flask:</span><br><span class="line"></span><br><span class="line">- [ ] WTForm package *validator* source code, I assume it&apos;s just RegEx</span><br><span class="line"></span><br><span class="line">- [ ] For example, the execution of the `send_async_email()` function can be sent to a [Celery](http://www.celeryproject.org/) task queue. (p.107)</span><br><span class="line"></span><br><span class="line">- [ ] **Decorator:** How different orders affects the registered function</span><br><span class="line"></span><br><span class="line">- [ ] **Thread:** *worker thread* in Flask doc</span><br><span class="line"></span><br><span class="line">- [ ] **Iterator** and that: </span><br><span class="line"></span><br><span class="line">  ```python</span><br><span class="line">  follows = [&#123;&apos;user&apos;: item.follower, &apos;timestamp&apos;: item.timestamp&#125;</span><br><span class="line">  for item in pagination.items]</span><br></pre></td></tr></table></figure></li>
</ul>
<p>Check yourself: </p>
<ul>
<li>How to add a new row in a table, how to change a column of a row</li>
<li>Page 182, how the foreign key of a table is added</li>
</ul>
<hr>
<ul>
<li><p>synopsis: brief summary</p>
</li>
<li><p>delimiter (<em>programming</em>)</p>
</li>
<li><p>miscellaneous</p>
</li>
<li><p><em>callable</em>, page 65</p>
</li>
<li><p>cardinality alchemy, transparent (Ch5)</p>
</li>
<li><blockquote>
<p>build a perfect <strong>replica</strong> of the virtual environment…</p>
</blockquote>
</li>
</ul>
<h2 id="Appendix"><a href="#Appendix" class="headerlink" title="Appendix"></a>Appendix</h2><h3 id="Object-in-Python"><a href="#Object-in-Python" class="headerlink" title="Object in Python"></a>Object in Python</h3><p>type of methods:</p>
<ul>
<li><em>instance method</em>, the 1st argument of it <em>must</em> be <code>self</code>; any method taking <code>self</code> as the 1st arg is a <em>instance method</em></li>
<li><em>class method</em>, <code>@classmethod</code>, <code>cls</code> as the 1st arg. Calling: <code>Obj().count()</code>, where <code>Obj</code> is the name of a class</li>
<li><em>static method</em>， <code>@staticmethod</code>. E.g. <code>Obj().someStaticMethod()</code></li>
</ul>
<p><code>super()</code> in Python2.x takes its own class as the first variable, like <code>super(Child, self).__init__(age, height)</code>. Also the <em>parent</em> shall be defined as <code>class Parent(object)</code>, having <code>object</code> as base class.</p>
<h3 id="REST-API"><a href="#REST-API" class="headerlink" title="REST API"></a>REST API</h3><ul>
<li>more business logic on client side</li>
<li>client could <em>discover</em> resources using different URL compositions</li>
<li>versioning for backward compatibility</li>
</ul>
<h3 id="Compare-to-Mage-Tutorial"><a href="#Compare-to-Mage-Tutorial" class="headerlink" title="Compare to Mage Tutorial"></a>Compare to Mage Tutorial</h3><ol>
<li>_get</li>
<li>plain text and HTML email</li>
<li>from GitHub’s <em>commit</em> history you could view specifically what changed in every commit</li>
</ol>
<h3 id="Test-amp-Caution"><a href="#Test-amp-Caution" class="headerlink" title="Test &amp; Caution"></a>Test &amp; Caution</h3><ol>
<li><p>Think of <strong>boundary values</strong> while designing programs.</p>
<ul>
<li><code>current_user.confirmed</code></li>
<li><code>@login_required</code></li>
<li><code>self.email.lower()</code> ensure that the string is lowercase</li>
<li><code>verify_password(email, password):</code> before loading user from DB to check pwd, <code>email</code> must be checked first not to be <code>&#39;&#39;</code></li>
</ul>
</li>
<li><p>Crucial cases where proxies provided by Flask like<code>current_app</code> can’t fake:</p>
<ul>
<li><code>current_app</code> can’t fake its type as the actual object type</li>
<li><p>when sending <em>Signals</em> or passing data <em>to a background thread</em></p>
<p>best practice:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app = current_app._get_current_object()</span><br><span class="line">my_signal.send(app)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.exc <span class="keyword">import</span> IntegrityError</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">	db.session.commit()</span><br><span class="line"><span class="keyword">except</span> IntegrityError:</span><br><span class="line">	db.session.rollback()</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>form.body.data = post.body</code>; how to render page according to attributes of the user;  Context processors make variables available to all templates during rendering</p>
</li>
<li><p><code>from app.exceptions import</code></p>
</li>
</ol>
<h3 id="The-power-of-Flask-Shell"><a href="#The-power-of-Flask-Shell" class="headerlink" title="The power of Flask Shell"></a>The power of Flask Shell</h3><p>Page 214, static method <code>add_self_follows()</code> that manipulates existed <em>rows</em></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/21/VimCheatsheet/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Rust">
      <meta itemprop="description" content="programming and free market">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/21/VimCheatsheet/" itemprop="url">
                  Vim Cheat Sheet
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-07-21 22:54:00" itemprop="dateCreated datePublished" datetime="2018-07-21T22:54:00+08:00">2018-07-21</time>
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/技术笔记/" itemprop="url" rel="index"><span itemprop="name">技术笔记</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>最近用上了 WSL，巨硬居然在 Win 上允许使用 Linux了<br>修改文件不可避免似乎就要学会 Vim 啊，后来才知道自带 nano</p>
</blockquote>
<h2 id="Motion"><a href="#Motion" class="headerlink" title="Motion"></a>Motion</h2><p><code>h</code>, <code>l</code>: move left and right</p>
<p><code>j</code>, <code>k</code>: move down and up</p>
<p><code>w</code>: next <strong>beginning</strong> of word</p>
<p><code>e</code>, <code>ge</code>: <strong>current, last</strong> <strong>end</strong> of word</p>
<p><code>b</code>, <code>B</code>: <strong>previous beginning</strong> of word and <strong>WORD</strong></p>
<p><code>0</code>, <code>^</code>: to the <strong>beginning of line</strong></p>
<p><code>$</code>: to the <strong>end</strong> of line</p>
<p><code>gg</code>, <code>G</code>: <strong>beginning</strong>, <strong>end</strong> of <strong>file</strong> </p>
<p><code>nG</code>: line n; <code>:set nu</code> to turn on line num</p>
<p><code>f&lt;char&gt;</code>, <code>F&lt;char&gt;</code>: <strong>search</strong> forward, backward</p>
<h2 id="Edit"><a href="#Edit" class="headerlink" title="Edit"></a>Edit</h2><p><code>cw</code>: <strong>C</strong>hange current word that the cursor’s at</p>
<p><code>cc</code>: <em>delete</em> the whole line and enter INSERT mode</p>
<p><code>C</code>: delete till the <strong>end of line</strong>, enter INSERT mode</p>
<p><code>r&lt;char&gt;</code>: <strong>R</strong>eplace cursor with \&lt;char></p>
<p><code>R</code>: replace successively, with each\&lt;char>  typed; <code>Esc</code> to exit</p>
<p><code>un</code> <strong>U</strong>ndo for <strong>n</strong> times</p>
<p><code>U</code> undo all changes in current <strong>line</strong></p>
<p><code>Ctrl</code> + <code>r</code>: redo</p>
<p><code>&gt;&gt;</code>, <code>&lt;&lt;</code>: tab in NORMAL mode</p>
<p><code>:set shiftwidth?</code></p>
<p><code>:ce</code> <strong>center</strong> the line</p>
<p><code>:ri</code>, <code>:le</code>: to the <strong>right</strong>, <strong>left</strong></p>
<h3 id="Search"><a href="#Search" class="headerlink" title="Search"></a>Search</h3><p><code>/</code>, <code>?</code>: search <strong>next</strong>, <strong>last</strong></p>
<p><code>n</code>, <code>N</code>: <strong>next</strong>, <strong>last</strong> result</p>
<h2 id="Insert"><a href="#Insert" class="headerlink" title="Insert"></a>Insert</h2><p><code>i</code>, <code>a</code>: insert <strong>at</strong> and <strong>append</strong> cursor position</p>
<p><code>I</code>, <code>A</code>: insert at the <strong>beginning</strong> and the <strong>end</strong> of current line</p>
<p><code>o</code>, <code>O</code>: <strong>O</strong>pen a new line <strong>after</strong> and <strong>before</strong> current line, and enter INSERT mode</p>
<h2 id="Copy-Paste-and-Cut"><a href="#Copy-Paste-and-Cut" class="headerlink" title="Copy, Paste, and Cut"></a>Copy, Paste, and Cut</h2><p><code>yy</code>: <strong>Y</strong>ank(copy) <strong>whole line</strong></p>
<p><code>yw</code>, <code>ynw</code>: copy one <strong>word</strong>, <strong>n</strong> words</p>
<p><code>y^</code>, <code>y0</code>: copy till the <strong>beginning of line</strong>, current cursor <strong>not</strong> included</p>
<p><code>y$</code>: copy till the <strong>end</strong>, char where the cursor’s at <strong>included</strong></p>
<p><code>yG</code>, <code>y1G</code>: copy till <strong>end</strong>, <strong>beginning</strong> of <strong>file</strong></p>
<p><code>p</code>: (lowercase) paste on <strong>next line</strong></p>
<p><code>P</code>: (uppercase) paste <strong>last line</strong></p>
<p><code>dd</code>: cut</p>
<p><code>ddp</code>: <strong>swap</strong> this and <strong>next</strong> line</p>
<h2 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h2><p><code>x</code>: <strong>D</strong>elete char <strong>under</strong> cursor</p>
<p><code>X</code>: delete char <strong>before</strong> cursor</p>
<p><code>dd</code>: delete the entire line</p>
<p><code>dw</code>: delete word <em>after</em> cursor; <code>w</code> + <code>dw</code></p>
<p><code>D</code>: delete till the end of <strong>line</strong></p>
<p><code>d^</code>: delete till the beginning</p>
<p><code>d1G</code>, <code>dG</code>: delete till the <strong>beginning</strong> and <strong>end</strong> of <strong>file</strong></p>
<h2 id="Repeat"><a href="#Repeat" class="headerlink" title="Repeat"></a>Repeat</h2><p><code>.</code>: repeat last command (under NORMAL mode)</p>
<p><code>N&lt;command&gt;</code>: e.g. 2dd, 10x</p>
<p><code>dnw</code>: delete a word <strong>n</strong> times </p>
<h2 id="Exit"><a href="#Exit" class="headerlink" title="Exit"></a>Exit</h2><p><code>:q</code>: quit</p>
<p><code>:wq</code>, <code>:x</code>: save and exit</p>
<p><code>:wq!</code>: <strong>force</strong> to save and quit</p>
<p><code>:w</code>, <code>:saveas</code></p>
<p><code>Shift</code> + <code>zz</code>: under NORMAL mode, save and exit</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Rust</p>
              <p class="site-description motion-element" itemprop="description">programming and free market</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives">
                
                    <span class="site-state-item-count">12</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">10</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">14</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Rust</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Pisces</a> v6.4.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.1"></script>



  



  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
