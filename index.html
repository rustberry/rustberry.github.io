<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"yoursite.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.14.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Tu ne cede malis, sed contra audentior ito">
<meta property="og:type" content="website">
<meta property="og:title" content="Rust Shrugged">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Rust Shrugged">
<meta property="og:description" content="Tu ne cede malis, sed contra audentior ito">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Jimmy Xu">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://yoursite.com/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Rust Shrugged</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Rust Shrugged</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Programming and a free mind</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Jimmy Xu</p>
  <div class="site-description" itemprop="description">Tu ne cede malis, sed contra audentior ito</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">13</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/02/10/Netty%20%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B--%E6%A6%82%E8%BF%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jimmy Xu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
      <meta itemprop="description" content="Tu ne cede malis, sed contra audentior ito">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Rust Shrugged">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/02/10/Netty%20%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B--%E6%A6%82%E8%BF%B0/" class="post-title-link" itemprop="url">Netty 基础组件与线程模型--概述</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-02-10 05:13:07" itemprop="dateCreated datePublished" datetime="2023-02-10T05:13:07+00:00">2023-02-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Netty/" itemprop="url" rel="index"><span itemprop="name">Netty</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Netty-基础组件与线程模型–概述"><a href="#Netty-基础组件与线程模型–概述" class="headerlink" title="Netty 基础组件与线程模型–概述"></a>Netty 基础组件与线程模型–概述</h1><p>即使仅仅谈论这两个话题：Netty 组件和 Netty 线程模型，也不是一两篇文章可以 cover 的。这里做一个小尝试，也对这几天看的 <em>Netty in Action</em> 总结一下。</p>
<h2 id="Netty-想要解决什么问题"><a href="#Netty-想要解决什么问题" class="headerlink" title="Netty 想要解决什么问题"></a>Netty 想要解决什么问题</h2><p>一项新技术&#x2F;开源项目，问问自己，这个技术想要解决的是什么问题，是如何解决的。</p>
<p>以我目前的水平回答，是为了弥补 Java 标准库在 I&#x2F;O 上的不足。这种不足我现在看来有两部分：性能与易用性。</p>
<p>性能方面，作为标准库，API 稳定、统一的需求更重要，从而无法在提升性能上下狠功夫。Netty 则在各种角落实行了优化。最明显的是对垃圾回收与内存分配的修改，使得 ByteBuf 一定程度由使用者手动管理；以及针对不同平台提供与底层实现紧密相关的优化，比如针对 Linux 的 EpollEventLoopGroup，从而能提供边缘触发，而非 Java NIO 默认的水平触发。另外，据 Norman Maurer <a target="_blank" rel="noopener" href="https://stackoverflow.com/a/36058105/8144090">自己所说</a>，还有更低的 GC。其它细节包括使用 OpenSSL 替换 Java 标准库，等等。</p>
<p>另一方面，NIO 在使用上不够直观。仅仅 <code>flip</code> 这个方法的设计就很迷惑——像 Netty 一样为读和写单独设置两个指针多方便。</p>
<h2 id="Netty-自测问题"><a href="#Netty-自测问题" class="headerlink" title="Netty 自测问题"></a>Netty 自测问题</h2><p>看完 Netty in Action 之后我反问自己都了解到了些什么，想到了如下的问题：</p>
<p><code>EventLoop</code>  与 <code>EventLoopGroup</code> 的区别，之间的关系是什么？EventLoopGroup 拥有几个线程？EventLoop 呢？</p>
<p>EventLoop 与 Channel 是什么关系？</p>
<p>ChannelHandler 与 ChannelPipeline 是什么关系？</p>
<p>ChannelHandlerAdapter 对 ChannelHandler 区别是什么，有何改进？</p>
<p>Channel、ChannelHandler 生命周期？</p>
<p>我发现很多问题自己居然都给不出回答，然后立刻回去看书的三、六、七章，有一种开窍的感觉。之前看第一遍时无感，并且不知道重点的内容，这一次都变成了问题的答案，看的过程也津津有味起来。</p>
<h2 id="简单梳理"><a href="#简单梳理" class="headerlink" title="简单梳理"></a>简单梳理</h2><p>简单梳理一下基础的概念，下图来自《Netty in Action》，侵删：</p>
<p>![Channel EventLoop and EventLoopGroup](&#x2F;content&#x2F;images&#x2F;2019&#x2F;Channel EventLoop and EventLoopGroup.png)</p>
<ul>
<li>Channel 就是一种“传输（transport）”，一个 Socket 就属于 Channel，所以最简单可以理解为，Channel 就是一个 Socket；</li>
<li>一个 Channel 在它的生命周期内只注册于一个 EventLoop；</li>
<li>一个 EventLoop 在它的生命周期中只与一个 Thread 绑定。实际上，最常用的实现 NioEventLoop 扩展自 SingleThreadEventLoop；</li>
<li>一个 EventLoop 可能会被分配给一个或多个 Channel（这样一来，不必每个 Socket 连接就分配一个线程，用有限的线程支撑更多的连接）；</li>
</ul>
<p>这种设计消除了同步（synchronization）的需求，因为一个 Channel 的所有 I&#x2F;O 操作都是由同一个线程（异步地）完成的。</p>
<ul>
<li>ChannelPipeline 提供了 ChannelHandler 链的容器</li>
</ul>
<h2 id="线程模型"><a href="#线程模型" class="headerlink" title="线程模型"></a>线程模型</h2><h3 id="Reactor-pattern-amp-Proactor-pattern"><a href="#Reactor-pattern-amp-Proactor-pattern" class="headerlink" title="Reactor pattern &amp; Proactor pattern"></a>Reactor pattern &amp; Proactor pattern</h3><p>在学习阅读 Netty 的时候，我意识到书的作者以及文档作者都假定了，读者对于所谓的 Proactor 模式、Reactor 模式有所了解。所以我认为有必要先简要了解一下这两种模式。</p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Reactor_pattern">Reactor pattern</a> 有<strong>一个</strong>主线程，从多个 input 读取服务请求，然后把这些请求<strong>同步地</strong>分发给对应的服务处理线程。通常主线程使用同步的 <code>select</code> 来监听多个文件描述符，当一个阻塞操作，比如 <code>read()</code> 准备完毕，<code>select</code> 获得通知，就将其转发给服务处理线程。</p>
<p>关于 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Proactor_pattern">Proactor pattern</a>：</p>
<blockquote>
<p>The proactor pattern can be considered to be an <a target="_blank" rel="noopener" href="https://en.wiktionary.org/wiki/asynchronous">asynchronous</a> variant of the <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Synchronization_(computer_science)">synchronous</a> <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Reactor_pattern">reactor pattern</a>.</p>
<p>– Wikipedia</p>
</blockquote>
<p>Proactor 模式可以视作 Reactor 模式的异步形式。耗时长的任务异步地完成，在结束时发送通知。</p>
<h3 id="Netty-的-Boss-Worker-EventLoopGroup"><a href="#Netty-的-Boss-Worker-EventLoopGroup" class="headerlink" title="Netty 的 Boss-Worker EventLoopGroup"></a>Netty 的 Boss-Worker EventLoopGroup</h3><p>了解了有这种主-从线程池的区分之后，就能理解，为什么很多 Netty 示例程序中 Server 的 <code>ServerBootStrap#group(EventLoopGroup, EventLoopGroup)</code> 会有绑定两个 EventLoopGroup。即使某些简单的 demo 实现中只绑定了一个，如： <code>group(EventLoopGroup)</code>，这一方法其实只是绑定主从 EventLoopGroup 的重载方法，源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ServerBootstrap <span class="title function_">group</span><span class="params">(EventLoopGroup group)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> group(group, group);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>官方 <a target="_blank" rel="noopener" href="https://netty.io/wiki/user-guide-for-4.x.html">User Guide</a> 的解释如下：</p>
<blockquote>
<p>The first one, often called ‘boss’, accepts an incoming connection. The second one, often called ‘worker’, handles the traffic of the accepted connection once the boss accepts the connection and registers the accepted connection to the worker. </p>
</blockquote>
<p>第一个是被称为 boss 的 EventLoopGroup，负责接受连接，第二个则被称为 worker，负责处理由 boss 分配给它的已接受的连接。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/02/10/Netty%20%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B%EF%BC%88%E4%BA%8C%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jimmy Xu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
      <meta itemprop="description" content="Tu ne cede malis, sed contra audentior ito">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Rust Shrugged">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/02/10/Netty%20%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B%EF%BC%88%E4%BA%8C%EF%BC%89/" class="post-title-link" itemprop="url">Netty（二）线程模型与 Bytebuf</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-02-10 05:13:07" itemprop="dateCreated datePublished" datetime="2023-02-10T05:13:07+00:00">2023-02-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Netty/" itemprop="url" rel="index"><span itemprop="name">Netty</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Netty（二）线程模型与-Bytebuf"><a href="#Netty（二）线程模型与-Bytebuf" class="headerlink" title="Netty（二）线程模型与 Bytebuf"></a>Netty（二）线程模型与 Bytebuf</h1><h2 id="ServerBootStrap-中的-EventLoopGroup"><a href="#ServerBootStrap-中的-EventLoopGroup" class="headerlink" title="ServerBootStrap 中的 EventLoopGroup"></a>ServerBootStrap 中的 EventLoopGroup</h2><p>ServerBootStrap 实际上内部是两个 group，解释：</p>
<blockquote>
<p>Most of the times using the same group for accepting and handling the accepted connections is working out quite well and so allows you to save some threads. The only time when you may not want to do this is if the handling logic of the accepted connections will keep the EventLoops so busy that you are not able to accept fast enough. </p>
<p>– <a target="_blank" rel="noopener" href="https://stackoverflow.com/a/28342821/8144090">Norman SO answer</a></p>
</blockquote>
<p>Vert.x 是一个基于 Netty 的框架，但是其初始化是将一个线程组（EventLoopGroup）同时用于 boss 与 worker。Norman回答到，这种方法大多数时候都挺不错，并且节省了一些线程。我认为这里说的节省了的线程是 boss 线程，在没有新的连接进来的时候可以参与到 handler 的任务中。然而，当 handler 要处理的任务消耗太多 CPU 时间时，EventLoopGroup 中的所有 EventLoop，也就是线程，会全都忙于处理任务，不能很快地、甚至无法 accept 新进来的连接。</p>
<p>对于 boss EventLoopGroup，什么情况下使用超过一个线程？</p>
<p>在构造函数中可以选择线程数：<code>NioEventLoopGroup(threadsAmount)</code>。但是，既然 boss group 的职责只是接受 accept 新连接并且分发，按照 Proactor 的模型，一个线程足矣。当一个 EventLoopGroup 被多个 ServerBoostrap 分享，则按需增加线程。</p>
<h3 id="EventLoopGroup-默认线程数"><a href="#EventLoopGroup-默认线程数" class="headerlink" title="EventLoopGroup 默认线程数"></a>EventLoopGroup 默认线程数</h3><p>如果在 EventLoopGroup 初始化时没有指定线程数，则由以下的静态初始块设置默认线程数。代码出自<a target="_blank" rel="noopener" href="https://github.com/netty/netty/blob/9621a5b98120f9596b5d2a337330339dda199bde/transport/src/main/java/io/netty/channel/MultithreadEventLoopGroup.java#L40">MultithreadEventLoopGroup.java</a> 第 40 行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">	DEFAULT_EVENT_LOOP_THREADS = Math.max(<span class="number">1</span>, SystemPropertyUtil.getInt(</span><br><span class="line">    	<span class="string">&quot;io.netty.eventLoopThreads&quot;</span>, NettyRuntime.availableProcessors() * <span class="number">2</span>));</span><br><span class="line"><span class="comment">// 在本人的双核机器上，有四个逻辑处理器，乘以二之后 DEFAULT_EVENT_LOOP_THREADS 为 8</span></span><br></pre></td></tr></table></figure>

<h2 id="ChannelHandler-与-EventLoopGroup-中的线程"><a href="#ChannelHandler-与-EventLoopGroup-中的线程" class="headerlink" title="ChannelHandler 与 EventLoopGroup 中的线程"></a>ChannelHandler 与 EventLoopGroup 中的线程</h2><p>用自己语言更具体解释一下“Netty 4中的Handler处理在IO线程中，如果Handler处理中有耗时的操作（如数据库相关），会让IO线程等待，影响性能。”</p>
<blockquote>
<p>我们之前已经阐明了不要阻塞当前 I&#x2F;O 线程的重要性。我们再以另一种方式重申一次：“永远不要将一个长时间运行的任务放入到执行队列中，因为它将阻塞需要在同一线程执行的任何其他任务。” 如果必须要进行阻塞调用或者执行长时间运行的任务，我们建议使用一个专门的 EventExecutor。（见 6.2.1 节的“ChannelHandler 的执行和阻塞”）。</p>
<p>– 摘自 Netty in Action P96</p>
</blockquote>
<p>![EventLoop 执行逻辑](&#x2F;content&#x2F;images&#x2F;2019&#x2F;EventLoop 执行逻辑.png)</p>
<p>总结一下，EventLoop 中的线程又被称为 I&#x2F;O 线程，一个 Channel 中的所有事件（出站&#x2F;入站）都只会被其所绑定的这个 I&#x2F;O 线程处理。一个 Channel 永远一个 EventLoop I&#x2F;O 线程绑定，而一个 I&#x2F;O 线程则可能被分配给多个 Channel。如果这个 I&#x2F;O 线程陷入执行一个 CPU 时间耗时长的任务，所有与之关联的 Channel 中的任务都会被搁置。</p>
<p>源码如下，来自 <a target="_blank" rel="noopener" href="https://github.com/netty/netty/blob/00a9a25f29cf07728794089affdd735af29209de/transport/src/main/java/io/netty/channel/AbstractChannelHandlerContext.java#L787">AbstractChannelHandlerContext.java</a>#write()。在执行写任务时，先判断了执行线程是否是该 Channel 绑定的线程，如果是则交由执行，如果不是则新增一个 <code>WriteTask</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">EventExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> next.executor();</span><br><span class="line"><span class="keyword">if</span> (executor.inEventLoop()) &#123;</span><br><span class="line">	<span class="keyword">if</span> (flush) &#123;</span><br><span class="line">		next.invokeWriteAndFlush(m, promise);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		next.invokeWrite(m, promise);</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="keyword">final</span> AbstractWriteTask task;</span><br><span class="line">	<span class="keyword">if</span> (flush) &#123;</span><br><span class="line">		task = WriteAndFlushTask.newInstance(next, m, promise);</span><br><span class="line">	&#125;  <span class="keyword">else</span> &#123;</span><br><span class="line">		task = WriteTask.newInstance(next, m, promise);</span><br><span class="line">		...</span><br><span class="line">		...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="Netty-3-中的不和谐"><a href="#Netty-3-中的不和谐" class="headerlink" title="Netty 3 中的不和谐"></a>Netty 3 中的不和谐</h3><p>这里需要注意一下，某个给定的 EventLoop 中的所有<em>事件</em>，都是由同一个线程处理。这是 Netty 4 对 Netty 3 的改进。在 Netty 3 中，出站事件可以由 I&#x2F;O 线程执行，也可以由调用线程执行，这就使得 Race Condition 成为可能，比如一个 Channel 上的 <code>Channel.write()</code> 被同时调用时。</p>
<p>官方 Wiki 上有一个 <a target="_blank" rel="noopener" href="https://github.com/netty/netty/wiki/Thread-model">Thread model 的页面</a>是针对 Netty 3 的过期信息，可以看看当时开发者对这个问题的考量。</p>
<h2 id="Bytebuf-源码"><a href="#Bytebuf-源码" class="headerlink" title="Bytebuf 源码"></a>Bytebuf 源码</h2><p><code>UnpooledHeapByteBuf</code> 基于 JVM 堆内存进行内存分配，每次使用，都从头创建一个新的 实例。性能：相比堆外内存的分配和释放，成本仍然更低一些。</p>
<p><code>UnpooledHeapByteBuf</code> 拥有三个成员变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ByteBufAllocator alloc;  <span class="comment">// 用于分配内存</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">byte</span>[] array;  <span class="comment">// 以数组作为缓冲区</span></span><br><span class="line"><span class="keyword">private</span> ByteBuffer tmpNioBuf;  <span class="comment">// ByteBuf 与 ByteBuffer 转换时使用</span></span><br></pre></td></tr></table></figure>

<p>注意这里为了<strong>提升性能与位操作</strong>，Netty 并没有直接使用原生的 ByteBuffer，而是使用数组作为缓存。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/02/10/Zookeeper/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jimmy Xu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
      <meta itemprop="description" content="Tu ne cede malis, sed contra audentior ito">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Rust Shrugged">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/02/10/Zookeeper/" class="post-title-link" itemprop="url">ZooKeeper：分布式过程协同技术详解 -- 读书笔记</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-02-10 05:13:07" itemprop="dateCreated datePublished" datetime="2023-02-10T05:13:07+00:00">2023-02-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ZooKeeper/" itemprop="url" rel="index"><span itemprop="name">ZooKeeper</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="ZooKeeper：分布式过程协同技术详解-–-读书笔记"><a href="#ZooKeeper：分布式过程协同技术详解-–-读书笔记" class="headerlink" title="ZooKeeper：分布式过程协同技术详解 – 读书笔记"></a>ZooKeeper：分布式过程协同技术详解 – 读书笔记</h1><blockquote>
<p>要点：第九章 Zab 协议、ZK 对写事务日志的优化。</p>
</blockquote>
<h2 id="Installation-amp-configuration"><a href="#Installation-amp-configuration" class="headerlink" title="Installation &amp; configuration"></a>Installation &amp; configuration</h2><p>Todo: <code>/tmp/zookeeper</code> –&gt; <code>/var/lib/zookeeper</code></p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><h4 id="chapter-2"><a href="#chapter-2" class="headerlink" title="chapter 2"></a>chapter 2</h4><p>types of <code>znode</code>:</p>
<ul>
<li>persistent, ephemeral, persistent_sequential, ephemeral_sequential；</li>
<li>持久节点、临时节点、持久有序节点、临时有序节点；</li>
<li>被创建为有序的节点被分配一个递增的整数，总而，形成了一个全局唯一的名字；</li>
<li>节点除了拥有名字（父节点名字 + 自身名字），还可以像文件夹一样，存有数据；</li>
</ul>
<p>通知</p>
<p>Zookeeper 中可以在节点上注册事件，而不需要轮询。事件可以包括 znode 数据的变化、子节点的变化、znode 的创建删除。</p>
<p>会话 session</p>
<p>客户端通过 TCP 与服务端通信。当此前会话无法继续（掉线，超过延迟时限），客户端的会话会被透明地转移到下一个服务器。</p>
<p>Zookeeper 保证，在同一个会话中的请求是以 FIFO 的顺序执行。但是如果客户端拥有多个并发的会话，则不保证。</p>
<p>会话状态</p>
<p>NOT_CONNECTED –&gt; CONNECTING &lt;&#x3D;&#x3D;&gt; CONNECTED –&gt; CLOSED</p>
<p>客户端不能声明自己的会话到期（timedout），但是可以显示关闭会话。</p>
<p>进阶：事务标识符 zkid 在客户端连接中的使用。</p>
<h5 id="端口"><a href="#端口" class="headerlink" title="端口"></a>端口</h5><p>Zookeeper 可以配置三种 TCP 端口。前两种是关于服务端的，第三种在 <code>zoo.cfg</code> 中称为  <code>clientPort</code>。一个仲裁模式（quorum）的配置示例如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tickTime</span>=<span class="string">2000</span></span><br><span class="line"><span class="attr">initLimit</span>=<span class="string">10</span></span><br><span class="line"><span class="attr">syncLimit</span>=<span class="string">5</span></span><br><span class="line"><span class="attr">dataDir</span>=<span class="string">./data</span></span><br><span class="line"><span class="attr">clientPort</span>=<span class="string">2181</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server.1</span>=<span class="string">127.0.0.1:2222:2223</span></span><br><span class="line"><span class="attr">server.2</span>=<span class="string">127.0.0.1:3333:3334</span></span><br><span class="line"><span class="attr">server.3</span>=<span class="string">127.0.0.1:4444:4445</span></span><br></pre></td></tr></table></figure>

<p>在对服务器的配置 <code>server.1=127.0.0.1:2222:2223</code> 中，第一个端口 <code>2222</code> 是<em>仲裁通信</em>，follower 通过这个端口来接受 leader 传达的更新指令；第二个端口用于 leader 选举。</p>
<h4 id="connectString"><a href="#connectString" class="headerlink" title="connectString"></a>connectString</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zookeeper/bin/zkCli.sh -server 127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183</span><br></pre></td></tr></table></figure>

<p>上面的 <code>127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183</code> 就是所谓连接字符串（connectString）。不仅在命令行的 <code>zkCli</code> 中使用，API 库也是同样的道理。连接字符串列出了本客户端可以连接的所有服务器。其中的端口，就是在各个 Zookeeper 服务器的 <code>zoo.cfg</code> 配置文件中的 <code>clientPort</code>。</p>
<h4 id="chap-3-使用-Zookeeper-API-库"><a href="#chap-3-使用-Zookeeper-API-库" class="headerlink" title="chap 3 使用 Zookeeper API 库"></a>chap 3 使用 Zookeeper API 库</h4><p>创建 Zookeeper 句柄（handle）；实现 Watcher、认识 Zookeeper 自动管理与服务端的断连；同步地创建节点 <code>zk.create(...)</code>；同步地获取 znode 中的数据 <code>byte[] getData(...)</code>、处理 <code>ConnectionLossException</code> ；异步创建节点、实践：异步创建元数据 path；<code>StatCallback</code>；</p>
<p>关于回调的注意：回调函数中的 <code>Object ctx</code> 在需要在回调中再次调用自身的场景中被使用到，如处理返回码为 <code>ConnectionLossException</code> 时，再次调用自身这个回调函数。</p>
<p>chap 4 Dealing with State Change</p>
<p>当一个监视点（watch）被一个事件（event）触发，就会产生一个通知（notification）。</p>
<p>在某些 ZooKeeper 的封装库（wrapper ）中，对 ConnectionLoss 的处理就是自动重新发送相应指令。某些情况这会带来大问题，比如通过 <code>create</code> 创建 <code>/master</code> 节点来获取领导权。如果客户端在 <code>create</code> 成功之后丢失连接，此时 wrapper 库自动重发指令，就会收到创建失败的响应，因为节点之前已经被创建好了。但是如果不知道这一细节，应用就会认为是其它节点已经创建了 master 节点获得了领导权。</p>
<h4 id="chap-9-原理"><a href="#chap-9-原理" class="headerlink" title="chap 9 原理"></a>chap 9 原理</h4><p>ZK 要求，新的 Quorum 数量的服务器中，必须有一台以上的机器是属于上一个群首的 Quorum。</p>
<p>ZK 服务器的分类方式：分为 Leader 和 Follower，或者分为 Participant 和 Observer。Observer 和 Follower 可以统称为 Learner，因为它们“学习”群首的指示。</p>
<p>对于 Follower 有两类广播：</p>
<ul>
<li><code>proposal</code>：包含有 transaction 的内容。</li>
<li><code>commit</code>：只包含 zxid。</li>
</ul>
<p>对于 Observer 只有一类：</p>
<ul>
<li><code>INFORM</code>：已被 commit 了的 proposal 的内容。</li>
</ul>
<h5 id="ZAB-协议"><a href="#ZAB-协议" class="headerlink" title="ZAB 协议"></a>ZAB 协议</h5><ul>
<li>两阶段提交：对于一个写请求操作，群首广播出一个 Proposal。对于这个 Proposal，追随者收到之后返回 ACK 消息，通知群首其已接收此 Proposal。在收到达到仲裁数量（群首自己也算在内）的服务器发送的 ACK 之后，群首发出 <code>commit</code> 的广播。</li>
<li>Zab 提供的顺序保障：<ul>
<li>如果群首按顺序广播了事务 <code>T1</code> 和 <code>T2</code>，那么每个服务器在 commit <code>T2</code> 之前保证 <code>T1</code> 已经被提交；</li>
<li>如果某个服务器按照 <code>T1</code> 、<code>T2</code> 的顺序提交事务，那么其它服务器也保证是按这个顺序提交的。</li>
</ul>
</li>
<li>epoch 时间戳：每次群首选举中递增 <code>1</code></li>
<li>Zab 提供的脑裂保障：<ul>
<li>新群首必须要确保所有之前的时间戳内需要提交的事务被全部提交完，然后才开始新的广播；</li>
<li>在任何时间点，都不会同时出现两个被仲裁数量支持的群首。</li>
</ul>
</li>
</ul>
<p>由于在选举群首时，选举上的是 <code>zxid</code> 最大的服务器，我们就不需要将最新状态从跟随服务器更新到群首服务器，因为群首就是代表最新状态；我们所需要的，就是直接发送更新到追随者。</p>
<h5 id="ZK-有效写入事务日志"><a href="#ZK-有效写入事务日志" class="headerlink" title="ZK 有效写入事务日志"></a>ZK 有效写入事务日志</h5><p>ZK 如何有效写入事务日志：写事务日志是写请求操作的关键，ZK 用了两种方式来优化：1）组团提交 2）预先填充（padding）。</p>
<p>实际上，对于组团提交，就是在需要 flush 到磁盘（来保证事务已被持久化）时，把所有队列中的事务都<em>顺带</em> flush 到磁盘。注意，ZK 服务器只有在事务已经写入日志之后才会确认对应的 Proposal，也就是在确认事务之前，该事务已经被持久化到磁盘了。为了保证在 <code>commit</code> 方法返回后写入的数据已经存在于磁盘（而不是操作系统的写缓冲区），磁盘写缓存必须被关闭。</p>
<p><strong>预先填充（padding）</strong>是指预先为日志文件分配多余的磁盘块。在 Linux 系统中，一个文件中的数据储存在一个个分配给它的块（block）中。当向文件中写入时，如果当前分配的磁盘块用尽了，就要花时间请求分配新的磁盘块。这种请求需要修改该文件所对应的元数据，因此预先分配就会减少这一次磁盘寻道。</p>
<h5 id="会话"><a href="#会话" class="headerlink" title="会话"></a>会话</h5><p>Standalone 模式下的单独服务器与仲裁模式（Quorum）下的群首服务器负责跟踪<em>所有会话</em>。追随者只是将客户端的会话信息转发给群首。</p>
<h5 id="监视点"><a href="#监视点" class="headerlink" title="监视点"></a>监视点</h5><p>服务端不会持久化监视点，因此监视点的数据在<em>客户端</em>保存。在掉线重连之后，客户端将监视点的信息同步到服务端</p>
<h3 id="机翻问题。。"><a href="#机翻问题。。" class="headerlink" title="机翻问题。。"></a>机翻问题。。</h3><p>机翻</p>
<p>P58：</p>
<p>异步方法调用会简单化队列对 Zookeeper 服务器的请求，并在另一个线程中传输请求。</p>
<p>当接收到响应信息，这些请求就会在一个专用回调线程中被处理。</p>
<p>为了保持顺序，只会有一个单独的线程按照接收顺序处理响应包</p>
<p>原文：</p>
<p>The asynchronous method simply queues the request to the ZooKeeper server. Transmission happens on another thread. When responses are received, they are processed on a dedicated callback thread. To preserve order, there is a single callback thread and responses are processed in the order they are received.</p>
<p>我认为好的翻译：</p>
<p>这个异步方法只是简单地把请求加入 ZooKeeper 服务器的请求队列中。传输请求的任务由另一个线程完成。</p>
<p>收到响应之后，<strong>响应</strong>由一个专门的回调线程处理。</p>
<p>为了保证顺序，只会有一个单独的回调线程，按照接收到的顺序处理响应。</p>
<p>Returns the result of the call：返回调用的结构。</p>
<h3 id="关于-InterruptedException"><a href="#关于-InterruptedException" class="headerlink" title="关于 InterruptedException"></a>关于 <code>InterruptedException</code></h3><p>使用 ZK 的 API 库时会遇到不少的方法，抛出 <code>InterruptedException</code>。作者在书中也表示很无奈，没有一劳永逸的解决办法，还是要取决于具体状况，来决定是让这个异常沿着调用栈上浮，还是其它办法：</p>
<blockquote>
<p>In our example, we simply pass the InterruptedException to the caller and thus let it bubble up. Unfortunately, in Java there aren’t clear guidelines for how to deal with thread interruption, or even what it means. Sometimes the interruptions are used to signal threads that things are being shut down and they need to clean up. In other cases, an interruption is used to get control of a thread, but execution of the application continues.<br>Our handling of InterruptedException depends on our context. If the InterruptedException will bubble up and eventually close our zk handle, we can let it go up the stack and everything will get cleaned up when the handle is closed. If the zk handle is not closed, we need to figure out if we are the master before rethrowing the exception or asynchronously continuing the operation. This latter case is particularly tricky and requires careful design to handle properly.</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/02/10/java.io%20%E6%A2%B3%E7%90%86%E4%B8%8E%E5%85%B6%E4%B8%AD%E7%9A%84%E4%B8%89%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jimmy Xu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
      <meta itemprop="description" content="Tu ne cede malis, sed contra audentior ito">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Rust Shrugged">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/02/10/java.io%20%E6%A2%B3%E7%90%86%E4%B8%8E%E5%85%B6%E4%B8%AD%E7%9A%84%E4%B8%89%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">java.io 梳理与其中的三种设计模式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-02-10 05:13:07" itemprop="dateCreated datePublished" datetime="2023-02-10T05:13:07+00:00">2023-02-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Design-Patterns/" itemprop="url" rel="index"><span itemprop="name">Design Patterns</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="java-io-梳理与其中的三种设计模式"><a href="#java-io-梳理与其中的三种设计模式" class="headerlink" title="java.io 梳理与其中的三种设计模式"></a>java.io 梳理与其中的三种设计模式</h1><p>以 <code>Reader</code> 抽象类下的类为例。它们的主要构造函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FilterReader(Reader)</span><br><span class="line">BufferedReader(Reader)</span><br><span class="line"></span><br><span class="line">FileReader(File)</span><br><span class="line">StringReader(String)</span><br><span class="line">InputStreamReader(InputStream [, Charset])</span><br></pre></td></tr></table></figure>

<p><img src="/content/images/2019/ReaderUML.png" alt="Reader UML"></p>
<p>大致上，<code>java.io</code> 可以分为：</p>
<ol>
<li>字节流操作：<code>InputStream</code>、<code>OutputStream</code></li>
<li>字符操作：<code>Reader</code>、<code>Writer</code></li>
<li>针对磁盘操作：<code>File</code></li>
</ol>
<h2 id="适配器模式-Adapter-pattern"><a href="#适配器模式-Adapter-pattern" class="headerlink" title="适配器模式 Adapter pattern"></a>适配器模式 Adapter pattern</h2><p><code>InputStreamReader</code> 是字节流与字符流之间的桥梁，它的实现使用了适配器模式。适配器模式通过聚合将某个接口适配成为另一个接口来方便使用，类图如下：</p>
<p><img src="/content/images/2019/InputStreamReaderAdapterPattern.png" alt="InputStreamReader Adapter Pattern"></p>
<p>在开头的代码可以看到，<code>InputStreamReader</code> 的构造器需要传入一个字节流 <code>InputSream</code>，以及可选的字符集。如果没有传入字符集就会使用默认的。通过持有一个 <code>InputStream</code>，<code>InputStreamReader</code> 拥有了该接口的功能。同时，<code>InputStreamReader</code> 还是一个实现了 <code>Reader</code> 类，这样一来它就把 <code>InputStream</code> 适配成了一个 <code>Reader</code> 类。</p>
<h2 id="装饰器模式-Decorator-pattern"><a href="#装饰器模式-Decorator-pattern" class="headerlink" title="装饰器模式 Decorator pattern"></a>装饰器模式 Decorator pattern</h2><p>这个应该是 <code>java.io</code> 更为人熟知的，装饰器模式与适配器模式都可以看作包装模式 Wrapper。通过对类的层层包裹，装饰器模式增强了目标类的功能。类图示意如下：</p>
<p><img src="/content/images/2019/IODecoratorPattern.png" alt="IO Decorator Pattern"></p>
<p><code>Decorator</code> 是 <code>Component</code> 的实现类，但是其内部也持有一个 <code>Decorator</code> 类。不同的 <code>Decorator</code> 类下的 <code>ConcreteDecorator</code> 子类包含了需要增强的功能。</p>
<p>在 <code>java.io</code> 中的典型使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FilterReader</span> <span class="variable">pbr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PushbackReader</span>(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(System.in)))</span><br></pre></td></tr></table></figure>

<h3 id="二者的不同"><a href="#二者的不同" class="headerlink" title="二者的不同"></a>二者的不同</h3><p>装饰器模式更多的是对目标类的功能上的增强；适配器没有对功能进行增进，只是为了使目标类能适应调用方的接口，方便被调用。</p>
<h2 id="模板方法"><a href="#模板方法" class="headerlink" title="模板方法"></a>模板方法</h2><p>在模板方法模式中，大的算法框架在抽象父类中被定义好，某些业务相关的实现则延迟到子类。</p>
<p>在 <code>Reader</code> 抽象类中，<code>read</code> 方法的默认实现都留给了被重载的 <code>read(char[], int, int)</code>，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">read</span><span class="params">()</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">read</span><span class="params">(<span class="type">char</span>[] cbuf)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="type">int</span> <span class="title function_">read</span><span class="params">(<span class="type">char</span>[] cbuf, <span class="type">int</span> offset, <span class="type">int</span> len)</span></span><br></pre></td></tr></table></figure>

<p>具体的 <code>read</code> 的实现留给子类。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/02/10/tiny-spring%20%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95%EF%BC%88%E4%B8%80%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jimmy Xu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
      <meta itemprop="description" content="Tu ne cede malis, sed contra audentior ito">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Rust Shrugged">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/02/10/tiny-spring%20%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95%EF%BC%88%E4%B8%80%EF%BC%89/" class="post-title-link" itemprop="url">tiny-spring 踩坑记录（一）可变长泛型参数与堆污染</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-02-10 05:13:07" itemprop="dateCreated datePublished" datetime="2023-02-10T05:13:07+00:00">2023-02-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="可变长泛型参数与堆污染"><a href="#可变长泛型参数与堆污染" class="headerlink" title="可变长泛型参数与堆污染"></a>可变长泛型参数与堆污染</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><blockquote>
<p>什么是堆污染</p>
</blockquote>
<p>一个类型为泛型 <code>T</code> 的变量被指向一个类型不是 <code>T</code> 的对象，这就是堆污染。典型的情况是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;T&gt; listOfTs = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(Arrays.asList(t));</span><br><span class="line">List&lt;E&gt; listOfEs = (List&lt;E&gt;)(Object)listOfTs; <span class="comment">// 此时指向了含有 T 的 List, 但是不会抛出异常，只是在 Object -&gt; List&lt;E&gt; 的转型中抛出警告</span></span><br><span class="line"></span><br><span class="line"><span class="type">E</span> <span class="variable">e</span> <span class="operator">=</span> listOfEs.get(<span class="number">0</span>);  <span class="comment">// 运行时错误，java.lang.ClassCastException</span></span><br></pre></td></tr></table></figure>

<p>之所以编译器无法在转型时检查出类型转换错误，是因为 Java 泛型是通过类型擦除实现的，在泛型代码内部无法获得任何有关泛型参数类型的信息。</p>
<p>一个更好一点的关于可变长泛型参数和堆污染一起的例子，来自 <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/tutorial/java/generics/nonReifiableVarargsType.html">Oracle 官方文档</a>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">faultyMethod</span><span class="params">(List&lt;String&gt;... l)</span> &#123;</span><br><span class="line">    Object[] objectArray = l;     <span class="comment">// Valid</span></span><br><span class="line">    objectArray[<span class="number">0</span>] = Arrays.asList(<span class="number">42</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> l[<span class="number">0</span>].get(<span class="number">0</span>);       <span class="comment">// ClassCastException thrown here</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关于泛型的<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/tutorial/java/generics/restrictions.html">几大限制</a>中，最明显的一个就是不能创造泛型数组，如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt;[] arrayOfLists = <span class="keyword">new</span> <span class="title class_">List</span>&lt;Integer&gt;[<span class="number">2</span>];  <span class="comment">// compile-time error</span></span><br></pre></td></tr></table></figure>

<p>但是这一限制在可变长的泛型参数中被打破了。在可变长参数中，一个数组会在函数调用时建立（Effective Java，Item 53），每次调用都会引起一次数组分配和初始化。当可变长参数是泛型时，一个泛型数组就被创造出来了。</p>
<h3 id="实操时的问题"><a href="#实操时的问题" class="headerlink" title="实操时的问题"></a>实操时的问题</h3><p>我在 tiny-spring 中写了一个方法，给定注解参数，获取所有带有该注解的类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getClassSetByAnnotation(Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt;... cls) &#123;</span><br><span class="line">    Set&lt;Class&lt;?&gt;&gt; classSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; c : getClassSet(basePkg)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; annotationCls : cls) &#123;</span><br><span class="line">            <span class="keyword">if</span> (c.isAnnotationPresent(annotationCls)) &#123;</span><br><span class="line">                classSet.add(c);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> classSet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里就出现了一个可变长泛型参数的问题。另一个隐藏的问题是，这个方法并没有对传入的注解参数的数量检查参数为零的情况，而可变长参数允许传入零个参数。一个优美一点的解决方案是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SafeVarargs</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getClassSetByAnnotation(Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; firstCls, Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt;... cls) &#123;</span><br><span class="line">    Set&lt;Class&lt;?&gt;&gt; classSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; c : getClassSet(basePkg)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (c.isAnnotationPresent(firstCls)) &#123;</span><br><span class="line">            classSet.add(c);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; annotationCls : cls) &#123;</span><br><span class="line">            <span class="keyword">if</span> (c.isAnnotationPresent(annotationCls)) &#123;</span><br><span class="line">                classSet.add(c);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> classSet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样既省去明显的检查参数数量，又能在调用处强制调用者传入至少一个参数，这也是这个方法的本意。</p>
<h3 id="SafeVarargs-的使用标准"><a href="#SafeVarargs-的使用标准" class="headerlink" title="@SafeVarargs 的使用标准"></a>@SafeVarargs 的使用标准</h3><p>如上所见，可以将报警用 <code>@SafeVarargs</code> 注解掉。但是我们知道，这个注解仅仅是消除编译警告，完全不能保证消除这个错误。那么什么时候应该使用这个注解呢？</p>
<p>在 StackOverflow 有一个票的<a target="_blank" rel="noopener" href="https://stackoverflow.com/a/14252221">回答</a>：</p>
<p>If your method has an argument of type <code>T...</code> (where T is any type parameter), then:</p>
<ul>
<li>Safe: If your method only depends on the fact that the elements of the array are instances of <code>T</code></li>
<li>Unsafe: If it depends on the fact that the array is an instance of <code>T[]</code></li>
</ul>
<p>Effective Java 也表示了类似的意思：如果你的方法使用可变长泛型参数的时候，只是用来一次传入多个参数，并且实际使用的时候只是把它们当作多个参数来看，那么就没有问题。如果你的方法体中把可变长参数当作数组来使用，那就会有问题，不要使用这个注解。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/03/16/Netty%20Test%20Practice%20Report_Complete/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jimmy Xu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
      <meta itemprop="description" content="Tu ne cede malis, sed contra audentior ito">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Rust Shrugged">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/16/Netty%20Test%20Practice%20Report_Complete/" class="post-title-link" itemprop="url">Netty Test Practice Report</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-16 13:56:00" itemprop="dateCreated datePublished" datetime="2022-03-16T13:56:00+00:00">2022-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Netty/" itemprop="url" rel="index"><span itemprop="name">Netty</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Netty-Test-Practice-Report"><a href="#Netty-Test-Practice-Report" class="headerlink" title="Netty Test Practice Report"></a>Netty Test Practice Report</h1><p>[TOC]</p>
<h2 id="Introduction-of-Netty"><a href="#Introduction-of-Netty" class="headerlink" title="Introduction of Netty"></a>Introduction of Netty</h2><p>Netty is a high-performance network application framework with asynchronous event-driven APIs that enables developers to focus on business logic, instead of low level details like synchronization, manual management of <code>ByteBuffer</code>. Simply put, Netty &gt; java.nio + java.net.</p>
<h3 id="Netty-vs-java-net-async-and-event-driven"><a href="#Netty-vs-java-net-async-and-event-driven" class="headerlink" title="Netty vs java.net: async and event-driven"></a>Netty vs java.net: async and event-driven</h3><p>By leveraging callbacks, Netty implements a event model for network communication. User can register listeners to events and operations, and get async notification of the completion status of those registered handlers.</p>
<p>Also, Netty eliminates the need for tedious synchronization by allowing only one thread to handle all the I&#x2F;O operations and events within a <code>EventLoop</code>.</p>
<p>Those coming from other programming languages like JavaScript would find this practice very similar to async frameworks like Koa: accessing a global <code>ctx</code> from self-defined callbacks, and then easily attach them to different places.</p>
<h3 id="Netty-vs-java-nio-ByteBuffer-for-everyone"><a href="#Netty-vs-java-nio-ByteBuffer-for-everyone" class="headerlink" title="Netty vs java.nio: ByteBuffer for everyone"></a>Netty vs java.nio: ByteBuffer for everyone</h3><p>Comparing JDK’s <code>ByteBuffer</code> to Netty’s <code>Bytebuf</code>, Netty mainly improved two issues: API friendliness and performance.</p>
<ul>
<li>No ease of use: <ul>
<li>once it’s instantiated, its capacity cannot be extended; </li>
<li>only one index for both reading and writing;</li>
<li>no <code>forEach</code>, user has to do bound checking every time.</li>
</ul>
</li>
<li>Performance and GC overhead<ul>
<li>writing a heap-based <code>ByteBuffer</code> requires copying the memory to direct buffer before passing it to JNI</li>
<li>Netty manages direct buffer <em>directly</em>.</li>
<li>Netty uses reference counting for more real-time efficient GC</li>
</ul>
</li>
</ul>
<h3 id="Beyond-nio-and-net-Extensibility"><a href="#Beyond-nio-and-net-Extensibility" class="headerlink" title="Beyond nio and net: Extensibility"></a>Beyond nio and net: Extensibility</h3><p>Separate of concerns: Using React model, Netty guides developers to separate business logic from the implementation of the application. </p>
<p>Netty also has built-in support for self-defined protocol application development.</p>
<p>Netty has extensive support for application layer protocols including UDP, TCP, HTTP(S), and even self defined ones. User could also attach the serialization library they like (e.g. Protobuf, Thrift).</p>
<h3 id="Project-statistics"><a href="#Project-statistics" class="headerlink" title="Project statistics"></a>Project statistics</h3><p>Lines of Java code: <code>481,008</code>. Get the LOC using below command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git ls-files | grep -E <span class="string">&#x27;.java&#x27;</span> | xargs <span class="built_in">wc</span> -l</span><br></pre></td></tr></table></figure>

<p>On GitHub there are currently 28.5k stars and 14.1k forks. The project is still under active development.</p>
<h2 id="Building-the-project"><a href="#Building-the-project" class="headerlink" title="Building the project"></a>Building the project</h2><p>It requires JDK 8 and Maven 3.8.1 or below to build. Run <code>mvn package</code> to compile the jar file. Skip the test using <code>mvn package -Dmaven.test.skip</code>. If you experience errors with <code>checkstyle</code>, you could also skip it using the <code>-Dcheckstyle.skip</code> option. Replace those options by <code>-D&quot;[option]&quot;=true</code> when using Windows PowerShell.</p>
<p>As a framework that deals with OS-level I&#x2F;O, it provides additional artifact on Unix platform so that user can gain better performance and GC comparing to the NIO transport provided by JDK. Take Linux as an example,  add <code>netty-transport-native-epoll</code> to the dependencies of <code>pom</code> file. Then user could use these features by simply importing the respective special classes if they already have the corresponding JAR file.</p>
<h2 id="Existing-test-cases"><a href="#Existing-test-cases" class="headerlink" title="Existing test cases"></a>Existing test cases</h2><p>Netty uses JUnit5 for testing, Mockito for mocking. During daily development, user can use a special class <code>EmbeddedChannel</code> to mock a Netty connection for testing.</p>
<p>Unit tests are written inside each package. Due to the large amount of test cases, sometimes abstract test classes are created to define common methods to test.</p>
<h2 id="Test-suites-analysis-in-terms-of-functional-testing-and-partition-testing"><a href="#Test-suites-analysis-in-terms-of-functional-testing-and-partition-testing" class="headerlink" title="Test suites analysis in terms of functional testing and partition testing"></a>Test suites analysis in terms of functional testing and partition testing</h2><p>As a type of black-box testing, functional testing derives test cases from the software’s specifications. The whole process involves identifying independently testable features, and then find relevant inputs based on such features. Finally, test cases specifications are formed. Since test writer doesn’t have to know any internal structure or implementation of the software, it could result in reduced developer bias.</p>
<p>After specifications are broken into minimum testable features, the representative values and behaviors for a certain feature becomes clear. Failures are distributed unevenly in the whole possible inputs, so partitioning makes it easier to catch the failures by properly dividing the input space.</p>
<p>There are numerous packages and modules in Netty. Among them, the most important packages are <code>buffer</code>, <code>handler</code>, <code>channel</code>. </p>
<h3 id="Partition-example-reference-counting-feature"><a href="#Partition-example-reference-counting-feature" class="headerlink" title="Partition example: reference counting feature"></a>Partition example: reference counting feature</h3><p>Let’s take the byte buff reference count feature as an example. The life cycle of certain objects are managed by their reference counts, so that Netty can return them (or their shared resources) to an object pool as soon as it is not used anymore, improving the allocation and deallocation performance.</p>
<p>It would be helpful to re-iterate the specification of this feature:</p>
<ul>
<li>the initial reference count of a reference-counted object is 1</li>
<li>when <code>release()</code>, the reference count is decreased by 1</li>
<li>when the reference count reaches 0, the reference-counted object is deallocated or returned to the object pool</li>
<li>when the reference-counted object is deallocated, it cannot be accessed again</li>
<li>buffers <em>derived</em> from a buffer share the reference count of that parent buffer</li>
</ul>
<p>My partition for it would be:</p>
<ul>
<li>newly created <code>bytebuf</code> object (reference count: 1)</li>
<li><code>bytebuf</code> object that’s being used in several places (reference count &gt; 1)</li>
<li><code>bytebuf</code> object whose reference count is 0</li>
<li><code>bytebuf</code> object derived from newly created <code>bytebuf</code> </li>
<li><code>bytebuf</code> object derived from object with reference count more than 1</li>
<li>derive a <code>bytebuf</code> object from a deallocated <code>bytebuf</code></li>
</ul>
<h4 id="JUnit-cases-for-this-example"><a href="#JUnit-cases-for-this-example" class="headerlink" title="JUnit cases for this example"></a>JUnit cases for this example</h4><p>The test cases for above situations would be inside a new mode named swe261.</p>
<h1 id="Netty-Test-Practice-Report-Chapter-2"><a href="#Netty-Test-Practice-Report-Chapter-2" class="headerlink" title="Netty Test Practice Report - Chapter 2"></a>Netty Test Practice Report - Chapter 2</h1><h2 id="Why-finite-model"><a href="#Why-finite-model" class="headerlink" title="Why finite model"></a>Why finite model</h2><p>In short, finite model is a representation of the software artifact being described. Due to its properties of being <em>compact</em> and <em>predictive</em>, it can first reiterate the specifications, facilitating better understanding of it[^1]. Secondly, by describing the essential possible executions and state transitions of the software, a finite model could shed light on the problem of “what to test”, and make edge cases more obvious. Finally, since a finite model depicts the transitions of software, it can serve as a visual aid of code coverage, and show the number of cases having been covered.</p>
<h2 id="Functional-model-example-Netty’s-event-based-data-processing-components"><a href="#Functional-model-example-Netty’s-event-based-data-processing-components" class="headerlink" title="Functional model example: Netty’s event-based data processing components"></a>Functional model example: Netty’s event-based data processing components</h2><p>Network programming can be ideally modeled via event-driven architecture.</p>
<blockquote>
<p>With an event-driven system, the capture, communication, processing, and persistence of events are the core structure of the solution.[^2]</p>
</blockquote>
<p>This article chooses Netty’s event-based data processing components as an exemplar of finite model. The nature of events that occur during network communication suits the needs well. First of all, it would be useful to have some preliminary introduction of Netty’s event-based before diving into the testing of the events within it.</p>
<p>Basically, the abstraction of such event model is based on three core classes, <code>Channel</code>, <code>ChannelPipeline</code>, and <code>ChannelHandler</code> [^3].  <code>ChannelPipeline</code> is the container of a set of <code>ChannelHandlers</code>, and a <code>ChannelPipeline</code> is permanently  bounded to only one <code>Channel</code> in its life time, and vice versa.</p>
<p>![Relationship between the Three Classes](C:\Users\57364\Pictures\Saved Pictures\屏幕截图 2022-02-17 152004.png)</p>
<p><code>Channel</code> could be roughly thought of as the <code>Socket</code> class in Java’s network programming interface, but with more simpler APIs. In Netty it defines four basic states: <code>ChannelUnregistered</code>, <code>ChannelRegistered</code>, <code>ChannelActive</code>, <code>ChannelInactive</code>. Its status model is as below:</p>
<p><img src="/content/images/2022/image-20220217154452797.png" alt="Channel Status Model"></p>
<p><code>ChannelHandler</code> is the main component of Netty, from an application developer’s point of view.[^3] It serves as  a container to store all application logics that are to be applied on the inbound and outbound data. Below are the inbound methods that will be called when status of the <code>Channel</code> instance it’s registered is changed.</p>
<p><img src="/content/images/2022/image-20220217154953918.png" alt="ChannelHandler Events"></p>
<p>Respectively, as its container, <code>ChannelPipeline</code>‘s API publishes events:</p>
<p><img src="/content/images/2022/image-20220217155708587.png" alt="ChannelPipeline Events "></p>
<p>In conclusion, as the network data flows, events can be triggered by OS (read and write complete, bind successful), or in special cases be fired manually. Events can be passed on to the next handler along the pipeline, or to all succeeding handlers.</p>
<h3 id="Finite-state-machine-for-the-inbound-components"><a href="#Finite-state-machine-for-the-inbound-components" class="headerlink" title="Finite state machine for the inbound components"></a>Finite state machine for the inbound components</h3><p>Below is the illustration of the FSM. The high definition version of the illustration can be found in the GitHub repo with the name <code>finiste_state_machine.png</code>. To make the model more compact for understanding and practical uses, here we only look into the inbound components.</p>
<p><img src="/content/images/2022/finiste_state_machine.png" alt="FSM for the components"></p>
<p>Overall, flow of changes starts from <code>channel</code>, passes through <code>pipeline</code>, and ends at <code>handler</code>. There are two major kinds of events: state changes and data events. When a channel is (in)active, or when it’s registered to a <code>EventLoop</code>, it initiates state changes that will be forwarded to all handlers in the pipeline. Pipeline could also pragmatically fire such events. As the main component that application programmer will deal with, handler could have some code relating to such events for some preparation tasks like connecting to respective databases.</p>
<p>Comparing to state changes, data events (blue lines in the illustration) also forward to all handlers added to the pipeline, but there’s a fundamental difference: the inbound <em>data</em>. The inbound data will be forwarded to all handlers, one by one, along with the data events (read&#x2F;write). Therefore, although all handlers receive data events, but subsequent handlers only get inbound data from the previous handlers, whether the data is modified or not by their precursors. In the end, the data flows to the end of pipeline, which signifies the end of processing for this data. Such flow of data makes it possible for processing the data in a organized and controllable way. For example, it enables easy implementation of self-defined encoders&#x2F;decoders and serializer &#x2F; deserializer. All the programmer has to do is writing them as normal handlers, but only putting them at the appropriate position, usually the start or end of the pipeline. Netty provides pre-defined boilerplate classes like <code>ByteToMessageDecoder</code> for such needs.</p>
<p>While such data flow model seem to have addressed all possible problems for consuming inbound data, Netty also provides a finer-granite control: <code>ChannelHandlerContext</code>. A <code>ChannelHandlerContext</code> is created whenever a handler is added to a pipeline, and will stick to the handler during its life cycle. A context can have only one handler, but a handler can be added to multiple pipelines, and thus having multiple contexts. <code>ChannelHandlerContext</code> has many methods that also exist in <code>Channel</code> and <code>ChannelPipeline</code>, but when it triggers events, the event only propagate to the next handler that can handle the event. This mechanism has at least two advantages because it:</p>
<ol>
<li>eliminates the overhead of dealing with events (data) that a handler doesn’t need;</li>
<li>avoids forwarding events to the wrong handlers.</li>
</ol>
<p><code>ChannelHandlerContext</code> represents the interaction between two handlers in a pipeline. That’s why in the illustration,  the arrows between contexts also end between contexts; while arrows from pipeline would dispatch the event to every handler and continue all the way to the end. In addition to receiving read &#x2F; read complete events from the respective context, handler could also fire such event, and forward it to the next handler through the use of context. Therefore the arrows are bidirectional.</p>
<p>There is a third type of event: exception, as the red lines in the illustration shows. Exception could occur in any handler during execution. The exception event would propagate through the pipeline of handlers too, but only those the implements the <code>exceptionCaught</code> method could catch and end the exception propagation. The best practice is to always have at least one handler at the end of pipeline that implements the exception logic.</p>
<h2 id="Test-suites-for-this-functional-model"><a href="#Test-suites-for-this-functional-model" class="headerlink" title="Test suites for this functional model"></a>Test suites for this functional model</h2><p>Basically there are three types of test suites to write, corresponding to the three types of events: channel events, handler events, and context events. Here we use <code>Spy</code> in Mockito to test if certain methods are called. The <code>ChannelPipeline</code> class cannot be spied, because it’s a final class.</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/03/16-01-16-05-%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202022-03-16%20011445.png"></p>
<p>With Mockito’s <code>Spy</code> function, testing is made a lot easier. Simply several lines could prove that certain methods are called. Those methods could only be triggered due to state changes, so our functional model could be verified.</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/03/16-01-20-20-%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202022-03-16%20011632.png"></p>
<p>In above code, channel events and handler events are tested. The pipeline event and context event is a little tricky, because it involves simulating real-world network communication. Luckily, Netty provides us with <code>EmbeddedChannel</code> class to conveniently set up unit tests.</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/03/16-01-26-49-embedded_channel.png"></p>
<p>The <code>writeInboud</code> method writes data into the channel directly.</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p>[^1]: Mauro Pezze, Michal Young. Testing and Analysis, 2nd Edition<br>Red Hat. Event-Driven Architecture, <a target="_blank" rel="noopener" href="https://www.redhat.com/en/topics/integration/what-is-event-driven-architecture">https://www.redhat.com/en/topics/integration/what-is-event-driven-architecture</a><br>Norman Maurer, Marvin Allen Wolfthal. Netty in Action</p>
<h1 id="Netty-Test-Practice-Report-Chapter-3"><a href="#Netty-Test-Practice-Report-Chapter-3" class="headerlink" title="Netty Test Practice Report - Chapter 3"></a>Netty Test Practice Report - Chapter 3</h1><h2 id="Why-structural-testing"><a href="#Why-structural-testing" class="headerlink" title="Why structural testing"></a>Why structural testing</h2><p>Structural testing, also known as white-box testing, is a way of software testing that mainly utilizes the information of a program’s internal structure to design and evaluate test cases. It judges test case thoroughness based on the structure of program itself. </p>
<p>Comparing to specification-based testing, some faults can only be revealed by structural testing.  Such faults are often implementation-specific; they are implementation choices made by the programmer that are hardly described by the specifications, like what data structure to use, what SQL statement to execute.  Such faults could also be unintentional: memory leak, thread safety, etc.</p>
<p>However, structural testing has drawbacks, too. Even if test cases are thorough from the view of structural testing, it couldn’t guarantee revealing all faults. Covering all control flow elements doesn’t ensure the covering of all possible buggy inputs.</p>
<p>In addition to fault detection, structural testing serves as an indicator of  test case thoroughness. For example, the statement coverage criterion requires each statement<br>to be executed at least once[^1]. Although executing every control flow structure provides no guarantee, a statement never executed &#x2F; tested is definitely not acceptable.</p>
<h2 id="Test-adequacy-report-on-netty-buffer-module"><a href="#Test-adequacy-report-on-netty-buffer-module" class="headerlink" title="Test adequacy report on netty-buffer module"></a>Test adequacy report on netty-buffer module</h2><p>As a large, well-developed multimodule project, Netty contains as many as tens of thousands of test cases. It would be practical and insightful to start analysis from a single module first.</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/02/22-19-37-15-%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202022-02-22%20193642.png" alt="The number of test cases in a single module"></p>
<h3 id="Configuration-for-collecting-test-coverage-data"><a href="#Configuration-for-collecting-test-coverage-data" class="headerlink" title="Configuration for collecting test coverage data"></a>Configuration for collecting test coverage data</h3><p>Intellij Ultimate comes bundled with coverage plugin, but there’re several configurations needed. By default, it doesn’t collect branch level coverage, so we need to enable it by checking <em>use tracing</em> option. As with netty, there exist many micro-benchmarks for every module. These benchmarks have nothing to do with testing, and are extremely time-consuming, so a <em>pattern</em> is applied to exclude all tests with a name ending with “benchmark”: <code>^(?!.*Benchmark.*).*$</code>. Also it turns out that the <em>collect coverage in test folders</em> option is misleading, and would pollute the generated coverage report by collecting test adequacy data for test classes, which certainly would have zero coverage.</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/02/23-04-57-14-%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202022-02-23%20045702.png"></p>
<h3 id="Test-coverage-statistics"><a href="#Test-coverage-statistics" class="headerlink" title="Test coverage statistics"></a>Test coverage statistics</h3><p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/02/23-05-00-05-%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202022-02-23%20050000.png"><br>Overall, module <code>netty.buffer</code> is tested well with the majority (75%) of methods and lines being covered. </p>
<h4 id="Line-and-branch-level-coverage"><a href="#Line-and-branch-level-coverage" class="headerlink" title="Line and branch level coverage"></a>Line and branch level coverage</h4><p>Among the 9128 lines of code, 6766 of them are covered. The uncovered lines often appear to be branches that are not covered; for example, exception statements, as shown below:</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/02/23-05-19-22-%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202022-02-23%20051716.png"><br>Or just simply untested edge cases:</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/02/23-06-17-21-uncovered%20branches.png"></p>
<p>in addition to the common if-else statements, another type of untested branch is <code>switch</code> syntax:</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/02/23-06-32-04-branch_switch%20statement.png"></p>
<p>Except for the above reasons, there’re also rare cases, like <code>@Deprecated</code> APIs that are to some degree intentionally not thoroughly tested :</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/02/23-06-03-00-deprecated.png"></p>
<p>Or untested field of <code>interface</code>:</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/02/23-06-13-01-2022-02-23-06-11-17-image.png"></p>
<h4 id="Method-level-coverage"><a href="#Method-level-coverage" class="headerlink" title="Method level coverage"></a>Method level coverage</h4><p>But some uncovered lines have no special reasons: they are just not tested as a whole. This should be categorized as method level coverage.</p>
<p>One of the most common properties of the untested methods are <code>protected</code> modifier.</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/02/23-05-40-08-uncovered%20lines_protected%20methods.png"></p>
<p>In the above screenshot, class <code>AbstractUnpooledSlicedByteBuf</code> is an abstract class that also extends from another abstract class. We can see that many of its overridden protected methods that are inherited from the upper abstract class are not tested. Such lack of method coverage is somehow reasonable, since those APIs are not supposed to be exposed, as long as their <code>public</code> counterparts are tested, they are guaranteed to work.</p>
<p>But some uncovered lines have no special reasons: they are just not tested due to lack of resource.</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/02/23-06-19-49-uncovered%20method.png"></p>
<h2 id="Improving-test-coverage-of-netty-buffer"><a href="#Improving-test-coverage-of-netty-buffer" class="headerlink" title="Improving test coverage of netty-buffer"></a>Improving test coverage of netty-buffer</h2><ul>
<li><p>Document the coverage before and after</p>
</li>
<li><p>describe the code being covered; describe the functionality being tested&#x2F;covered</p>
</li>
</ul>
<p>Thanks to analysis above, it becomes obvious what test cases should be written in order to increase coverage. Some test cases I designed would:</p>
<ol>
<li><p>cover exception handling like in <code>UnpooledDirectByteBuf</code>:79;</p>
</li>
<li><p>visit uncovered branches like the <code>switch</code> in the array function of <code>FixedCompositeByteBuf</code>, and in <code>Unpooled</code>:907;</p>
</li>
<li><p>cover <code>Unpooled#copiedBuffer</code> method, line 633.</p>
</li>
<li><p>cover the <code>readBytes</code> and <code>setBytes</code> method for different channels.</p>
</li>
</ol>
<h3 id="Added-test-cases"><a href="#Added-test-cases" class="headerlink" title="Added test cases"></a>Added test cases</h3><p>In <code>UnpooledByteBufAllocatorTest</code>, different constructor arguments are tested, especially the illegal ones, to ensure that the exception handling for them is working.</p>
<p>On a broader scale, test cases of the <code>readBytes</code> and <code>setBytes</code>  methods using <code>ScatteringByteChannel</code> and <code>GatheringByteChannel</code> are added, for all subclasses of <code>AbstractByteBuf</code> class. This could be achieved thanks to Netty’s well-structured class hierarchy of test cases. Adding a test case in the <code>AbstractByteBufTest</code> would result in all its child test classes reusing the case.</p>
<h3 id="Outcomes-of-newly-added-test-cases"><a href="#Outcomes-of-newly-added-test-cases" class="headerlink" title="Outcomes of newly added test cases"></a>Outcomes of newly added test cases</h3><p>Before adding new test cases, the code coverage at line level for <code>netty.buffer</code> is 6766&#x2F;9128, meaning that among the 9128 lines of code, 6766 of them were covered. 687 branches are tested, out of all the 1270 branches.</p>
<p>After adding all the new cases, line coverage increases to 6818 lines, and 10 more branches are covered.</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/02/24-06-37-45-coverage_after.png"></p>
<h2 id="References-1"><a href="#References-1" class="headerlink" title="References"></a>References</h2><p>[^1]: Mauro Pezze, Michal Young. Testing and Analysis, 2nd Edition</p>
<h2 id="Address-of-the-repo"><a href="#Address-of-the-repo" class="headerlink" title="Address of the repo"></a>Address of the repo</h2><p><a target="_blank" rel="noopener" href="https://github.com/rustberry/netty">GitHub - rustberry&#x2F;netty: Netty project - an event-driven asynchronous network application framework</a></p>
<h1 id="Netty-Test-Practice-Report-Chapter-4"><a href="#Netty-Test-Practice-Report-Chapter-4" class="headerlink" title="Netty Test Practice Report - Chapter 4"></a>Netty Test Practice Report - Chapter 4</h1><h2 id="What-is-Continuous-Integration-and-Why-Use-it"><a href="#What-is-Continuous-Integration-and-Why-Use-it" class="headerlink" title="What is Continuous Integration and Why Use it"></a>What is Continuous Integration and Why Use it</h2><blockquote>
<p><strong>Continuous integration</strong> is a DevOps software development practice where developers regularly merge their code changes into a central repository, after which automated builds and tests are run.[^1]</p>
</blockquote>
<p>The core of continuous integration is lies in two practices: merging minor code changes to the code bases, and automated test and deployment.  Usually, programmers commit code at least daily. After that, the whole program will be built automatically to incorporate the changes. If building is passed,  the program will be automatically tested to ensure that no regressions are added. In the end, the new program artifact is published and deployed, marking the end of a round of integration.</p>
<p>There’re many benefits of practicing  continuous integration. From a developer’s point of view, it first frees developers from the time-consuming task of manual testing and deployment. Secondly, bugs are detected at an early stage so that they could be easier to fix. Since continuous integration merges mainline frequently,  project managers are able to make better prediction of development time based on the daily progress so far. Product managers could evolve their business strategy more accurately, thanks to getting feedback more quickly from the customers. Finally, users of the product get new features more often.</p>
<h3 id="Why-open-source-project-also-needs-continuous-integration"><a href="#Why-open-source-project-also-needs-continuous-integration" class="headerlink" title="Why open source project also needs continuous integration"></a>Why open source project also needs continuous integration</h3><p>Open source projects often have loose organizational structure, comparing to business entities. Therefore, they are unlikely to have the need to deliver features so frequently, nor do they need to stick tight to the roadmap. They also don’t need to rapidly adapt their business strategy  – some may not even have one. Then why is continuous integration good for them?</p>
<p>In my opinion, continuous integration is beneficial at least in terms of development. With automated build and test, maintainers of the project save a lot of time from it. Automated build and test are also quick feedback to guide the commiter who made the code change: he or she could tell immediately if the code change is useful, or if not, what needs to be fixed. That’s why we could often see a project to have a build bot to deal some work of pull requests.</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/02/27-22-28-28-netty-bot.png"></p>
<h2 id="Netty’s-Continuous-Integration-Practice"><a href="#Netty’s-Continuous-Integration-Practice" class="headerlink" title="Netty’s Continuous Integration Practice"></a>Netty’s Continuous Integration Practice</h2><p>Netty used to have a self-hosted Jenkins installation that uses docker to run the continuous integration jobs[^2].In December 2020, they switch to using GitHub Actions, which spares them from maintaining a specific host machine. GitHub Actions has large <a target="_blank" rel="noopener" href="https://docs.github.com/en/actions/learn-github-actions/usage-limits-billing-and-administration#usage-limits">usage limits</a>. Except for better readability of YAML-based configuration (comparing to Jenkins), GitHub Actions also make it more maintainable as the developers could add building configuration files to source control.</p>
<p> As a framework that utilizes operating system specific features, Netty has the need to get testing on different platforms, and that’s where docker comes in handy. Those docker files are still useful in GitHub Actions workflow. The workflow file can be viewed as an environment setup file; the major work is done in docker compose YAML files. All we need to do is invoke docker commands in the <code>run</code> statement of workflow files, like this:</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/02/28-02-28-26-workflow_run.png"></p>
<p>What it truly does is a docker command, in which <code>mvn clean install</code> is executed with various arguments.</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/02/28-02-38-48-docker_build.png"></p>
<p>Above is the core command in the workflow file. Others define properties of this workflow, environment variables, and so on. Let me explain in detail of the YAML file.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Build</span> <span class="string">project</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span> [ <span class="string">&quot;main&quot;</span>, <span class="string">&quot;gh-test&quot;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="attr">schedule:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">cron:</span> <span class="string">&#x27;30 1 * * 1&#x27;</span>  <span class="comment"># At 01:30 on Monday, every Monday.</span></span><br></pre></td></tr></table></figure>

<p>These lines are at the beginning of the file, defining the name of this workflow, and the trigger to this. <code>On</code> every push to <code>branches</code> <code>main</code> and <code>gh-test</code> (my testing branch), this workflow would be triggered to run. In addition, this workflow is scheduled to run chronologically every week.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="attr">MAVEN_OPTS:</span> <span class="string">-Dhttp.keepAlive=false</span> <span class="string">-Dmaven.wagon.http.pool=false</span> <span class="string">-Dmaven.wagon.http.retryhandler.count=5</span> <span class="string">-Dmaven.wagon.httpconnectionManager.ttlSeconds=240</span></span><br></pre></td></tr></table></figure>

<p>The <code>env</code> entry defines some necessary environment variables to be used during testing.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">strategy:</span></span><br><span class="line">      <span class="attr">matrix:</span></span><br><span class="line">        <span class="attr">include:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">setup:</span> <span class="string">linux-x86_64-java11</span></span><br><span class="line">            <span class="attr">docker-compose-build:</span> <span class="string">&quot;-f docker/docker-compose.yaml -f docker/docker-compose.centos-6.111.yaml build&quot;</span></span><br><span class="line">            <span class="attr">docker-compose-run:</span> <span class="string">&quot;-f docker/docker-compose.yaml -f docker/docker-compose.centos-6.111.yaml run build&quot;</span></span><br></pre></td></tr></table></figure>

<p>The <code>jobs</code> entry is the major entry that does the real job. <code>runs-on: ubuntu-late</code> defines that the job runs on <a target="_blank" rel="noopener" href="https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idruns-on">GitHub-hosted runners</a>, which is free of charge.</p>
<p>Finally, in <code>steps</code> entry, previously written actions can be imported and reused. Or user can define their own actions with <code>name</code> and <code>run</code> keywords.</p>
<h3 id="Obstacles-while-practices-GitHub-Actions"><a href="#Obstacles-while-practices-GitHub-Actions" class="headerlink" title="Obstacles while practices GitHub Actions"></a>Obstacles while practices GitHub Actions</h3><p>The biggest problem I came across is that Netty project is a big code base, and it takes a lot of time just to run all the tests. Moreover, as a performance framework, it has many benchmarks to run. In average I have to wait for more than one hour for a single workflow run to finish, and then correct any errors detected. </p>
<p>Running maven goals locally doesn’t help since Maven’s <code>CheckStyle</code> plugin seems to have problem with Windows locales. At the start of the report I have been making workarounds to avoid executing its goal on Windows.</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/02/28-03-06-44-Avoid_checkstyle.png"></p>
<p>The most frequent errors I encountered are CheckStyle errors. Netty project has its own CheckStyle configurations and <a target="_blank" rel="noopener" href="https://netty.io/wiki/setting-up-development-environment.html">code styles</a>; both of them will be checked against during the building process. The newly merged code must strictly conform to the code conventions, not a single space is allowed.</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/02/28-03-11-20-gha_error1.png"></p>
<h2 id="Commit-address-of-new-changes"><a href="#Commit-address-of-new-changes" class="headerlink" title="Commit address of new changes"></a>Commit address of new changes</h2><p>The addresses of the new changes: <a target="_blank" rel="noopener" href="https://github.com/rustberry/netty/commit/c77c6c577a229e7ee45a4066c8935668b026b46c">Merge pull request #1 from rustberry&#x2F;gh-test · rustberry&#x2F;netty@c77c6c5 · GitHub</a></p>
<p>The workflow file being discussed: <a target="_blank" rel="noopener" href="https://github.com/rustberry/netty/blob/4.1/.github/workflows/ci-build.yml">netty&#x2F;ci-build.yml at 4.1 · rustberry&#x2F;netty · GitHub</a></p>
<h2 id="References-2"><a href="#References-2" class="headerlink" title="References"></a>References</h2><p>[^1]: <a target="_blank" rel="noopener" href="https://aws.amazon.com/devops/continuous-integration/#:~:text=Continuous%20integration%20is%20a%20DevOps,builds%20and%20tests%20are%20run.">What is Continuous Integration?</a>, Amazon Web Services</p>
<p>[^2]: <a target="_blank" rel="noopener" href="https://github.com/netty/netty/issues/10088#issuecomment-599402650">GSoC 2020 Proposal · Issue #10088 · netty&#x2F;netty · GitHub</a></p>
<h1 id="Netty-Test-Practice-Report-Chapter-5-Testable-Design-and-Mocking"><a href="#Netty-Test-Practice-Report-Chapter-5-Testable-Design-and-Mocking" class="headerlink" title="Netty Test Practice Report - Chapter 5: Testable Design and Mocking"></a>Netty Test Practice Report - Chapter 5: Testable Design and Mocking</h1><h2 id="Definition-of-testable-design-and-its-goals"><a href="#Definition-of-testable-design-and-its-goals" class="headerlink" title="Definition of testable design and its goals"></a>Definition of testable design and its goals</h2><p>In its essence, testable design is making it easier for code to be tested against. In <em>Effective Unit Testing</em>, author concludes:</p>
<blockquote>
<p>More specifically, testable design makes it easy to instantiate classes, substitute implementations, simulate different scenarios, and invoke particular execution paths from our test code.[^1]</p>
</blockquote>
<p>Or in short, testability means:</p>
<blockquote>
<p>a given piece of code should be easy and quick to write a unit test against.[^2]</p>
</blockquote>
<p>In my opinion, a testable design is also a maintainable design; testable software would also be well modularized. Only modularity could guarantee easy instantiation, easy stubbing and mocking. Therefore, sticking to testable principles is actually something natural when writing code. One may not even need to intentionally make his code testable: as long as one wants to keep the code readable and maintainable, then he&#x2F;she will naturally write code in a testable way.</p>
<p>There are several principles to conform to. All of them are aimed to solve those testability issues: </p>
<ul>
<li><p>instantiate a class;</p>
</li>
<li><p>invoke (test) a method;</p>
</li>
<li><p>observe the outcome at a specific point;</p>
</li>
<li><p>substitute the dependency that the class relies on (so that we could do mocking on it);</p>
</li>
<li><p>override a method (so that method could be mocked, or be delegated to observe its outcome)</p>
</li>
</ul>
<p>Some of the best practices to solve the above issues are:</p>
<ul>
<li><p>favor composition over inheritance; avoid complex constructor logic</p>
<ul>
<li><p>so that it is easier to instantiate the needed class. It is also good to adapt design patterns like builder and&#x2F;or factor method if it is really complicated (and necessary) to instantiate.</p>
</li>
<li><p>composition also makes it possible to switch different scenarios for testing by providing different objects for composition.</p>
</li>
</ul>
</li>
<li><p>avoid complex private methods;</p>
<ul>
<li>private methods are literally not accessible from the outside of the class, therefore not possible to test.</li>
</ul>
</li>
<li><p>single-responsibility principle;</p>
<ul>
<li>ideally, each function&#x2F;method should only address one issue. This makes it convenient to observe the outcome, since the data being processed won’t go through complicated changes in such functions.</li>
</ul>
</li>
</ul>
<h2 id="Testability-in-some-of-Netty’s-current-code"><a href="#Testability-in-some-of-Netty’s-current-code" class="headerlink" title="Testability in some of Netty’s current code"></a>Testability in some of Netty’s current code</h2><p>In <code>io.netty.handler.codec.mqtt</code> package, there is a class called <code>MqttEncoder</code> that extends the abstract class <code>MessageToMessageEncoder</code> and only overrides one method: <code>encode</code>. <code>encode</code> is intended to be used to transform the inbound message into another form of message, e.g. from ordinary string to base64 encoded strings. However, this method relies on a set of <em>private static</em> methods to do the actual encoding, as shown below. </p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/03/03-15-16-45-private%20static.png"></p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/03/03-15-18-28-the_private.png"></p>
<p>This has several drawbacks. First of all, as a private method it’s impossible to write unit test against each of those small private methods to make sure they function well. Secondly, as static methods, they operate on the class rather, than the object, leaving space for possible pollution of data when called by multiple instances. </p>
<p>My way to fix it is to firstly change the modifier to <code>public</code>, and then make sure that any references to variables out side of the scope of this method is thread-safe.</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/03/03-15-25-01-only_var.png"></p>
<p>Luckily the only field that might be shared across methods is declared as final. And by checking its usage, it turns out that it is not used inside the class at all, but rather acts as a handler exposed to the outside world for calling. In that case, I think it’s appropriate to keep the methods <code>static</code>, because after all this class is a utility class that is meant to encode &#x2F; decode messages, and have no internal states.</p>
<h2 id="Mocking-and-its-usage-in-Netty"><a href="#Mocking-and-its-usage-in-Netty" class="headerlink" title="Mocking and its usage in Netty"></a>Mocking and its usage in Netty</h2><p>Mocking is about generating fake objects that imitate the behavior of the targeted object. The use cases for mocking is when you’re dealing with a complex object (very possibly a third-party object that has little documentation or has complex internal logics) and want to test your own objects’ <strong>interaction</strong> with it. <em>Interaction testing</em> is different from the more common way of testing: <em>state testing</em>.</p>
<blockquote>
<p>Interaction testing is testing how an object sends messages (calls<br>methods) to other objects. You use interaction testing when calling another<br>object is the end result of a specific unit of work.[^3]</p>
</blockquote>
<p>Basically, interaction testing only checks if certain interactions between objects happened, and does not care about the internal state changes. As the book advises,</p>
<blockquote>
<p>Always choose to use interaction testing only as the last option.[^3]</p>
</blockquote>
<p>It is often more straightforward to check against values and states, but sometimes only interaction testing is useful. As stated before, when the other objects involved has little documentation and complex internal logic, it is best to leave them intact, and mock a new one to replace them. With mocking, it is even possible to make that third-party object to only have behaviors that are useful for testing.</p>
<h3 id="A-mocking-example-in-Netty"><a href="#A-mocking-example-in-Netty" class="headerlink" title="A mocking example in Netty"></a>A mocking example in Netty</h3><p>Network communication is often hard to set up for testing. For that reason, Netty has already had a convenient class for unit testing: <code>EmbeddedChannel</code>. It can send or receive network messages as the programmer withes. But if one only wants to test their handlers’ interaction with the channel is correct, then mocking is even more convenient.</p>
<p>In fact, the existing test cases for <code>EmbeddedChannel</code> doesn’t use the power of mocking so far. As a <code>Channel</code>, <code>EmbeddedChannel</code> interacts with various complex objects like <code>EventLoop</code>, <code>ChannelPipeline</code>, and <code>ChannelHandlerContext</code>. If our intention is only to make sure that <code>EmbeddedChannel</code> makes correct calls and signals to other instances, then those objects should all be mocked. First of all,  this eliminates all the possible “unexpected exception” not originated from our own class itself. For example, <code>EventLoop</code> could become unavailable to assign new threads due to system overhead during testing. More importantly, mocking them helps test designers focus on the purposes of the test cases: test the interaction of <code>EmbeddedChannel</code>. One of <code>EmbeddedChannel</code>‘s responsibility is firing different types of events to different objects to notify them. This is an essential part of Netty’s event-driven flow of data. Therefore, mocking other objects to test <code>EmbeddedChannel</code> is meaningful.</p>
<h2 id="References-3"><a href="#References-3" class="headerlink" title="References"></a>References</h2><p>[^1]: Lasse Koskela. <em>Effective Unit Testing</em>, Manning Publications</p>
<p>[^2]: <em>The Art of Unit Testing with Examples in .NET</em>, Manning Publications, 2009</p>
<p>[^3]: <em>The Art of unit Testing, 2nd edition</em></p>
<h1 id="Netty-Test-Practice-Report-Chapter-6"><a href="#Netty-Test-Practice-Report-Chapter-6" class="headerlink" title="Netty Test Practice Report - Chapter 6"></a>Netty Test Practice Report - Chapter 6</h1><p>In this chapter, we’ll analyze the code base of Netty <em>automatically</em>, that is, using static analysis tools.</p>
<h2 id="Static-analysis-tools-and-their-benefits"><a href="#Static-analysis-tools-and-their-benefits" class="headerlink" title="Static analysis tools and their benefits"></a>Static analysis tools and their benefits</h2><p>Static analysis is “a software verification activity that analyzes source code for quality, reliability, and security without executing the code”[^1].  It could also be carried out on the compiled code. Actually we may have all used static analysis before: when we write code in static typing language in an IDE, we could often see intelligent hints like “variable defined but not used”, or “variable written but never read”. Sometimes there could be code branch analysis like “the else statement can never be reached”. Such hints are the results of static analysis; specifically, they are the results of <em>dataflow analysis</em> and <em>control flow analysis</em>. Static analyzers, as the name suggest, are the tools that carry out static analysis on the code.</p>
<p>Comparing to dynamic analysis, static analyzers don’t require actually running the program. Also since it requires no human interference, static analyzers could be an economical way of analyzing a big code base.</p>
<h2 id="Code-analysis-tools-in-current-Netty-project"><a href="#Code-analysis-tools-in-current-Netty-project" class="headerlink" title="Code analysis tools in current Netty project"></a>Code analysis tools in current Netty project</h2><h3 id="Dynamic-analysis"><a href="#Dynamic-analysis" class="headerlink" title="Dynamic analysis"></a>Dynamic analysis</h3><p>Netty provides a built-in dynamic analysis feature, leak detection, via class <code>ResourceLeakDetector</code>[^2]. In its essence, <code>ResourceLeakDetector</code> uses JDK’s <code>PhantomReference&lt;T&gt;</code> to track the unreleased buffers in the 1% sample of one’s application’s memory usage, which is a small overhead. A typical example report of memory leak is like following:</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/03/10-12-28-44-netty_dynamic_ana.png"></p>
<h3 id="Static-analysis"><a href="#Static-analysis" class="headerlink" title="Static analysis"></a>Static analysis</h3><p>Netty project has its own <a target="_blank" rel="noopener" href="https://netty.io/files/IntelliJ%20IDEA%20Code%20Style.zip">code style configuration</a> and incorporates CheckStyle as a maven plugin. CheckStyle analysis has been set as part of the <code>goals</code> to be executed during  maven building process. It is also part of the continuous integration checks. Commits that doesn’t pass style check would fail during the triggered GitHub Action. Next we’ll see examples of CheckStyle reports on failed runs.</p>
<p>Here’s an example of XML formatting error.</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/03/10-12-44-25-CheckStyle1.png"></p>
<p>Depending on the configuration file specified, minor errors such as indentation will also be checked. When maven detects a build failure, it would cease all the remaining building tasks for other module and output a brief repot like this:</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/03/10-12-47-04-checkstyle1_2.png"> </p>
<p>Another example of report on coding style:</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/03/10-12-50-23-checkstyle_code1.png"></p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/03/10-12-53-35-checkstyle_code1_1.png"></p>
<p>And the summary are as follow:</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/03/10-12-51-20-checkstyle_code2.png"></p>
<p>Breaches of coding conventions are detected according to different coding style ruleset. The total number of errors in a module would be counted.</p>
<h2 id="Code-analysis-using-SpotBugs-and-PMD"><a href="#Code-analysis-using-SpotBugs-and-PMD" class="headerlink" title="Code analysis using SpotBugs and PMD"></a>Code analysis using SpotBugs and PMD</h2><p>SpotBugs comes handy as a well-developed Intellij plugin, while PMD has different behaviors in terms of the Intellij plugin and the binary version. Since Netty as a multi-module project is too big, we only inspect the <code>buffer</code> module.</p>
<h3 id="Overview-of-the-results"><a href="#Overview-of-the-results" class="headerlink" title="Overview of the results"></a>Overview of the results</h3><p>Here let’s look into the aggregated overall results first.</p>
<p>For SpotBugs, it claims to find 21 bug items in 131 classes, excluding the test files.</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/03/10-14-05-06-spotbugs.png"></p>
<p>It generally falls into two categories: Malicious code vulnerability (relating to security) and Dodgy code (relating to coding style).</p>
<p>With PMD, things are little trickier. The standard binary PMD command-line by default outputs ascii text to standard output like below. </p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/03/10-19-07-43-pmd_cmd.png"></p>
<p>For a better format and for a summary of the report, use this command:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\pmd.bat <span class="literal">--short-names</span> <span class="literal">-d</span> ..\..\netty\buffer\src\main\java\io\netty\buffer\ <span class="literal">-R</span> category/java/errorprone.xml <span class="operator">-f</span> summaryhtml <span class="literal">--report-file</span> report.html <span class="literal">--property</span> linkPrefix=https://github.com/rustberry/netty/blob/<span class="number">4.1</span>/ <span class="literal">--property</span> linePrefix=L</span><br></pre></td></tr></table></figure>

<p>The summary of binary PMD excluding test files is:</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/03/10-19-04-42-pmd_sum.png"></p>
<p>PMD uses a XML form of ruleset that could be customized to analyze the code. The ruleset I chose is <code>errorprone.xml</code>. Altogether it claims to have finds 561 bugs in this module.</p>
<p>However, the Intellij plugin finds different bugs. I suppose there might be difference on the ruleset they use.</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/03/10-19-11-16-pmd_plugin.png"></p>
<p>The plugin version claims to find more bugs: altogether 852 violations. PMD Intellij plugin has no way to configure target directory to exclude test files, so for the purpose of contrast, I ran the binary version on all files in <code>buffer</code> module. Altogether the binary version finds 791 errors.</p>
<p>All of these three versions of static analyzers don’t show the severity of bugs they find.</p>
<h3 id="Detailed-analysis-of-some-important-warnings"><a href="#Detailed-analysis-of-some-important-warnings" class="headerlink" title="Detailed analysis of some important warnings"></a>Detailed analysis of some important warnings</h3><h4 id="Findings-of-PMD"><a href="#Findings-of-PMD" class="headerlink" title="Findings of PMD"></a>Findings of PMD</h4><p>Some of PMD’s findings are not actual problems in the code. Take the <code>CloseResource</code> problem for example. It claims to find unclosed resource in following lines:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeUTF</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">DataOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> utf8out;  <span class="comment">// THIS LINE!</span></span><br><span class="line">    <span class="keyword">if</span> (out == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (closed) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;The stream is closed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Suppress a warning since the stream is closed in the close() method</span></span><br><span class="line">        utf8out = out = <span class="keyword">new</span> <span class="title class_">DataOutputStream</span>(<span class="built_in">this</span>); <span class="comment">// lgtm[java/output-resource-leak]</span></span><br><span class="line">    &#125;</span><br><span class="line">    out.writeUTF(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In fact, <code>utf8out</code> is a private field of the class, and has a specific method that takes care of the closing of it:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (closed) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    closed = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.close();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (utf8out != <span class="literal">null</span>) &#123;</span><br><span class="line">            utf8out.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The plugin version of PMD are more paranoid then binary version. For the <code>CloseResource</code> problem, it not only finds “bugs” that binary version finds, but also reports bugs from <code>abstract</code> classes. That should be an unnecessary behavior, because abstract class methods are meant to be overloaded and subject to change.</p>
<p><code>AvoidDuplicateLiterals</code> is another error that is more an indication than a bug declare. It will report duplicates in annotations:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&#123; &quot;unchecked&quot;, &quot;rawtypes&quot; &#125;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">allocate</span><span class="params">(MemoryRegionCache&lt;?&gt; cache, PooledByteBuf buf, <span class="type">int</span> reqCapacity)</span> &#123;</span><br><span class="line">    <span class="comment">/** */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Or strings in constructors of exceptions:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (isOutOfBounds(start, length, capacity)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IndexOutOfBoundsException</span>(<span class="string">&quot;expected: &quot;</span> + <span class="string">&quot;0 &lt;= start(&quot;</span> + start + <span class="string">&quot;) &lt;= start + length(&quot;</span> + length</span><br><span class="line">            + <span class="string">&quot;) &lt;= &quot;</span> + <span class="string">&quot;buf.capacity(&quot;</span> + capacity + <span class="string">&#x27;)&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AvoidCatchingThrowable</code> is a good advice, since the scope of <code>Throwable</code> is very broad. Luckily,  all the occurrences of such errors in this module are intended, and are located in static initializers of the class; this makes it possible to catch all possible errors during initialization.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    validateAndCalculateChunkSize(DEFAULT_PAGE_SIZE, defaultMaxOrder);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">    maxOrderFallbackCause = t;</span><br><span class="line">    defaultMaxOrder = <span class="number">11</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The most useful one I found so far is the <code>ConstructorCallsOverridableMethod</code> warning.  Explanation from the PMD website:</p>
<blockquote>
<p>Calling overridable methods during construction poses a risk of invoking methods on an incompletely constructed object and can be difficult to debug.[^3]</p>
</blockquote>
<p>This rule is also mentioned in <em>Effective Java</em>‘s 18th item: <em>Design and document for inheritance, or else prohibit it</em>:</p>
<blockquote>
<p>There are a few more restrictions that a class must obey to allow inheritance. <strong>Constructors must not invoke overridable methods</strong>, directly or indirectly. If you violate this rule, program failure will result. The superclass constructor runs before the subclass constructor, so the overriding method in the subclass will be invoked before the subclass constructor has run.[^4]</p>
</blockquote>
<p>The code that violates this rule:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">CompositeByteBuf</span><span class="params">(</span></span><br><span class="line"><span class="params">        ByteBufAllocator alloc, <span class="type">boolean</span> direct, <span class="type">int</span> maxNumComponents, Iterable&lt;ByteBuf&gt; buffers)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(alloc, direct, maxNumComponents,</span><br><span class="line">            buffers <span class="keyword">instanceof</span> Collection ? ((Collection&lt;ByteBuf&gt;) buffers).size() : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    addComponents(<span class="literal">false</span>, <span class="number">0</span>, buffers);</span><br><span class="line">    setIndex(<span class="number">0</span>, capacity());  <span class="comment">// THE OVERRIDABLE METHOD</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>class <code>CompositeByteBuf</code> uses the overridable method <code>setIndex</code> in its constructor. Although in its super class’s constructor <code>setIndex</code> is not called, <code>CompositeByteBuf</code> has a sub class that also overrides <code>setIndex</code>, in <code>WrappedCompositeByteBuf</code> class:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> CompositeByteBuf <span class="title function_">setIndex</span><span class="params">(<span class="type">int</span> readerIndex, <span class="type">int</span> writerIndex)</span> &#123;</span><br><span class="line">    wrapped.setIndex(readerIndex, writerIndex);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>So when <code>WrappedCompositeByteBuf</code> initializes, there might be chances that its uninitialized <code>setIndex</code> method is called by <code>CompositeByteBuf</code>.</p>
<h4 id="Findings-of-SpotBugs"><a href="#Findings-of-SpotBugs" class="headerlink" title="Findings of SpotBugs"></a>Findings of SpotBugs</h4><p>Comparing to PMD, SpotBugs have better IDE integration. The first category of warnings is <code>Malicious code vulnerability</code>, and contains two types: </p>
<ul>
<li><p>May expose internal representation by returning reference to mutable object, and </p>
</li>
<li><p>May expose internal representation by incorporating reference to mutable object</p>
</li>
</ul>
<p>The first one is very insightful. For example in this code, it exposes the private field that could be mutated of the class:</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/03/10-20-38-15-spot1.png"></p>
<p>There are other behavior that is intended, like this:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ByteBuf <span class="title function_">heapBuffer</span><span class="params">(<span class="type">int</span> initialCapacity, <span class="type">int</span> maxCapacity)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity == <span class="number">0</span> &amp;&amp; maxCapacity == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> emptyBuf;  <span class="comment">// THIS LINE</span></span><br><span class="line">    &#125;</span><br><span class="line">    validate(initialCapacity, maxCapacity);</span><br><span class="line">    <span class="keyword">return</span> newHeapBuffer(initialCapacity, maxCapacity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The <code>emptyBuf</code> returned here is thought to be <em>safe</em>. But this variable could be altered and returned again and again to other clients.</p>
<p>Although Netty is a software framework, and that perhaps the only ones having access to those variables are programmers themselves, there still exists the possibility of getting user input from outside world. If one malicious user successfully injects malicious content into the instance of the framework running in application server, there could be server security risk.</p>
<p>“May expose internal representation by incorporating reference to mutable object” is also about misuse of <code>private</code> fields, like this, assigning <code>private Bytebuf buffer</code> a mutable value:</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/03/10-20-47-38-spot2.png"></p>
<p>The second category is about general coding style, and therefore is more subjective.</p>
<p><em>Return value of method without side effect is ignored</em> is often a bad smell of code. If a method with return value is constantly called without using the return value, then there’s high chance that this method violates the single responsibility rule. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ByteBuf <span class="title function_">setIndex</span><span class="params">(<span class="type">int</span> readerIndex, <span class="type">int</span> writerIndex)</span> &#123;</span><br><span class="line">    checkIndex(readerIndex);  <span class="comment">// THIS METHOD HAS RETURN VALUE</span></span><br><span class="line">    checkIndex(writerIndex);  <span class="comment">// THIS METHOD HAS RETURN VALUE</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>But the website of SpotBugs admits that this rule may result in many false positives, and this example is one of them. Actually, <code>checkIndex</code> contains exception-throwing logic:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ByteBuf <span class="title function_">checkIndex</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (index != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IndexOutOfBoundsException</span>();  <span class="comment">// INTENDED TO THROW</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>So it does have side effects.</p>
<p><em>Potentially dangerous use of non-short-circuit logic</em> (e.g. <code>|</code> or <code>&amp;</code>). This rule also indicates a bad smell. In Netty, situations are different, as the case in some of the JDK code: the <em>non-short-circuit logic</em> is used with care in order to gain optimum performance.</p>
<p><img src="https://raw.githubusercontent.com/rustberry/img_archive/main/2022/03/10-21-02-52-performance.png"></p>
<p>This branch is “a hot path” that are executed very often, so Netty chooses to optimize it. </p>
<h3 id="Conclusion-and-comparison"><a href="#Conclusion-and-comparison" class="headerlink" title="Conclusion and comparison"></a>Conclusion and comparison</h3><p>To sum up, both PDM and SpotBugs reports code style warnings that are useful in most cases. One tool often identifies warnings that are different from the other. For example, the overriding of <code>equals</code> is mentioned by SpotBugs but not by PMD; while PMD finds problems of unclosed resources and suspicious comparisons not using <code>equals</code>. So it could be a good choice to use different static analyzers to get a more complete report.</p>
<p>In terms of code vulnerability, SpotBugs seems to do a better job than PMD both in terms of warning classification and the number of warnings reported. But SpotBugs doesn’t notice the problem of invoking overridable methods from a constructor, even though it does <a target="_blank" rel="noopener" href="https://spotbugs.readthedocs.io/en/latest/bugDescriptions.html#RV_RETURN_VALUE_IGNORED_NO_SIDE_EFFECT">have a rule for it</a>.</p>
<p>As maybe common for static analyzers, the chance of reporting  false positive cases are not low. So static analysis is not a silver bullet for code quality check: special care still  must be taken by humans.</p>
<h2 id="References-4"><a href="#References-4" class="headerlink" title="References"></a>References</h2><p>[^1]: <a target="_blank" rel="noopener" href="https://www.mathworks.com/discovery/static-code-analysis.html">What Is Static Code Analysis? – MATLAB and Simulink - MATLAB &amp; Simulink</a></p>
<p>[^2]: Norman Maurer, Marvin Allen Wolfthal. Netty in Action</p>
<p>[^3]: <a target="_blank" rel="noopener" href="https://pmd.github.io/pmd-6.43.0/pmd_rules_java_errorprone.html#constructorcallsoverridablemethod">Error Prone | PMD Source Code Analyzer</a></p>
<p>[^4]: Effective Java, 3rd Edition</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/20/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8Bbug%E4%B9%8B%E6%BA%90%EF%BC%9A%E6%AD%BB%E9%94%81%E6%88%90%E5%9B%A0%E4%B8%8E%E9%87%8D%E6%8E%92%E5%BA%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jimmy Xu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
      <meta itemprop="description" content="Tu ne cede malis, sed contra audentior ito">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Rust Shrugged">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/06/20/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8Bbug%E4%B9%8B%E6%BA%90%EF%BC%9A%E6%AD%BB%E9%94%81%E6%88%90%E5%9B%A0%E4%B8%8E%E9%87%8D%E6%8E%92%E5%BA%8F/" class="post-title-link" itemprop="url">并发编程bug之源：死锁成因与重排序</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-06-20 00:00:00" itemprop="dateCreated datePublished" datetime="2019-06-20T00:00:00+00:00">2019-06-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-02-10 05:13:07" itemprop="dateModified" datetime="2023-02-10T05:13:07+00:00">2023-02-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Concurrency/" itemprop="url" rel="index"><span itemprop="name">Concurrency</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Java-内存模型"><a href="#Java-内存模型" class="headerlink" title="Java 内存模型"></a>Java 内存模型</h1><p>每学习一个新概念时，一个有效的办法就是问自己，为什么需要这个技术，这个技术试图解决什么问题？怎么解决的？套用在 Java 内存模型 JMM 上，就是如下的问题：</p>
<ul>
<li>为什么需要JMM，它试图解决什么问题？</li>
<li>JMM是如何解决可见性等各种问题的？类似volatile，体现在具体用例中有什么效果？</li>
</ul>
<p>这篇文章先分析为什么需要 JMM，然后顺便分析另一大并发 bug 来源，死锁。</p>
<h3 id="从源代码到机器码会经历重排序"><a href="#从源代码到机器码会经历重排序" class="headerlink" title="从源代码到机器码会经历重排序"></a>从源代码到机器码会经历重排序</h3><p>重排序，这就是需要一个统一 JMM 模型的原因。</p>
<ol>
<li>编译器在<em>不改变程序语义</em>的前提下，重新安排语句执行顺序。（例子）</li>
<li>指令级并行 Instruction Level Parallelism（搜索关键词：ILP），改变机器指令的执行顺序。（用于方便流水线，提高并行度 parallelism）</li>
<li>内存系统重排序。现代的处理器使用写缓冲区（CPU cache）临时保存向内存写入的数据。<br><strong>为什么内存重排：</strong>写缓冲区可以保证指令流水线持续运行，它可以避免由于处理器停顿下来等待向内存写入数据而产生的延迟。同时，通过以批处理的方式刷新写缓冲区，以及合并写缓冲区中对同一内存地址的多次写，减少对内存总线的占用。<br><strong>导致的问题：</strong>当多个CPU同时（在另一个CPU写回之前）将同一个变量读入cache，任意一个CPU对该块内存的操作对于其他CPU来说都是不可见的。到写回内存时，先写入内存的就会被后写入的覆盖。</li>
</ol>
<p>编译器重排序：1，处理器重排序：2，3。</p>
<p>ILP 重排应对方式：在编译生成指令序列时，插入由CPU支持的内存屏障 Memory Barriers（搜索关键词：Intel Memory Fence）</p>
<p>重排的依据：</p>
<p><strong>数据依赖性：</strong>如果两个操作访问同一个变量，且这两个操作中有一个为写操作，此时这两个操作之间就存在数据依赖性。</p>
<p><strong>控制依赖性：</strong>看一段程序：<code>if (flag) int i *= 3; </code>。在这里，<code>if</code>这个操作A 和<code>i *= 3</code>这个操作B 存在控制依赖关系，只有操作A 完成了，才能确定是否执行操作 B。这样，并行度就被降低了。处理器通过猜测执行（Speculation），可以在执行操作A的同时计算 <code>i</code> 的值，如果操作A 为 true 就让 <code>i</code> 等于计算结果，否则不等于。</p>
<p>给（应用）程序员提供统一的内存模型还有一个原因是覆盖掉各种不同底层机器的差异，Intel，AMD，PowerPC，不同处理器有些内存一致（Cache Coherence）有些不遵循。</p>
<h1 id="死锁的成因与各种应对"><a href="#死锁的成因与各种应对" class="headerlink" title="死锁的成因与各种应对"></a>死锁的成因与各种应对</h1><p>银行两个账户之间的 Transfer 是很好的例子。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(Account from, Account to, <span class="type">int</span> amnt)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(from) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(to) &#123;</span><br><span class="line">            from.setAmount(from.getAmount() - amnt);</span><br><span class="line">            to.setAmount(to.getAmount() + amnt);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>要形成死锁 Deadlock，必备的四个条件，缺一不可：</p>
<ol>
<li>互斥。某一代码块同一时刻只能一个线程执行。一般都会存在。</li>
<li>hold and wait。抢到锁却继续等待其他资源（锁）</li>
<li>循环等待。两个线程互相等待对方</li>
<li>无法超时&#x2F;剥夺的等待。</li>
</ol>
<p>对应方法：</p>
<ol>
<li>一般是基础条件，无法破除</li>
<li>用一把锁一次性获得所有资源。例子中，可以加上全局锁，确保<code>from</code> 和 <code>to</code> 可以被同时拿到。缺点：效率低下。</li>
<li>在锁之间创造先后顺序。需要获取两个锁时，优先尝试 <code>id</code> 大的那个。</li>
<li>加入超时。缺点：等待时间太久。拿到锁 <code>from</code> 后尝试获取锁 <code>to</code>，失败则立即释放锁 <code>from</code>，过一段时间（）再尝试。</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/22/%E7%A8%8B%E5%BA%8F%E5%91%98%E5%BF%85%E7%9F%A5%E7%9A%84%E5%86%85%E5%AD%98%E7%9F%A5%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jimmy Xu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
      <meta itemprop="description" content="Tu ne cede malis, sed contra audentior ito">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Rust Shrugged">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/22/%E7%A8%8B%E5%BA%8F%E5%91%98%E5%BF%85%E7%9F%A5%E7%9A%84%E5%86%85%E5%AD%98%E7%9F%A5%E8%AF%86/" class="post-title-link" itemprop="url">程序员必知的内存知识</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-05-22 00:00:00" itemprop="dateCreated datePublished" datetime="2019-05-22T00:00:00+00:00">2019-05-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-02-10 05:13:07" itemprop="dateModified" datetime="2023-02-10T05:13:07+00:00">2023-02-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Computer-Organization/" itemprop="url" rel="index"><span itemprop="name">Computer Organization</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>原文地址：<a target="_blank" rel="noopener" href="https://lwn.net/Articles/252125/">https://lwn.net/Articles/252125/</a></p>
</blockquote>
<h1 id="What-every-programmer-should-know-about-memory"><a href="#What-every-programmer-should-know-about-memory" class="headerlink" title="What every programmer should know about memory"></a>What every programmer should know about memory</h1><h2 id="Part-2-CPU-Caches"><a href="#Part-2-CPU-Caches" class="headerlink" title="Part 2: CPU Caches"></a>Part 2: CPU Caches</h2><h2 id="程序员必知的内存知识"><a href="#程序员必知的内存知识" class="headerlink" title="程序员必知的内存知识"></a>程序员必知的内存知识</h2><h2 id="第二部分：CPU-缓存"><a href="#第二部分：CPU-缓存" class="headerlink" title="第二部分：CPU 缓存"></a>第二部分：CPU 缓存</h2><p>[Editor’s note: This is the second installment in Ulrich Drepper’s “What every programmer should know about memory” document. Those who have not read the first part will likely want to start there. This is good stuff, and we once again thank Ulrich for allowing us to publish it.]<br>[编者注：这是Ulrich Drepper的文章“程序员必知的内存知识”的第二部分。那些没有阅读过第一部分的人可能会想从那看起。这篇文章很棒，再次感谢Ulrich允许我们发布它。]</p>
<p>CPUs are today much more sophisticated than they were only 25 years ago. In those days, the frequency of the CPU core was at a level equivalent to that of the memory bus. Memory access was only a bit slower than register access. But this changed dramatically in the early 90s, when CPU designers increased the frequency of the CPU core but the frequency of the memory bus and the performance of RAM chips did not increase proportionally. This is not due to the fact that faster RAM could not be built, as explained in the previous section. It is possible but it is not economical. RAM as fast as current CPU cores is orders of magnitude more expensive than any dynamic RAM.<br>如今的CPU比25年前更加复杂。25年前，CPU内核的频率处于与内存总线相当的水平。访问内存只比访问寄存器慢一点。但是在90年代早期，当CPU设计人员提高CPU内核的频率而内存总线的频率和RAM（random-access memory，内存；随机存取存储器）芯片的性能没有按比例增加时，这种情况发生了巨大的变化。如上一节所述，这不是因为无法建造更快的RAM。造更快的RAM是可能的，但这样做不经济。与当前CPU内核一样快的RAM比任何动态RAM都要贵上几个数量级。</p>
<p>If the choice is between a machine with very little, very fast RAM and a machine with a lot of relatively fast RAM, the second will always win given a working set size which exceeds the small RAM size and the cost of accessing secondary storage media such as hard drives. The problem here is the speed of secondary storage, usually hard disks, which must be used to hold the swapped out part of the working set. Accessing those disks is orders of magnitude slower than even DRAM access.<br>如果非要在在具有非常小、非常快的RAM的机器和具有大量相对较快RAM的机器之间做一个选择，那么第二个方案总是更好的选择，如果给定的工作集大小超过小RAM的大小和访问硬盘之类的二级辅助存储介质的成本。问题在于二级存储的速度。二级储存通常是硬盘，它必须够大来保存工作集中从内存交换给它的部分。访问这些磁盘的速度比访问DRAM（动态随机存取存储器，Dynamic Random Access Memory）慢几个数量级。</p>
<p>Fortunately it does not have to be an all-or-nothing decision. A computer can have a small amount of high-speed SRAM in addition to the large amount of DRAM. One possible implementation would be to dedicate a certain area of the address space of the processor as containing the SRAM and the rest the DRAM. The task of the operating system would then be to optimally distribute data to make use of the SRAM. Basically, the SRAM serves in this situation as an extension of the register set of the processor.<br>幸运的是，我们并不需要做这种非黑即白的决定。计算机可以在拥有大量DRAM的同时带有少量的高速SRAM（静态随机存储器，Static Random Access Memory）。一种可能的实现方式是将处理器地址空间的某个区域用SRAM存储而将其余部分用DRAM。接下来，操作系统的任务就是最佳地分配数据以利用SRAM。基本上，SRAM在这种情况下被用作处理器寄存器组的扩展。</p>
<p>While this is a possible implementation, it is not viable. Ignoring the problem of mapping the physical resources of such SRAM-backed memory to the virtual address spaces of the processes (which by itself is terribly hard) this approach would require each process to administer in software the allocation of this memory region. The size of the memory region can vary from processor to processor (i.e., processors have different amounts of the expensive SRAM-backed memory). Each module which makes up part of a program will claim its share of the fast memory, which introduces additional costs through synchronization requirements. In short, the gains of having fast memory would be eaten up completely by the overhead of administering the resources.<br>虽然这是一种可能的实现方式，但它并不可行。即使先忽略将这种SRAM支持的内存的物理地址映射到进程的虚拟地址空间（这本身就非常困难）所产生的问题，这种方法要求每个进程直接在软件中管理该存储区域的分配。存储区域的大小将随处理器而变化（即，不同处理器具有不同数量的昂贵的SRAM支持的内存）。构成一个程序的每个模块都将试图占用其快速存储器的份额，这又会因为协调不同要求而引入额外的成本。简而言之，拥有快速内存的收益将完全被管理资源带来的开销所抵消。</p>
<p>So, instead of putting the SRAM under the control of the OS or user, it becomes a resource which is transparently used and administered by the processors. In this mode, SRAM is used to make temporary copies of (to cache, in other words) data in main memory which is likely to be used soon by the processor. This is possible because program code and data has temporal and spatial locality. This means that, over short periods of time, there is a good chance that the same code or data gets reused. For code this means that there are most likely loops in the code so that the same code gets executed over and over again (the perfect case for spatial locality). Data accesses are also ideally limited to small regions. Even if the memory used over short time periods is not close together there is a high chance that the same data will be reused before long (temporal locality). For code this means, for instance, that in a loop a function call is made and that function is located elsewhere in the address space. The function may be distant in memory, but calls to that function will be close in time. For data it means that the total amount of memory used at one time (the working set size) is ideally limited but the memory used, as a result of the random access nature of RAM, is not close together. Realizing that locality exists is key to the concept of CPU caches as we use them today.<br>因此，我们不应该将SRAM置于操作系统或用户的控制之下，而应该让它成为由处理器透明地使用和管理的资源。这时，SRAM用于临时复制（或者缓存）主存中那些可能即将被处理器使用的数据。这种做法是可行的，因为程序代码和数据具有时间和空间局部性。这意味着，在很短的时间内，曾经被使用过的代码和数据很有可能被再次使用。从代码的层面来说，这意味着代码中很可能存在循环，所以相同的代码一次又一次地执行（空间局部性的完美情况）。理想情况下，数据访问也仅限于很小的内存区域内。即使在短时间段内访问的内存不紧凑，也很有可能不久之后重复使用相同的数据（时间局部性）。从代码的层面来说，这时可能在循环中进行函数调用，并且该函数位于地址空间的其他位置。该函数可能在内存中相距甚远，但时间上对该函数的调用并不遥远。对于数据，这意味着每次使用的内存的总量（工作集大小）是有限的，但由于RAM 的随机访问性质，所使用的内存并不需要被紧凑地存储在一起。当我们今天使用CPU缓存时，意识到存在局部性理解是CPU缓存概念的关键。</p>
<p>A simple computation can show how effective caches can theoretically be. Assume access to main memory takes 200 cycles and access to the cache memory take 15 cycles. Then code using 100 data elements 100 times each will spend 2,000,000 cycles on memory operations if there is no cache and only 168,500 cycles if all data can be cached. That is an improvement of 91.5%.<br>一个简单的计算可以显示理论上缓存有多有效。假设访问主存储器需要200个时钟周期而访问高速缓冲存储器需要15个周期。然后，如果没有缓存，则对100个数据元素使用100次的代码将在内存操作上花费2,000,000个周期，如果所有数据都可以缓存，则仅花费168,500个周期。这可是91.5％的改善。</p>
<p>The size of the SRAM used for caches is many times smaller than the main memory. In the author’s experience with workstations with CPU caches the cache size has always been around 1&#x2F;1000th of the size of the main memory (today: 4MB cache and 4GB main memory). This alone does not constitute a problem. If the size of the working set (the set of data currently worked on) is smaller than the cache size it does not matter. But computers do not have large main memories for no reason. The working set is bound to be larger than the cache. This is especially true for systems running multiple processes where the size of the working set is the sum of the sizes of all the individual processes and the kernel.<br>用于缓存的SRAM的大小比主存小许多倍。在作者使用带CPU缓存的工作站的经验中，缓存大小一直是主内存大小的1&#x2F;1000（现在：4MB缓存和4GB主存）。仅这一点不构成问题。如果工作集的大小（当前处理的数据的大小）小于缓存大小则无关紧要。但计算机不是无缘无故配有大容量主存的。工作集一定会大于缓存。对于运行多个进程的系统尤其如此：其工作集的大小是所有单个进程和内核的大小的总和。</p>
<p>What is needed to deal with the limited size of the cache is a set of good strategies to determine what should be cached at any given time. Since not all data of the working set is used at exactly the same time we can use techniques to temporarily replace some data in the cache with other data. And maybe this can be done before the data is actually needed. This prefetching would remove some of the costs of accessing main memory since it happens asynchronously with respect to the execution of the program. All these techniques and more can be used to make the cache appear bigger than it actually is. We will discuss them in Section 3.3. Once all these techniques are exploited it is up to the programmer to help the processor. How this can be done will be discussed in Section 6.<br>处理缓存大小有限问题所需要的是一组好的策略，来确定在什么时间应该缓存什么。由于工作组的数据不会被同时全部访问，我们可以用技术来将缓存中的一些数据暂时替换成其它数据。这种替换可以在实际需要这些数据之前完成。预先缓存数据将消除访问主存的一些成本，因为它与程序的执行异步发生。这种技术和更多其它技术可使得缓存显得比实际容量更大。我们将在3.3节讨论这一点。在所有这些技术被使用之后，就需要靠程序员来帮助处理器了。如何做到这一点将在第6节中讨论。</p>
<p>3.1 CPU Caches in the Big Picture<br>3.1 CPU 缓存在计算机整体层面上的地位<br>Before diving into technical details of the implementation of CPU caches some readers might find it useful to first see in some more details how caches fit into the “big picture” of a modern computer system.<br>在深入研究实现CPU缓存的技术细节之前，一些读者可能会觉得，首先更多了解缓存在现代计算机系统的“大局”中的地位会有帮助。</p>
<p>Figure 3.1: Minimum Cache Configuration<br>图 3.1：最小缓存配置<br>Figure 3.1 shows the minimum cache configuration. It corresponds to the architecture which could be found in early systems which deployed CPU caches. The CPU core is no longer directly connected to the main memory. {In even earlier systems the cache was attached to the system bus just like the CPU and the main memory. This was more a hack than a real solution.} All loads and stores have to go through the cache. The connection between the CPU core and the cache is a special, fast connection. In a simplified representation, the main memory and the cache are connected to the system bus which can also be used for communication with other components of the system. We introduced the system bus as “FSB” which is the name in use today; see Section 2.2. In this section we ignore the Northbridge; it is assumed to be present to facilitate the communication of the CPU(s) with the main memory.<br>图3.1显示了最小缓存配置的情况。它所对应的架构可以在早期部署CPU缓存的系统中找到。CPU内核不再直接连接到主内存。（在更早的系统中，缓存像CPU和主存一样连接到系统总线。这更像是一种权宜之计而不是真正的解决方案。）所有加载和存储都必须通过缓存。CPU内核和缓存之间的连接是一种特殊的快速连接。简单来说，主存和高速缓存连接到系统总线，系统总线也可用于与系统的其他组件通信。我们介绍系统总线时叫它“FSB”，这是目前使用的名称; 见2.2节。在本节中，我们忽略北桥，只有在帮助 CPU与主存储器的通信时我们才假设它存在。</p>
<p>Even though computers for the last several decades have used the von Neumann architecture, experience has shown that it is of advantage to separate the caches used for code and for data. Intel has used separate code and data caches since 1993 and never looked back. The memory regions needed for code and data are pretty much independent of each other, which is why independent caches work better. In recent years another advantage emerged: the instruction decoding step for the most common processors is slow; caching decoded instructions can speed up the execution, especially when the pipeline is empty due to incorrectly predicted or impossible-to-predict branches.<br>尽管在过去几十年中计算机一直在使用冯诺伊曼（von Neumann）架构，但实践表明，把用于代码和数据的高速缓存分离是有利的。Intel（英特尔）自1993年以来一直使用分开的代码和数据缓存，从未改变过。代码和数据所需的内存区域几乎彼此独立地储存着，这就是独立缓存更有效的原因。近年来出现了另一个优点：处理器的指令解码步骤一般都很慢; 缓存解码过的指令可以加速执行，特别是当流水线由于错误预测或无法预测的分支而为空时。</p>
<p>Soon after the introduction of the cache, the system got more complicated. The speed difference between the cache and the main memory increased again, to a point that another level of cache was added, bigger and slower than the first-level cache. Only increasing the size of the first-level cache was not an option for economical reasons. Today, there are even machines with three levels of cache in regular use. A system with such a processor looks like Figure 3.2. With the increase on the number of cores in a single CPU the number of cache levels might increase in the future even more.<br>引入缓存后不久，系统变得更加复杂。缓存和主存之间的速度差异再次增大，以至于增加了另一级缓存，比第一级缓存更大，更慢。出于经济原因，仅增加第一级缓存的大小不是一种选择。今天，甚至有常规的使用三级缓存的机器。具有这种处理器的系统如图3.2所示。随着单个CPU中核心数量的增加，未来缓存级别的数量可能会增加。</p>
<p>Figure 3.2: Processor with Level 3 Cache<br>图3.2：具有3级缓存的处理器</p>
<p>Figure 3.2 shows three levels of cache and introduces the nomenclature we will use in the remainder of the document. L1d is the level 1 data cache, L1i the level 1 instruction cache, etc. Note that this is a schematic; the data flow in reality need not pass through any of the higher-level caches on the way from the core to the main memory. CPU designers have a lot of freedom designing the interfaces of the caches. For programmers these design choices are invisible.<br>图3.2显示了三级缓存，并介绍了我们将在本文档的其余部分中使用的命名法。L1d代表1级数据高速缓存，L1i代表1级指令高速缓存，以此类推。注意这是一个原理图; 实际中，数据流可以在从核心到主存的路上不通过任何更高级别的高速缓存。CPU设计人员可以自由设计高速缓存的接口。对于程序员来说，这些设计选择是不可见的。</p>
<p>In addition we have processors which have multiple cores and each core can have multiple “threads”. The difference between a core and a thread is that separate cores have separate copies of (almost {Early multi-core processors even had separate 2nd level caches and no 3rd level cache.}) all the hardware resources. The cores can run completely independently unless they are using the same resources—e.g., the connections to the outside—at the same time. Threads, on the other hand, share almost all of the processor’s resources. Intel’s implementation of threads has only separate registers for the threads and even that is limited, some registers are shared. The complete picture for a modern CPU therefore looks like Figure 3.3.<br>此外，我们的处理器具有多个内核，每个内核可以有多个“线程”。核心和线程之间的区别在于，单独的核心具有（几乎{ 早期多核处理器甚至具有单独的第二级高速缓存而没有第三级高速缓存。 }）所有硬件资源的单独副本。核心可以完全彼此独立运行，除非它们使用到了相同的资源——例如与外部的连接——并且在同一时刻用到。另一方面，线程几乎共享处理器的所有资源。英特尔的线程实现中，线程只有寄存器是各自使用的。即使这一点也是有限的，一些寄存器是共享的。因此，现代CPU的完整图片如图3.3所示。</p>
<p>Figure 3.3: Multi processor, multi-core, multi-thread<br>图3.3：多处理器，多核，多线程<br>In this figure we have two processors, each with two cores, each of which has two threads. The threads share the Level 1 caches. The cores (shaded in the darker gray) have individual Level 1 caches. All cores of the CPU share the higher-level caches. The two processors (the two big boxes shaded in the lighter gray) of course do not share any caches. All this will be important, especially when we are discussing the cache effects on multi-process and multi-thread applications.<br>在这个图中有两个处理器，每个处理器有两个内核，每个内核有两个线程。线程共享1级缓存。核心（深灰色阴影）具有单独的1级缓存。CPU的所有核心共享更高级别的缓存。两个处理器（两个浅灰色阴影的大框）不共享任何缓存。所有这些都很重要，尤其是当我们讨论多进程和多线程应用程序的缓存效果时。</p>
<p>3.2 Cache Operation at High Level<br>3.2高级别的缓存操作<br>To understand the costs and savings of using a cache we have to combine the knowledge about the machine architecture and RAM technology from Section 2 with the structure of caches described in the previous section.<br>要了解使用缓存的成本和优点，我们必须将第2节中的机器架构和RAM技术的知识与上一节中描述的缓存结构相结合</p>
<p>By default all data read or written by the CPU cores is stored in the cache. There are memory regions which cannot be cached but this is something only the OS implementers have to be concerned about; it is not visible to the application programmer. There are also instructions which allow the programmer to deliberately bypass certain caches. This will be discussed in Section 6.<br>默认情况下，CPU内核读取或写入的所有数据都存储在缓存中。有些内存区域无法缓存，但这只是操作系统实现人员必须关注的问题; 它对应用程序员来说是不可见的。还有一些指令允许程序员故意绕过某些缓存，将在第6节中讨论这些。</p>
<p>If the CPU needs a data word the caches are searched first. Obviously, the cache cannot contain the content of the entire main memory (otherwise we would need no cache), but since all memory addresses are cacheable, each cache entry is tagged using the address of the data word in the main memory. This way a request to read or write to an address can search the caches for a matching tag. The address in this context can be either the virtual or physical address, varying based on the cache implementation.<br>如果CPU需要一个字的数据，则首先搜索高速缓存。显然，缓存不能包含整个主存储器的内容（否则我们不需要缓存），但由于所有内存地址都是可缓存的，因此每个缓存条目都使用主存中数据字的地址进行标记。这样，读取或写入地址的请求可以在高速缓存中搜索匹配的标记。在这种情况下，地址可以是虚拟内存地址或物理地址，基于缓存的具体实现而变化。</p>
<p>Since the tag requires space in addition to the actual memory, it is inefficient to choose a word as the granularity of the cache. For a 32-bit word on an x86 machine the tag itself might need 32 bits or more. Furthermore, since spatial locality is one of the principles on which caches are based, it would be bad to not take this into account. Since neighboring memory is likely to be used together it should also be loaded into the cache together. Remember also what we learned in Section 2.2.1: RAM modules are much more effective if they can transport many data words in a row without a new CAS or even RAS signal. So the entries stored in the caches are not single words but, instead, “lines” of several contiguous words. In early caches these lines were 32 bytes long; now the norm is 64 bytes. If the memory bus is 64 bits wide this means 8 transfers per cache line. DDR supports this transport mode efficiently。<br>由于标签除了实际存储器之外还需要空间，因此选择字作为高速缓存的单位是低效的。对于x86机器上的32位字，标签本身大小可能需要32位或更多。此外，由于空间局部性是高速缓存的基本原则之一，也必须把这一点考虑进去。由于相邻内存区域可能被一起访问，因此它们也应该一起加载到高速缓存中。还要记住我们在第2.2.1节中学到的内容：如果RAM模块可以在不发送新CAS或甚至RAS信号的情况下连续传输多个数据字，则它们会更有效。因此，存储在高速缓存中的条目不是字，而是有着几个连续字的“行”。在早期的缓存中，这些行的长度为32个字节; 现在的规范是64字节。如果存储器总线是64位宽，则这意味着每个高速缓存行需要8次传输。DDR能有效地支持这种传输模式。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/05/%E4%BA%8C%E5%8F%89%E5%A0%86%E4%B8%8E%E5%A0%86%E6%8E%92%E5%BA%8F%E8%A6%81%E7%82%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jimmy Xu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
      <meta itemprop="description" content="Tu ne cede malis, sed contra audentior ito">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Rust Shrugged">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/04/05/%E4%BA%8C%E5%8F%89%E5%A0%86%E4%B8%8E%E5%A0%86%E6%8E%92%E5%BA%8F%E8%A6%81%E7%82%B9/" class="post-title-link" itemprop="url">二叉堆与堆排序要点</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-04-05 00:00:00" itemprop="dateCreated datePublished" datetime="2019-04-05T00:00:00+00:00">2019-04-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Algorithm/" itemprop="url" rel="index"><span itemprop="name">Algorithm</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="二叉堆，堆排序，与优先队列要点"><a href="#二叉堆，堆排序，与优先队列要点" class="headerlink" title="二叉堆，堆排序，与优先队列要点"></a>二叉堆，堆排序，与优先队列要点</h1><p>今天看完了红皮《算法》第二章的优先队列那一节。二叉堆，堆排序，优先队列，这些都是难舍难分密切相关的几个概念。一句话来说，优先队列作为一种高效的数据结构，其实现依赖于二叉堆这么一种数据结构。借助于优先队列，能实现一种时间复杂度为<code>logn</code>的<strong>原地</strong>排序算法，堆排序。</p>
<p>要点：</p>
<ol>
<li>二叉堆定义（用数组表示时的细节）</li>
<li><strong>插入</strong>（尾端叶子节点）与<strong>删除</strong>（根节点）的过程</li>
<li>建堆方式 + sink 下沉操作 &#x3D; 堆排序——堆排序的过程</li>
<li>堆排序的优点与缺点<ol>
<li><strong>优点</strong>：内存使用，原地排序</li>
<li><strong>缺点</strong>：CPU cache 缓存命中，非稳定排序，比较次数大于快排</li>
</ol>
</li>
<li>复杂度得出过程</li>
</ol>
<p>[TOC]</p>
<h2 id="二叉堆定义与数组表示"><a href="#二叉堆定义与数组表示" class="headerlink" title="二叉堆定义与数组表示"></a>二叉堆定义与数组表示</h2><p>根节点大于<strong>等于</strong>左右两个子节点。当储存为数组时，根节点放在索引 1 的位置，为了计算便利数组的索引零不存储数据。位置为 k 的节点的父节点位置是 p &lt;&#x3D; k&#x2F;2，子节点在数组中的位置是 2k 和 2k+1。如图：</p>
<p><img src="/content/images/2019/HeapRepresentations.png" alt="Heap Representations"></p>
<p>另外，二叉堆<strong>属于</strong>完全二叉树。</p>
<h2 id="二叉堆删除最大节点与插入数据过程"><a href="#二叉堆删除最大节点与插入数据过程" class="headerlink" title="二叉堆删除最大节点与插入数据过程"></a>二叉堆删除最大节点与插入数据过程</h2><h3 id="上浮、下沉操作"><a href="#上浮、下沉操作" class="headerlink" title="上浮、下沉操作"></a>上浮、下沉操作</h3><p>这两个操作是插入、删除 API 的基础操作。</p>
<p><strong>上浮 swim</strong> 是指当某节点的子节点大于其父节点，破坏了堆的有序性，则将这个过大的子节点与它的父节点交换。如果交换之后，该子节点仍然大于交换位置之后的父节点，继续交换。这个过程就被形象化称为上浮。最终，节点上浮到正确的位置，它的父节点大于它，所有子节点小于它。每上浮一次需要 <code>1</code> 次比较。</p>
<p><strong>下沉 sink</strong> 是相反的操作，由上至下比较。如果某节点小于它的子节点，则发生交换。每次下沉需要两次比较。首先比较找出两个子节点中较大的那个，然后比较较大子节点与父节点，如果父节点小于则交换。</p>
<h3 id="删除最大-x2F-根节点"><a href="#删除最大-x2F-根节点" class="headerlink" title="删除最大&#x2F;根节点"></a>删除最大&#x2F;根节点</h3><p>在大端二叉堆中，根节点就是堆中最大元素。将根节点删除&#x2F;取出之后，把堆中最末尾的元素（也就是树中最大一层最右边的叶子节点）放在根节点的位置，然后对这个节点进行<code>下沉</code>操作。</p>
<p>每次删除操作，需要的时间复杂度最坏为 $\log n$，也就是从根节点一直比较、交换到叶子节点。假设树高度为 h，最坏情况下需要 h 次交换，2h 次比较。与此同时，作为一颗完全二叉树，二叉堆的高度 h 始终小于等于 $\log$<del>2</del>$n$，也就是 $\logn$ 复杂度。</p>
<h3 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h3><p>插入的数据将被放在最末端&#x2F;最右端的叶子节点，然后对其使用上浮操作。最坏情况下需要 h 次比较，h 次交换，所以复杂度也为 $\log n$。</p>
<h2 id="堆排序对数据的初始化：建堆"><a href="#堆排序对数据的初始化：建堆" class="headerlink" title="堆排序对数据的初始化：建堆"></a>堆排序对数据的初始化：建堆</h2><h2 id="优先队列实现注意小细节"><a href="#优先队列实现注意小细节" class="headerlink" title="优先队列实现注意小细节"></a>优先队列实现注意小细节</h2><ol>
<li><p><code>sink</code> 的调用条件是当前被下沉节点的子节点索引<strong>小于等于</strong>优先队列元素数量。否则，在边界条件时，就会导致有元素没有被下沉。举个例子，当队列还有三个元素，<code>star, was, worst</code>， 删除顶端元素之后在顶端插入末尾元素 <code>worst</code>，此时 <code>worst</code> 子节点为 <code>was</code>，索引为 <code>1*2 = 2</code>，大于等于优先队列的元素总数量，<code>sink</code> 操作没有调用，<code>worst</code> 元素先于 <code>was</code> 被取出队列。</p>
</li>
<li><p>在下沉 <code>sink</code> 操作时，在将当前节点与子节点比较之前，应该先比较两个子节点。如果是大顶堆，则选出更大的节点来与父节点比较，小顶堆则选出两者中更小的节点。</p>
</li>
<li><p>在比较两子节点时，也要注意子节点索引不能越界。同样在只有两个元素时进行 <code>sink</code> 操作的情况下，只有一个子节点，试图寻找此子节点的下一个子节点将会超越数组边界。例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sink</span><span class="params">(<span class="type">int</span> k)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">2</span> * k;</span><br><span class="line">    <span class="keyword">while</span> (j &lt;= N) &#123;</span><br><span class="line">        <span class="keyword">if</span> (j+<span class="number">1</span> &lt;= N &amp;&amp; less((j + <span class="number">1</span>), j)) &#123;</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (less(j, k)) &#123;</span><br><span class="line">            exch(j, k);</span><br><span class="line">            k = j;</span><br><span class="line">            j *= <span class="number">2</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/09/Flask%20Web%20Development%20Notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jimmy Xu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
      <meta itemprop="description" content="Tu ne cede malis, sed contra audentior ito">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Rust Shrugged">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/08/09/Flask%20Web%20Development%20Notes/" class="post-title-link" itemprop="url">Flask Web Development Notes</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-08-09 22:54:00" itemprop="dateCreated datePublished" datetime="2018-08-09T22:54:00+00:00">2018-08-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">技术笔记</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">读书笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Flask-Web-Development-Notes"><a href="#Flask-Web-Development-Notes" class="headerlink" title="Flask Web Development Notes"></a>Flask Web Development Notes</h1><blockquote>
<p>这是我暑假看 Miguel 的那本著名狗书时的笔记，书的版本是最新的 second edition。当时看的是原文版，以后会写一篇文章说阅读英语原文的经验</p>
</blockquote>
<h2 id="Ch2-Basic-Application-Structure"><a href="#Ch2-Basic-Application-Structure" class="headerlink" title="Ch2 Basic Application Structure"></a>Ch2 Basic Application Structure</h2><h3 id="Run-an-app"><a href="#Run-an-app" class="headerlink" title="Run an app"></a>Run an app</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> FLASK_APP=name.py</span><br><span class="line"><span class="built_in">export</span> FLASK_DEBUG=1</span><br><span class="line">flask run</span><br></pre></td></tr></table></figure>

<h3 id="Dynamic-route"><a href="#Dynamic-route" class="headerlink" title="Dynamic route"></a>Dynamic route</h3><p>Flask supports the types <code>string</code>, <code>int</code>, <code>float</code>, and <code>path</code> for routes. The <code>path</code> type is a special <code>string</code> type.</p>
<h3 id="Response"><a href="#Response" class="headerlink" title="Response"></a>Response</h3><p><em>view function</em> could take as much as three arguments, <em>status code</em> and a <em>dictionary of headers</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&#x27;&lt;h1&gt;Bad Request&lt;/h1&gt;&#x27;</span>, <span class="number">400</span></span><br></pre></td></tr></table></figure>



<h3 id="Compatibility-with-older-version"><a href="#Compatibility-with-older-version" class="headerlink" title="Compatibility with older version"></a>Compatibility with older version</h3><p><code>app.run(debug=True)</code></p>
<p><code>app.add_url_rule()</code>: builds the map between URL and view function</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flask run --host 0.0.0.0</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install sqlite3 libsqlite3-dev</span><br></pre></td></tr></table></figure>



<h2 id="Ch3-Templates"><a href="#Ch3-Templates" class="headerlink" title="Ch3 Templates"></a>Ch3 Templates</h2><p><em>business logic</em> and <em>presentation logic</em>, Jinja2 takes the work of <em>presentation</em>. More specifically, the application only sends variables to Jinja2, after that how the HTML page is presented is up to Jinja2.</p>
<h3 id="What-this-chapter’s-mainly-about"><a href="#What-this-chapter’s-mainly-about" class="headerlink" title="What this chapter’s mainly about"></a>What this chapter’s mainly about</h3><p>Static web pages. Topics in this chapter:</p>
<ul>
<li>What are templates; how to inherit</li>
<li>How to write URLs in Flask; <code>url_for()</code> helper function; relative &amp; absolute URLs, the latter one less useful</li>
<li>How to send static files (in template format)</li>
<li>Miscellaneous: Bootstrap integration</li>
</ul>
<h2 id="Ch4-Web-Forms"><a href="#Ch4-Web-Forms" class="headerlink" title="Ch4 Web Forms"></a>Ch4 Web Forms</h2><h3 id="Form-classes-（technical"><a href="#Form-classes-（technical" class="headerlink" title="Form classes （technical)"></a>Form classes （technical)</h3><p><code>FlaskForm</code> defines the list of <code>field</code>s in each form, each represented by an object. Each <code>field</code> object have one or more <em>validators</em> attached. A <em>validator</em> is a function. Note the three terms here, <em>FlaskForm, field, validator</em>.</p>
<h3 id="Form-submission-with-GET"><a href="#Form-submission-with-GET" class="headerlink" title="Form submission with GET"></a>Form submission with GET</h3><p>Bad. GET doesn’t have a <em>body</em>, so if submit with GET method, the <em>data</em> will be appended to the URL as a <em>query string</em>, and becomes visible in the browser’s address bar.</p>
<p>Therefore, in <em>view function</em> that deals with forms, add a <code>POST</code> method like that:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br></pre></td></tr></table></figure>



<h3 id="Miscellaneous"><a href="#Miscellaneous" class="headerlink" title="Miscellaneous"></a>Miscellaneous</h3><p>This method returns <code>True</code> when form is <del>submitted</del> submitted using POST method, and the data accepted by all <em>field validators</em>; used to <em>determine</em>, whether the form needs to be <em>rendered</em> or <em>processed</em>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">	<span class="comment">###</span></span><br></pre></td></tr></table></figure>

<p>The first and only required argument to <code>url_for()</code> is the <em>endpoint</em> name.  By default, the endpoint of a route is the name of the view function attached to it. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br></pre></td></tr></table></figure>



<h2 id="Ch5-Databases"><a href="#Ch5-Databases" class="headerlink" title="Ch5 Databases"></a>Ch5 Databases</h2><h3 id="Terms"><a href="#Terms" class="headerlink" title="Terms"></a>Terms</h3><p>column: attribute of the entity; row: actual data element that <em>assigns</em> values to columns.</p>
<p>table, record –&gt; collection, document, from Relational to NoSQL</p>
<p><em>primary key</em>: a special <em>column</em>; <em>foreign keys</em>: columns</p>
<h3 id="Sum"><a href="#Sum" class="headerlink" title="Sum"></a>Sum</h3><ul>
<li>With ORM middleman, one doesn’t have to SQL semantics</li>
<li>Apply different URLs in config could migrate from different (relational) databases</li>
<li>Databases migration:<ul>
<li>Framework: <em>Flask-Migrate</em>, the <em>Alembic wrapper</em></li>
<li>Procedures: <code>flask db init</code>, creates a <em>migrations</em> directory (optional, only on a new project); <code>flask db migrate -m &quot;message&quot;</code>, <em>automatically</em> creates <em>migration script</em>, while <code>revision</code> manually; <code>flask db upgrade</code></li>
<li><code>flask db downgrade</code> and <code>... upgrade</code> gives db migrations log history like <em>git</em></li>
</ul>
</li>
</ul>
<h2 id="Ch7-Large-Application-Structure"><a href="#Ch7-Large-Application-Structure" class="headerlink" title="Ch7 Large Application Structure"></a>Ch7 Large Application Structure</h2><h3 id="Add-custom-commands-via-click"><a href="#Add-custom-commands-via-click" class="headerlink" title="Add custom commands via click"></a>Add custom commands via <em>click</em></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.cli.command()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">thatWillBetheNameofCommand</span>():</span><br><span class="line">	<span class="string">&quot;&quot;&quot;This will be shown in the help messages&quot;&quot;&quot;</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h3 id="Blueprint-detail"><a href="#Blueprint-detail" class="headerlink" title="Blueprint detail"></a>Blueprint detail</h3><ul>
<li><p>In chapter 7 about <em>blueprint</em>, the module where blueprint object is must import its routes’ view functions, because</p>
<blockquote>
<p>Importing these modules causes the routes and error handlers to be associated with the blueprint. </p>
</blockquote>
</li>
<li><p>From Eg.7.7: the blueprint name before <em>endpoint</em> can be omitted, as <code>url_for(&#39;.index&#39;)</code>. <em>Redirects</em> within the same blueprint could use the shorter form, while crossing blueprints requires the fully qualified endpoint name that includes the blueprint name.</p>
</li>
</ul>
<h2 id="Ch8-User-Authentication"><a href="#Ch8-User-Authentication" class="headerlink" title="Ch8 User Authentication"></a>Ch8 User Authentication</h2><blockquote>
<p>Hashing functions are repeatable.</p>
</blockquote>
<ul>
<li><strong>Q:</strong> How could the <code>check_password_hash(hash, password)</code> check pwd without knowing the <em>salt</em> of it?</li>
</ul>
<h3 id="WTForm-write-your-own-validator-with-validate-prefix"><a href="#WTForm-write-your-own-validator-with-validate-prefix" class="headerlink" title="WTForm: write your own validator with validate_ prefix"></a>WTForm: write your own validator with <em>validate_</em> prefix</h3><ul>
<li>for <code>wtforms</code> <em>validate_</em> prefix defines custom validators; while in Python standard library <code>unittest</code> the <em>test_</em> prefix is used.</li>
<li>any function referred the database, is defined in <code>model.py</code>, as methods in those ORM models. They access the database using <code>self.attribute</code>.</li>
</ul>
<h3 id="Flask-Login-detail"><a href="#Flask-Login-detail" class="headerlink" title="Flask-Login detail"></a>Flask-Login detail</h3><p>Flask-Login requires the application to designate a function to be invoked when the extension needs to load a user from the database given its identifier, registered with <code>@login_manager.user_loader</code> decorator.</p>
<p><code>_get_user()</code> searches for a user ID in the <em>user session</em> –&gt; invoke the function registered with the <code>user_loader</code> decorator, with the ID as argument</p>
<h2 id="Ch14-API"><a href="#Ch14-API" class="headerlink" title="Ch14 API"></a>Ch14 API</h2><p>The process of converting an internal representation to a transport format such as JSON is called <strong>serialization</strong>.</p>
<h2 id="Todo"><a href="#Todo" class="headerlink" title="Todo"></a>Todo</h2><ul>
<li><p><input disabled="" type="checkbox"> 
decorators in Python<br>They are functions that takes  a func as an arg then returns another arg</p>
</li>
<li><p><input disabled="" type="checkbox"> 
<strong>OOP</strong> concepts: constructor, method&amp;attribute<br>(so far I <em>assume</em> that) Methods are funcs, attributes are data.</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
How blocks are really defined in bootstrap&#x2F;base.html</p>
</li>
<li><p><input disabled="" type="checkbox"> 
what <code>&lt;&gt;</code> means in Python code (<code>&lt;&#123;&#39;key1&#39;: v, &#39;k2&#39;: v2&#125;&gt;</code>)</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
What is <em>label</em> in HTML<br>makes the form text clickable; same style with it.</p>
</li>
<li><p><input disabled="" type="checkbox"> </p>
<blockquote>
<p>The remaining class variables are the attributes of the model, defined as instances of the <code>db.Column</code> class.</p>
</blockquote>
<p>what is <em>instance, class variable, attribute</em></p>
</li>
<li><p><input disabled="" type="checkbox"> 
<code>with</code> keyword in Python</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
<code>__name__</code>, <code>__file__</code> and other dunder variable (<code>basedir = os.path.abspath(os.path.dirname(__file__)) </code>)</p>
<ul>
<li><code>__name__</code> has two values, <code>&quot;__main__&quot;</code> (when being executed) or the module’s name (when imported). With respect to Object, <code>__name__</code> is the special attribute of a class, function, method, descriptor, or generator instance. </li>
<li><code>__file__</code>, the absolute path of the module</li>
</ul>
</li>
<li><p><input disabled="" type="checkbox"> 
functionality of the <code>__init__.py</code> file in a directory</p>
</li>
<li><p><input disabled="" type="checkbox"> 
<strong>OOP:</strong> <code>@property</code> decorator in a class</p>
</li>
<li><p><input disabled="" type="checkbox"> 
<strong>DB:</strong> <code>users = db.relationship(&#39;User&#39;, backref=&#39;role&#39;, lazy=&#39;dynamic&#39;)</code>. “users” is a <em>column</em> of the table <em>role</em>. What does <code>lazy</code> kwarg mean</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
<strong>DB:</strong> <code>Role.query.filter_by(name=&#39;Administrator&#39;).first()</code>, type of the return value</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User.query.filter_by(username=<span class="string">&#x27;galt&#x27;</span>).first()  <span class="comment"># output: &lt;User &#x27;john&#x27;&gt;</span></span><br><span class="line">a = User.query.filter_by(username=<span class="string">&#x27;galt&#x27;</span>).first()</span><br><span class="line"><span class="built_in">type</span>(a)  <span class="comment"># output: &lt;class &#x27;app.models.User&#x27;&gt;</span></span><br></pre></td></tr></table></figure>

<p>On success, return value is the <em>row</em> in the table. <code>a.id</code> would return the <code>id</code> <em>column</em> of user <code>galt</code>.</p>
</li>
</ul>
<hr>
<ul>
<li><input disabled="" type="checkbox"> Linux command <code>export</code></li>
<li><input disabled="" type="checkbox"> <code>form.hidden_tag()</code> element for CSRF protection</li>
<li><input checked="" disabled="" type="checkbox"> How much freedom does ORM&#x2F;ODM provide in choosing DB, only different <em>rational databases</em>?<br>Yes.</li>
<li><input disabled="" type="checkbox"> <code>&#123;&#123; wtf.quick_form(form) &#125;&#125;</code>, how will this template be rendered, search keyword in the book<ul>
<li><code>&#123;&#123; name &#125;&#125;</code> construct references a <strong>variable</strong>, a <strong>placeholder</strong></li>
</ul>
</li>
<li><input disabled="" type="checkbox"> How to initialize <code>SelectField</code>, 7.31</li>
<li><input disabled="" type="checkbox"> <code>Post.query.order_by</code> will this query affect rows? 8.1</li>
</ul>
<h3 id="After-Flask"><a href="#After-Flask" class="headerlink" title="After Flask:"></a>After Flask:</h3><ul>
<li><p><input disabled="" type="checkbox"> 
WTForm package <em>validator</em> source code, I assume it’s just RegEx</p>
</li>
<li><p><input disabled="" type="checkbox"> 
For example, the execution of the <code>send_async_email()</code> function can be sent to a <a target="_blank" rel="noopener" href="http://www.celeryproject.org/">Celery</a> task queue. (p.107)</p>
</li>
<li><p><input disabled="" type="checkbox"> 
<strong>Decorator:</strong> How different orders affects the registered function</p>
</li>
<li><p><input disabled="" type="checkbox"> 
<strong>Thread:</strong> <em>worker thread</em> in Flask doc</p>
</li>
<li><p><input disabled="" type="checkbox"> 
<strong>Iterator</strong> and that: </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">follows = [&#123;<span class="string">&#x27;user&#x27;</span>: item.follower, <span class="string">&#x27;timestamp&#x27;</span>: item.timestamp&#125;</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> pagination.items]</span><br></pre></td></tr></table></figure></li>
</ul>
<p>Check yourself: </p>
<ul>
<li>How to add a new row in a table, how to change a column of a row</li>
<li>Page 182, how the foreign key of a table is added</li>
</ul>
<hr>
<ul>
<li><p>synopsis: brief summary</p>
</li>
<li><p>delimiter (<em>programming</em>)</p>
</li>
<li><p>miscellaneous</p>
</li>
<li><p><em>callable</em>, page 65</p>
</li>
<li><p>cardinality alchemy, transparent (Ch5)</p>
</li>
<li><blockquote>
<p>build a perfect <strong>replica</strong> of the virtual environment…</p>
</blockquote>
</li>
</ul>
<h2 id="Appendix"><a href="#Appendix" class="headerlink" title="Appendix"></a>Appendix</h2><h3 id="Object-in-Python"><a href="#Object-in-Python" class="headerlink" title="Object in Python"></a>Object in Python</h3><p>type of methods:</p>
<ul>
<li><em>instance method</em>, the 1st argument of it <em>must</em> be <code>self</code>; any method taking <code>self</code> as the 1st arg is a <em>instance method</em></li>
<li><em>class method</em>, <code>@classmethod</code>, <code>cls</code> as the 1st arg. Calling: <code>Obj().count()</code>, where <code>Obj</code> is the name of a class</li>
<li><em>static method</em>， <code>@staticmethod</code>. E.g. <code>Obj().someStaticMethod()</code></li>
</ul>
<p><code>super()</code> in Python2.x takes its own class as the first variable, like <code>super(Child, self).__init__(age, height)</code>. Also the <em>parent</em> shall be defined as <code>class Parent(object)</code>, having <code>object</code> as base class.</p>
<h3 id="REST-API"><a href="#REST-API" class="headerlink" title="REST API"></a>REST API</h3><ul>
<li>more business logic on client side</li>
<li>client could <em>discover</em> resources using different URL compositions</li>
<li>versioning for backward compatibility</li>
</ul>
<h3 id="Compare-to-Mage-Tutorial"><a href="#Compare-to-Mage-Tutorial" class="headerlink" title="Compare to Mage Tutorial"></a>Compare to Mage Tutorial</h3><ol>
<li>_get</li>
<li>plain text and HTML email</li>
<li>from GitHub’s <em>commit</em> history you could view specifically what changed in every commit</li>
</ol>
<h3 id="Test-amp-Caution"><a href="#Test-amp-Caution" class="headerlink" title="Test &amp; Caution"></a>Test &amp; Caution</h3><ol>
<li><p>Think of <strong>boundary values</strong> while designing programs.</p>
<ul>
<li><code>current_user.confirmed</code></li>
<li><code>@login_required</code></li>
<li><code>self.email.lower()</code> ensure that the string is lowercase</li>
<li><code>verify_password(email, password):</code> before loading user from DB to check pwd, <code>email</code> must be checked first not to be <code>&#39;&#39;</code></li>
</ul>
</li>
<li><p>Crucial cases where proxies provided by Flask like<code>current_app</code> can’t fake:</p>
<ul>
<li><code>current_app</code> can’t fake its type as the actual object type</li>
<li>when sending <em>Signals</em> or passing data <em>to a background thread</em></li>
</ul>
<p> best practice:</p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app = current_app._get_current_object()</span><br><span class="line">my_signal.send(app)</span><br></pre></td></tr></table></figure>
</li>
<li><pre><code class="python"> from sqlalchemy.exc import IntegrityError
 try:
     db.session.commit()
 except IntegrityError:
     db.session.rollback()
</code></pre>
</li>
<li><p><code>form.body.data = post.body</code>; how to render page according to attributes of the user;  Context processors make variables available to all templates during rendering</p>
</li>
<li><p><code>from app.exceptions import</code></p>
</li>
</ol>
<h3 id="The-power-of-Flask-Shell"><a href="#The-power-of-Flask-Shell" class="headerlink" title="The power of Flask Shell"></a>The power of Flask Shell</h3><p>Page 214, static method <code>add_self_follows()</code> that manipulates existed <em>rows</em></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jimmy Xu</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
