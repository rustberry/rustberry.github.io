<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.1" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.1">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.1" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.4.1',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="programming and free market">
<meta property="og:type" content="website">
<meta property="og:title" content="Rust Shrugged">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Rust Shrugged">
<meta property="og:description" content="programming and free market">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Rust Shrugged">
<meta name="twitter:description" content="programming and free market">






  <link rel="canonical" href="http://yoursite.com/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Rust Shrugged</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Rust Shrugged</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about" rel="section">
      <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />About</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />Tags</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories" rel="section">
      <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />Categories</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives" rel="section">
      <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />Archives</a>
  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/03/java.io 梳理与其中的三种设计模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Rust">
      <meta itemprop="description" content="programming and free market">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/03/java.io 梳理与其中的三种设计模式/" itemprop="url">
                  java.io 梳理与其中的三种设计模式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-08-03 00:00:09 / Modified: 00:25:29" itemprop="dateCreated datePublished" datetime="2019-08-03T00:00:09+08:00">2019-08-03</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Design-Patterns/" itemprop="url" rel="index"><span itemprop="name">Design Patterns</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="java-io-梳理与其中的三种设计模式"><a href="#java-io-梳理与其中的三种设计模式" class="headerlink" title="java#io 梳理与其中的三种设计模式"></a>java#io 梳理与其中的三种设计模式</h1><p>以 <code>Reader</code> 抽象类下的类为例。它们的主要构造函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FilterReader(Reader)</span><br><span class="line">BufferedReader(Reader)</span><br><span class="line"></span><br><span class="line">FileReader(File)</span><br><span class="line">StringReader(String)</span><br><span class="line">InputStreamReader(InputStream [, Charset])</span><br></pre></td></tr></table></figure>
<p><img src="/content/images/2019/ReaderUML.png" alt="Reader UML"></p>
<p>大致上，<code>java.io</code> 可以分为：</p>
<ol>
<li>字节流操作：<code>InputStream</code>、<code>OutputStream</code></li>
<li>字符操作：<code>Reader</code>、<code>Writer</code></li>
<li>针对磁盘操作：<code>File</code></li>
</ol>
<h2 id="适配器模式-Adapter-pattern"><a href="#适配器模式-Adapter-pattern" class="headerlink" title="适配器模式 Adapter pattern"></a>适配器模式 Adapter pattern</h2><p><code>InputStreamReader</code> 是字节流与字符流之间的桥梁，它的实现使用了适配器模式。适配器模式通过聚合将某个接口适配成为另一个接口来方便使用，类图如下：</p>
<p><img src="/content/images/2019/InputStreamReaderAdapterPattern.png" alt="InputStreamReader Adapter Pattern"></p>
<p>在开头的代码可以看到，<code>InputStreamReader</code> 的构造器需要传入一个字节流 <code>InputSream</code>，以及可选的字符集。如果没有传入字符集就会使用默认的。通过持有一个 <code>InputStream</code>，<code>InputStreamReader</code> 拥有了该接口的功能。同时，<code>InputStreamReader</code> 还是一个实现了 <code>Reader</code> 类，这样一来它就把 <code>InputStream</code> 适配成了一个 <code>Reader</code> 类。</p>
<h2 id="装饰器模式-Decorator-pattern"><a href="#装饰器模式-Decorator-pattern" class="headerlink" title="装饰器模式 Decorator pattern"></a>装饰器模式 Decorator pattern</h2><p>这个应该是 <code>java.io</code> 更为人熟知的，装饰器模式与适配器模式都可以看作包装模式 Wrapper。通过对类的层层包裹，装饰器模式增强了目标类的功能。类图示意如下：</p>
<p><img src="/content/images/2019/IODecoratorPattern.png" alt="IO Decorator Pattern"></p>
<p><code>Decorator</code> 是 <code>Component</code> 的实现类，但是其内部也持有一个 <code>Decorator</code> 类。不同的 <code>Decorator</code> 类下的 <code>ConcreteDecorator</code> 子类包含了需要增强的功能。</p>
<p>在 <code>java.io</code> 中的典型使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FilterReader pbr = <span class="keyword">new</span> PushbackReader(</span><br><span class="line">        <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(System.in)))</span><br></pre></td></tr></table></figure>
<h3 id="二者的不同"><a href="#二者的不同" class="headerlink" title="二者的不同"></a>二者的不同</h3><p>装饰器模式更多的是对目标类的功能上的增强；适配器没有对功能进行增进，只是为了使目标类能适应调用方的接口，方便被调用。</p>
<h2 id="模板方法"><a href="#模板方法" class="headerlink" title="模板方法"></a>模板方法</h2><p>在模板方法模式中，大的算法框架在抽象父类中被定义好，某些业务相关的实现则延迟到子类。</p>
<p>在 <code>Reader</code> 抽象类中，<code>read</code> 方法的默认实现都留给了被重载的 <code>read(char[], int, int)</code>，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">read</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>[] cbuf)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(<span class="keyword">char</span>[] cbuf, <span class="keyword">int</span> offset, <span class="keyword">int</span> len)</span></span></span><br></pre></td></tr></table></figure>
<p>具体的 <code>read</code> 的实现留给子类。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/25/tiny-spring 踩坑记录（一）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Rust">
      <meta itemprop="description" content="programming and free market">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/25/tiny-spring 踩坑记录（一）/" itemprop="url">
                  tiny-spring 踩坑记录（一）可变长泛型参数与堆污染
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-07-25 09:23:11 / Modified: 09:29:12" itemprop="dateCreated datePublished" datetime="2019-07-25T09:23:11+08:00">2019-07-25</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="可变长泛型参数与堆污染"><a href="#可变长泛型参数与堆污染" class="headerlink" title="可变长泛型参数与堆污染"></a>可变长泛型参数与堆污染</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><blockquote>
<p>什么是堆污染</p>
</blockquote>
<p>一个类型为泛型 <code>T</code> 的变量被指向一个类型不是 <code>T</code> 的对象，这就是堆污染。典型的情况是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;T&gt; listOfTs = <span class="keyword">new</span> ArrayList&lt;&gt;(Arrays.asList(t));</span><br><span class="line">List&lt;E&gt; listOfEs = (List&lt;E&gt;)(Object)listOfTs; <span class="comment">// 此时指向了含有 T 的 List, 但是不会抛出异常，只是在 Object -&gt; List&lt;E&gt; 的转型中抛出警告</span></span><br><span class="line"></span><br><span class="line">E e = listOfEs.get(<span class="number">0</span>);  <span class="comment">// 运行时错误，java.lang.ClassCastException</span></span><br></pre></td></tr></table></figure>
<p>之所以编译器无法在转型时检查出类型转换错误，是因为 Java 泛型是通过类型擦除实现的，在泛型代码内部无法获得任何有关泛型参数类型的信息。</p>
<p>一个更好一点的关于可变长泛型参数和堆污染一起的例子，来自 <a href="https://docs.oracle.com/javase/tutorial/java/generics/nonReifiableVarargsType.html" target="_blank" rel="noopener">Oracle 官方文档</a>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">faultyMethod</span><span class="params">(List&lt;String&gt;... l)</span> </span>&#123;</span><br><span class="line">    Object[] objectArray = l;     <span class="comment">// Valid</span></span><br><span class="line">    objectArray[<span class="number">0</span>] = Arrays.asList(<span class="number">42</span>);</span><br><span class="line">    String s = l[<span class="number">0</span>].get(<span class="number">0</span>);       <span class="comment">// ClassCastException thrown here</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于泛型的<a href="https://docs.oracle.com/javase/tutorial/java/generics/restrictions.html" target="_blank" rel="noopener">几大限制</a>中，最明显的一个就是不能创造泛型数组，如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt;[] arrayOfLists = <span class="keyword">new</span> List&lt;Integer&gt;[<span class="number">2</span>];  <span class="comment">// compile-time error</span></span><br></pre></td></tr></table></figure>
<p>但是这一限制在可变长的泛型参数中被打破了。在可变长参数中，一个数组会在函数调用时建立（Effective Java，Item 53），每次调用都会引起一次数组分配和初始化。当可变长参数是泛型时，一个泛型数组就被创造出来了。</p>
<h3 id="实操时的问题"><a href="#实操时的问题" class="headerlink" title="实操时的问题"></a>实操时的问题</h3><p>我在 tiny-spring 中写了一个方法，给定注解参数，获取所有带有该注解的类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getClassSetByAnnotation(Class&lt;? extends Annotation&gt;... cls) &#123;</span><br><span class="line">    Set&lt;Class&lt;?&gt;&gt; classSet = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; c : getClassSet(basePkg)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;? extends Annotation&gt; annotationCls : cls) &#123;</span><br><span class="line">            <span class="keyword">if</span> (c.isAnnotationPresent(annotationCls)) &#123;</span><br><span class="line">                classSet.add(c);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> classSet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就出现了一个可变长泛型参数的问题。另一个隐藏的问题是，这个方法并没有对传入的注解参数的数量检查参数为零的情况，而可变长参数允许传入零个参数。一个优美一点的解决方案是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SafeVarargs</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getClassSetByAnnotation(Class&lt;? extends Annotation&gt; firstCls, Class&lt;? extends Annotation&gt;... cls) &#123;</span><br><span class="line">    Set&lt;Class&lt;?&gt;&gt; classSet = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; c : getClassSet(basePkg)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (c.isAnnotationPresent(firstCls)) &#123;</span><br><span class="line">            classSet.add(c);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;? extends Annotation&gt; annotationCls : cls) &#123;</span><br><span class="line">            <span class="keyword">if</span> (c.isAnnotationPresent(annotationCls)) &#123;</span><br><span class="line">                classSet.add(c);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> classSet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样既省去明显的检查参数数量，又能在调用处强制调用者传入至少一个参数，这也是这个方法的本意。</p>
<h3 id="SafeVarargs-的使用标准"><a href="#SafeVarargs-的使用标准" class="headerlink" title="@SafeVarargs 的使用标准"></a>@SafeVarargs 的使用标准</h3><p>如上所见，可以将报警用 <code>@SafeVarargs</code> 注解掉。但是我们知道，这个注解仅仅是消除编译警告，完全不能保证消除这个错误。那么什么时候应该使用这个注解呢？</p>
<p>在 StackOverflow 有一个票的<a href="https://stackoverflow.com/a/14252221" target="_blank" rel="noopener">回答</a>：</p>
<p>If your method has an argument of type <code>T...</code> (where T is any type parameter), then:</p>
<ul>
<li>Safe: If your method only depends on the fact that the elements of the array are instances of <code>T</code></li>
<li>Unsafe: If it depends on the fact that the array is an instance of <code>T[]</code></li>
</ul>
<p>Effective Java 也表示了类似的意思：如果你的方法使用可变长泛型参数的时候，只是用来一次传入多个参数，并且实际使用的时候只是把它们当作多个参数来看，那么就没有问题。如果你的方法体中把可变长参数当作数组来使用，那就会有问题，不要使用这个注解。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/20/并发编程bug之源：死锁成因与重排序/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Rust">
      <meta itemprop="description" content="programming and free market">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/20/并发编程bug之源：死锁成因与重排序/" itemprop="url">
                  并发编程bug之源：死锁成因与重排序
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-06-20 00:00:00 / Modified: 23:44:08" itemprop="dateCreated datePublished" datetime="2019-06-20T00:00:00+08:00">2019-06-20</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Concurrency/" itemprop="url" rel="index"><span itemprop="name">Concurrency</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Java-内存模型"><a href="#Java-内存模型" class="headerlink" title="Java 内存模型"></a>Java 内存模型</h1><p>每学习一个新概念时，一个有效的办法就是问自己，为什么需要这个技术，这个技术试图解决什么问题？怎么解决的？套用在 Java 内存模型 JMM 上，就是如下的问题：</p>
<ul>
<li>为什么需要JMM，它试图解决什么问题？</li>
<li>JMM是如何解决可见性等各种问题的？类似volatile，体现在具体用例中有什么效果？</li>
</ul>
<p>这篇文章先分析为什么需要 JMM，然后顺便分析另一大并发 bug 来源，死锁。</p>
<h3 id="从源代码到机器码会经历重排序"><a href="#从源代码到机器码会经历重排序" class="headerlink" title="从源代码到机器码会经历重排序"></a>从源代码到机器码会经历重排序</h3><p>重排序，这就是需要一个统一 JMM 模型的原因。</p>
<ol>
<li>编译器在<em>不改变程序语义</em>的前提下，重新安排语句执行顺序。（例子）</li>
<li>指令级并行 Instruction Level Parallelism（搜索关键词：ILP），改变机器指令的执行顺序。（用于方便流水线，提高并行度 parallelism）</li>
<li>内存系统重排序。现代的处理器使用写缓冲区（CPU cache）临时保存向内存写入的数据。<br><strong>为什么内存重排：</strong>写缓冲区可以保证指令流水线持续运行，它可以避免由于处理器停顿下来等待向内存写入数据而产生的延迟。同时，通过以批处理的方式刷新写缓冲区，以及合并写缓冲区中对同一内存地址的多次写，减少对内存总线的占用。<br><strong>导致的问题：</strong>当多个CPU同时（在另一个CPU写回之前）将同一个变量读入cache，任意一个CPU对该块内存的操作对于其他CPU来说都是不可见的。到写回内存时，先写入内存的就会被后写入的覆盖。</li>
</ol>
<p>编译器重排序：1，处理器重排序：2，3。</p>
<p>ILP 重排应对方式：在编译生成指令序列时，插入由CPU支持的内存屏障 Memory Barriers（搜索关键词：Intel Memory Fence）</p>
<p>重排的依据：</p>
<p><strong>数据依赖性：</strong>如果两个操作访问同一个变量，且这两个操作中有一个为写操作，此时这两个操作之间就存在数据依赖性。</p>
<p><strong>控制依赖性：</strong>看一段程序：<code>if (flag) int i *= 3;</code>。在这里，<code>if</code>这个操作A 和<code>i *= 3</code>这个操作B 存在控制依赖关系，只有操作A 完成了，才能确定是否执行操作 B。这样，并行度就被降低了。处理器通过猜测执行（Speculation），可以在执行操作A的同时计算 <code>i</code> 的值，如果操作A 为 true 就让 <code>i</code> 等于计算结果，否则不等于。</p>
<p>给（应用）程序员提供统一的内存模型还有一个原因是覆盖掉各种不同底层机器的差异，Intel，AMD，PowerPC，不同处理器有些内存一致（Cache Coherence）有些不遵循。</p>
<h1 id="死锁的成因与各种应对"><a href="#死锁的成因与各种应对" class="headerlink" title="死锁的成因与各种应对"></a>死锁的成因与各种应对</h1><p>银行两个账户之间的 Transfer 是很好的例子。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Account from, Account to, <span class="keyword">int</span> amnt)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(from) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(to) &#123;</span><br><span class="line">            from.setAmount(from.getAmount() - amnt);</span><br><span class="line">            to.setAmount(to.getAmount() + amnt);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要形成死锁 Deadlock，必备的四个条件，缺一不可：</p>
<ol>
<li>互斥。某一代码块同一时刻只能一个线程执行。一般都会存在。</li>
<li>hold and wait。抢到锁却继续等待其他资源（锁）</li>
<li>循环等待。两个线程互相等待对方</li>
<li>无法超时/剥夺的等待。</li>
</ol>
<p>对应方法：</p>
<ol>
<li>一般是基础条件，无法破除</li>
<li>用一把锁一次性获得所有资源。例子中，可以加上全局锁，确保<code>from</code> 和 <code>to</code> 可以被同时拿到。缺点：效率低下。</li>
<li>在锁之间创造先后顺序。需要获取两个锁时，优先尝试 <code>id</code> 大的那个。</li>
<li>加入超时。缺点：等待时间太久。拿到锁 <code>from</code> 后尝试获取锁 <code>to</code>，失败则立即释放锁 <code>from</code>，过一段时间（）再尝试。</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/22/程序员必知的内存知识/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Rust">
      <meta itemprop="description" content="programming and free market">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/22/程序员必知的内存知识/" itemprop="url">
                  程序员必知的内存知识
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-05-22 00:00:00 / Modified: 23:50:00" itemprop="dateCreated datePublished" datetime="2019-05-22T00:00:00+08:00">2019-05-22</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Computer-Organization/" itemprop="url" rel="index"><span itemprop="name">Computer Organization</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>原文地址：<a href="https://lwn.net/Articles/252125/" target="_blank" rel="noopener">https://lwn.net/Articles/252125/</a></p>
</blockquote>
<h1 id="What-every-programmer-should-know-about-memory"><a href="#What-every-programmer-should-know-about-memory" class="headerlink" title="What every programmer should know about memory"></a>What every programmer should know about memory</h1><h2 id="Part-2-CPU-Caches"><a href="#Part-2-CPU-Caches" class="headerlink" title="Part 2: CPU Caches"></a>Part 2: CPU Caches</h2><h2 id="程序员必知的内存知识"><a href="#程序员必知的内存知识" class="headerlink" title="程序员必知的内存知识"></a>程序员必知的内存知识</h2><h2 id="第二部分：CPU-缓存"><a href="#第二部分：CPU-缓存" class="headerlink" title="第二部分：CPU 缓存"></a>第二部分：CPU 缓存</h2><p>[Editor’s note: This is the second installment in Ulrich Drepper’s “What every programmer should know about memory” document. Those who have not read the first part will likely want to start there. This is good stuff, and we once again thank Ulrich for allowing us to publish it.]<br>[编者注：这是Ulrich Drepper的文章“程序员必知的内存知识”的第二部分。那些没有阅读过第一部分的人可能会想从那看起。这篇文章很棒，再次感谢Ulrich允许我们发布它。]</p>
<p>CPUs are today much more sophisticated than they were only 25 years ago. In those days, the frequency of the CPU core was at a level equivalent to that of the memory bus. Memory access was only a bit slower than register access. But this changed dramatically in the early 90s, when CPU designers increased the frequency of the CPU core but the frequency of the memory bus and the performance of RAM chips did not increase proportionally. This is not due to the fact that faster RAM could not be built, as explained in the previous section. It is possible but it is not economical. RAM as fast as current CPU cores is orders of magnitude more expensive than any dynamic RAM.<br>如今的CPU比25年前更加复杂。25年前，CPU内核的频率处于与内存总线相当的水平。访问内存只比访问寄存器慢一点。但是在90年代早期，当CPU设计人员提高CPU内核的频率而内存总线的频率和RAM（random-access memory，内存；随机存取存储器）芯片的性能没有按比例增加时，这种情况发生了巨大的变化。如上一节所述，这不是因为无法建造更快的RAM。造更快的RAM是可能的，但这样做不经济。与当前CPU内核一样快的RAM比任何动态RAM都要贵上几个数量级。</p>
<p>If the choice is between a machine with very little, very fast RAM and a machine with a lot of relatively fast RAM, the second will always win given a working set size which exceeds the small RAM size and the cost of accessing secondary storage media such as hard drives. The problem here is the speed of secondary storage, usually hard disks, which must be used to hold the swapped out part of the working set. Accessing those disks is orders of magnitude slower than even DRAM access.<br>如果非要在在具有非常小、非常快的RAM的机器和具有大量相对较快RAM的机器之间做一个选择，那么第二个方案总是更好的选择，如果给定的工作集大小超过小RAM的大小和访问硬盘之类的二级辅助存储介质的成本。问题在于二级存储的速度。二级储存通常是硬盘，它必须够大来保存工作集中从内存交换给它的部分。访问这些磁盘的速度比访问DRAM（动态随机存取存储器，Dynamic Random Access Memory）慢几个数量级。</p>
<p>Fortunately it does not have to be an all-or-nothing decision. A computer can have a small amount of high-speed SRAM in addition to the large amount of DRAM. One possible implementation would be to dedicate a certain area of the address space of the processor as containing the SRAM and the rest the DRAM. The task of the operating system would then be to optimally distribute data to make use of the SRAM. Basically, the SRAM serves in this situation as an extension of the register set of the processor.<br>幸运的是，我们并不需要做这种非黑即白的决定。计算机可以在拥有大量DRAM的同时带有少量的高速SRAM（静态随机存储器，Static Random Access Memory）。一种可能的实现方式是将处理器地址空间的某个区域用SRAM存储而将其余部分用DRAM。接下来，操作系统的任务就是最佳地分配数据以利用SRAM。基本上，SRAM在这种情况下被用作处理器寄存器组的扩展。</p>
<p>While this is a possible implementation, it is not viable. Ignoring the problem of mapping the physical resources of such SRAM-backed memory to the virtual address spaces of the processes (which by itself is terribly hard) this approach would require each process to administer in software the allocation of this memory region. The size of the memory region can vary from processor to processor (i.e., processors have different amounts of the expensive SRAM-backed memory). Each module which makes up part of a program will claim its share of the fast memory, which introduces additional costs through synchronization requirements. In short, the gains of having fast memory would be eaten up completely by the overhead of administering the resources.<br>虽然这是一种可能的实现方式，但它并不可行。即使先忽略将这种SRAM支持的内存的物理地址映射到进程的虚拟地址空间（这本身就非常困难）所产生的问题，这种方法要求每个进程直接在软件中管理该存储区域的分配。存储区域的大小将随处理器而变化（即，不同处理器具有不同数量的昂贵的SRAM支持的内存）。构成一个程序的每个模块都将试图占用其快速存储器的份额，这又会因为协调不同要求而引入额外的成本。简而言之，拥有快速内存的收益将完全被管理资源带来的开销所抵消。</p>
<p>So, instead of putting the SRAM under the control of the OS or user, it becomes a resource which is transparently used and administered by the processors. In this mode, SRAM is used to make temporary copies of (to cache, in other words) data in main memory which is likely to be used soon by the processor. This is possible because program code and data has temporal and spatial locality. This means that, over short periods of time, there is a good chance that the same code or data gets reused. For code this means that there are most likely loops in the code so that the same code gets executed over and over again (the perfect case for spatial locality). Data accesses are also ideally limited to small regions. Even if the memory used over short time periods is not close together there is a high chance that the same data will be reused before long (temporal locality). For code this means, for instance, that in a loop a function call is made and that function is located elsewhere in the address space. The function may be distant in memory, but calls to that function will be close in time. For data it means that the total amount of memory used at one time (the working set size) is ideally limited but the memory used, as a result of the random access nature of RAM, is not close together. Realizing that locality exists is key to the concept of CPU caches as we use them today.<br>因此，我们不应该将SRAM置于操作系统或用户的控制之下，而应该让它成为由处理器透明地使用和管理的资源。这时，SRAM用于临时复制（或者缓存）主存中那些可能即将被处理器使用的数据。这种做法是可行的，因为程序代码和数据具有时间和空间局部性。这意味着，在很短的时间内，曾经被使用过的代码和数据很有可能被再次使用。从代码的层面来说，这意味着代码中很可能存在循环，所以相同的代码一次又一次地执行（空间局部性的完美情况）。理想情况下，数据访问也仅限于很小的内存区域内。即使在短时间段内访问的内存不紧凑，也很有可能不久之后重复使用相同的数据（时间局部性）。从代码的层面来说，这时可能在循环中进行函数调用，并且该函数位于地址空间的其他位置。该函数可能在内存中相距甚远，但时间上对该函数的调用并不遥远。对于数据，这意味着每次使用的内存的总量（工作集大小）是有限的，但由于RAM 的随机访问性质，所使用的内存并不需要被紧凑地存储在一起。当我们今天使用CPU缓存时，意识到存在局部性理解是CPU缓存概念的关键。</p>
<p>A simple computation can show how effective caches can theoretically be. Assume access to main memory takes 200 cycles and access to the cache memory take 15 cycles. Then code using 100 data elements 100 times each will spend 2,000,000 cycles on memory operations if there is no cache and only 168,500 cycles if all data can be cached. That is an improvement of 91.5%.<br>一个简单的计算可以显示理论上缓存有多有效。假设访问主存储器需要200个时钟周期而访问高速缓冲存储器需要15个周期。然后，如果没有缓存，则对100个数据元素使用100次的代码将在内存操作上花费2,000,000个周期，如果所有数据都可以缓存，则仅花费168,500个周期。这可是91.5％的改善。</p>
<p>The size of the SRAM used for caches is many times smaller than the main memory. In the author’s experience with workstations with CPU caches the cache size has always been around 1/1000th of the size of the main memory (today: 4MB cache and 4GB main memory). This alone does not constitute a problem. If the size of the working set (the set of data currently worked on) is smaller than the cache size it does not matter. But computers do not have large main memories for no reason. The working set is bound to be larger than the cache. This is especially true for systems running multiple processes where the size of the working set is the sum of the sizes of all the individual processes and the kernel.<br>用于缓存的SRAM的大小比主存小许多倍。在作者使用带CPU缓存的工作站的经验中，缓存大小一直是主内存大小的1/1000（现在：4MB缓存和4GB主存）。仅这一点不构成问题。如果工作集的大小（当前处理的数据的大小）小于缓存大小则无关紧要。但计算机不是无缘无故配有大容量主存的。工作集一定会大于缓存。对于运行多个进程的系统尤其如此：其工作集的大小是所有单个进程和内核的大小的总和。</p>
<p>What is needed to deal with the limited size of the cache is a set of good strategies to determine what should be cached at any given time. Since not all data of the working set is used at exactly the same time we can use techniques to temporarily replace some data in the cache with other data. And maybe this can be done before the data is actually needed. This prefetching would remove some of the costs of accessing main memory since it happens asynchronously with respect to the execution of the program. All these techniques and more can be used to make the cache appear bigger than it actually is. We will discuss them in Section 3.3. Once all these techniques are exploited it is up to the programmer to help the processor. How this can be done will be discussed in Section 6.<br>处理缓存大小有限问题所需要的是一组好的策略，来确定在什么时间应该缓存什么。由于工作组的数据不会被同时全部访问，我们可以用技术来将缓存中的一些数据暂时替换成其它数据。这种替换可以在实际需要这些数据之前完成。预先缓存数据将消除访问主存的一些成本，因为它与程序的执行异步发生。这种技术和更多其它技术可使得缓存显得比实际容量更大。我们将在3.3节讨论这一点。在所有这些技术被使用之后，就需要靠程序员来帮助处理器了。如何做到这一点将在第6节中讨论。</p>
<p>3.1 CPU Caches in the Big Picture<br>3.1 CPU 缓存在计算机整体层面上的地位<br>Before diving into technical details of the implementation of CPU caches some readers might find it useful to first see in some more details how caches fit into the “big picture” of a modern computer system.<br>在深入研究实现CPU缓存的技术细节之前，一些读者可能会觉得，首先更多了解缓存在现代计算机系统的“大局”中的地位会有帮助。</p>
<p>Figure 3.1: Minimum Cache Configuration<br>图 3.1：最小缓存配置<br>Figure 3.1 shows the minimum cache configuration. It corresponds to the architecture which could be found in early systems which deployed CPU caches. The CPU core is no longer directly connected to the main memory. {In even earlier systems the cache was attached to the system bus just like the CPU and the main memory. This was more a hack than a real solution.} All loads and stores have to go through the cache. The connection between the CPU core and the cache is a special, fast connection. In a simplified representation, the main memory and the cache are connected to the system bus which can also be used for communication with other components of the system. We introduced the system bus as “FSB” which is the name in use today; see Section 2.2. In this section we ignore the Northbridge; it is assumed to be present to facilitate the communication of the CPU(s) with the main memory.<br>图3.1显示了最小缓存配置的情况。它所对应的架构可以在早期部署CPU缓存的系统中找到。CPU内核不再直接连接到主内存。（在更早的系统中，缓存像CPU和主存一样连接到系统总线。这更像是一种权宜之计而不是真正的解决方案。）所有加载和存储都必须通过缓存。CPU内核和缓存之间的连接是一种特殊的快速连接。简单来说，主存和高速缓存连接到系统总线，系统总线也可用于与系统的其他组件通信。我们介绍系统总线时叫它“FSB”，这是目前使用的名称; 见2.2节。在本节中，我们忽略北桥，只有在帮助 CPU与主存储器的通信时我们才假设它存在。</p>
<p>Even though computers for the last several decades have used the von Neumann architecture, experience has shown that it is of advantage to separate the caches used for code and for data. Intel has used separate code and data caches since 1993 and never looked back. The memory regions needed for code and data are pretty much independent of each other, which is why independent caches work better. In recent years another advantage emerged: the instruction decoding step for the most common processors is slow; caching decoded instructions can speed up the execution, especially when the pipeline is empty due to incorrectly predicted or impossible-to-predict branches.<br>尽管在过去几十年中计算机一直在使用冯诺伊曼（von Neumann）架构，但实践表明，把用于代码和数据的高速缓存分离是有利的。Intel（英特尔）自1993年以来一直使用分开的代码和数据缓存，从未改变过。代码和数据所需的内存区域几乎彼此独立地储存着，这就是独立缓存更有效的原因。近年来出现了另一个优点：处理器的指令解码步骤一般都很慢; 缓存解码过的指令可以加速执行，特别是当流水线由于错误预测或无法预测的分支而为空时。</p>
<p>Soon after the introduction of the cache, the system got more complicated. The speed difference between the cache and the main memory increased again, to a point that another level of cache was added, bigger and slower than the first-level cache. Only increasing the size of the first-level cache was not an option for economical reasons. Today, there are even machines with three levels of cache in regular use. A system with such a processor looks like Figure 3.2. With the increase on the number of cores in a single CPU the number of cache levels might increase in the future even more.<br>引入缓存后不久，系统变得更加复杂。缓存和主存之间的速度差异再次增大，以至于增加了另一级缓存，比第一级缓存更大，更慢。出于经济原因，仅增加第一级缓存的大小不是一种选择。今天，甚至有常规的使用三级缓存的机器。具有这种处理器的系统如图3.2所示。随着单个CPU中核心数量的增加，未来缓存级别的数量可能会增加。</p>
<p>Figure 3.2: Processor with Level 3 Cache<br>图3.2：具有3级缓存的处理器</p>
<p>Figure 3.2 shows three levels of cache and introduces the nomenclature we will use in the remainder of the document. L1d is the level 1 data cache, L1i the level 1 instruction cache, etc. Note that this is a schematic; the data flow in reality need not pass through any of the higher-level caches on the way from the core to the main memory. CPU designers have a lot of freedom designing the interfaces of the caches. For programmers these design choices are invisible.<br>图3.2显示了三级缓存，并介绍了我们将在本文档的其余部分中使用的命名法。L1d代表1级数据高速缓存，L1i代表1级指令高速缓存，以此类推。注意这是一个原理图; 实际中，数据流可以在从核心到主存的路上不通过任何更高级别的高速缓存。CPU设计人员可以自由设计高速缓存的接口。对于程序员来说，这些设计选择是不可见的。</p>
<p>In addition we have processors which have multiple cores and each core can have multiple “threads”. The difference between a core and a thread is that separate cores have separate copies of (almost {Early multi-core processors even had separate 2nd level caches and no 3rd level cache.}) all the hardware resources. The cores can run completely independently unless they are using the same resources—e.g., the connections to the outside—at the same time. Threads, on the other hand, share almost all of the processor’s resources. Intel’s implementation of threads has only separate registers for the threads and even that is limited, some registers are shared. The complete picture for a modern CPU therefore looks like Figure 3.3.<br>此外，我们的处理器具有多个内核，每个内核可以有多个“线程”。核心和线程之间的区别在于，单独的核心具有（几乎{ 早期多核处理器甚至具有单独的第二级高速缓存而没有第三级高速缓存。 }）所有硬件资源的单独副本。核心可以完全彼此独立运行，除非它们使用到了相同的资源——例如与外部的连接——并且在同一时刻用到。另一方面，线程几乎共享处理器的所有资源。英特尔的线程实现中，线程只有寄存器是各自使用的。即使这一点也是有限的，一些寄存器是共享的。因此，现代CPU的完整图片如图3.3所示。</p>
<p>Figure 3.3: Multi processor, multi-core, multi-thread<br>图3.3：多处理器，多核，多线程<br>In this figure we have two processors, each with two cores, each of which has two threads. The threads share the Level 1 caches. The cores (shaded in the darker gray) have individual Level 1 caches. All cores of the CPU share the higher-level caches. The two processors (the two big boxes shaded in the lighter gray) of course do not share any caches. All this will be important, especially when we are discussing the cache effects on multi-process and multi-thread applications.<br>在这个图中有两个处理器，每个处理器有两个内核，每个内核有两个线程。线程共享1级缓存。核心（深灰色阴影）具有单独的1级缓存。CPU的所有核心共享更高级别的缓存。两个处理器（两个浅灰色阴影的大框）不共享任何缓存。所有这些都很重要，尤其是当我们讨论多进程和多线程应用程序的缓存效果时。</p>
<p>3.2 Cache Operation at High Level<br>3.2高级别的缓存操作<br>To understand the costs and savings of using a cache we have to combine the knowledge about the machine architecture and RAM technology from Section 2 with the structure of caches described in the previous section.<br>要了解使用缓存的成本和优点，我们必须将第2节中的机器架构和RAM技术的知识与上一节中描述的缓存结构相结合</p>
<p>By default all data read or written by the CPU cores is stored in the cache. There are memory regions which cannot be cached but this is something only the OS implementers have to be concerned about; it is not visible to the application programmer. There are also instructions which allow the programmer to deliberately bypass certain caches. This will be discussed in Section 6.<br>默认情况下，CPU内核读取或写入的所有数据都存储在缓存中。有些内存区域无法缓存，但这只是操作系统实现人员必须关注的问题; 它对应用程序员来说是不可见的。还有一些指令允许程序员故意绕过某些缓存，将在第6节中讨论这些。</p>
<p>If the CPU needs a data word the caches are searched first. Obviously, the cache cannot contain the content of the entire main memory (otherwise we would need no cache), but since all memory addresses are cacheable, each cache entry is tagged using the address of the data word in the main memory. This way a request to read or write to an address can search the caches for a matching tag. The address in this context can be either the virtual or physical address, varying based on the cache implementation.<br>如果CPU需要一个字的数据，则首先搜索高速缓存。显然，缓存不能包含整个主存储器的内容（否则我们不需要缓存），但由于所有内存地址都是可缓存的，因此每个缓存条目都使用主存中数据字的地址进行标记。这样，读取或写入地址的请求可以在高速缓存中搜索匹配的标记。在这种情况下，地址可以是虚拟内存地址或物理地址，基于缓存的具体实现而变化。</p>
<p>Since the tag requires space in addition to the actual memory, it is inefficient to choose a word as the granularity of the cache. For a 32-bit word on an x86 machine the tag itself might need 32 bits or more. Furthermore, since spatial locality is one of the principles on which caches are based, it would be bad to not take this into account. Since neighboring memory is likely to be used together it should also be loaded into the cache together. Remember also what we learned in Section 2.2.1: RAM modules are much more effective if they can transport many data words in a row without a new CAS or even RAS signal. So the entries stored in the caches are not single words but, instead, “lines” of several contiguous words. In early caches these lines were 32 bytes long; now the norm is 64 bytes. If the memory bus is 64 bits wide this means 8 transfers per cache line. DDR supports this transport mode efficiently。<br>由于标签除了实际存储器之外还需要空间，因此选择字作为高速缓存的单位是低效的。对于x86机器上的32位字，标签本身大小可能需要32位或更多。此外，由于空间局部性是高速缓存的基本原则之一，也必须把这一点考虑进去。由于相邻内存区域可能被一起访问，因此它们也应该一起加载到高速缓存中。还要记住我们在第2.2.1节中学到的内容：如果RAM模块可以在不发送新CAS或甚至RAS信号的情况下连续传输多个数据字，则它们会更有效。因此，存储在高速缓存中的条目不是字，而是有着几个连续字的“行”。在早期的缓存中，这些行的长度为32个字节; 现在的规范是64字节。如果存储器总线是64位宽，则这意味着每个高速缓存行需要8次传输。DDR能有效地支持这种传输模式。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/05/二叉堆与堆排序要点/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Rust">
      <meta itemprop="description" content="programming and free market">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/05/二叉堆与堆排序要点/" itemprop="url">
                  二叉堆与堆排序要点
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-05 00:00:00" itemprop="dateCreated datePublished" datetime="2019-04-05T00:00:00+08:00">2019-04-05</time>
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Algorithm/" itemprop="url" rel="index"><span itemprop="name">Algorithm</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="二叉堆，堆排序，与优先队列要点"><a href="#二叉堆，堆排序，与优先队列要点" class="headerlink" title="二叉堆，堆排序，与优先队列要点"></a>二叉堆，堆排序，与优先队列要点</h1><p>今天看完了红皮《算法》第二章的优先队列那一节。二叉堆，堆排序，优先队列，这些都是难舍难分密切相关的几个概念。一句话来说，优先队列作为一种高效的数据结构，其实现依赖于二叉堆这么一种数据结构。借助于优先队列，能实现一种时间复杂度为<code>logn</code>的<strong>原地</strong>排序算法，堆排序。</p>
<p>要点：</p>
<ol>
<li>二叉堆定义（用数组表示时的细节）</li>
<li><strong>插入</strong>（尾端叶子节点）与<strong>删除</strong>（根节点）的过程</li>
<li>建堆方式 + sink 下沉操作 = 堆排序——堆排序的过程</li>
<li>堆排序的优点与缺点<ol>
<li><strong>优点</strong>：内存使用，原地排序</li>
<li><strong>缺点</strong>：CPU cache 缓存命中，非稳定排序，比较次数大于快排</li>
</ol>
</li>
<li>复杂度得出过程</li>
</ol>
<p>[TOC]</p>
<h2 id="二叉堆定义与数组表示"><a href="#二叉堆定义与数组表示" class="headerlink" title="二叉堆定义与数组表示"></a>二叉堆定义与数组表示</h2><p>根节点大于<strong>等于</strong>左右两个子节点。当储存为数组时，根节点放在索引 1 的位置，为了计算便利数组的索引零不存储数据。位置为 k 的节点的父节点位置是 p &lt;= k/2，子节点在数组中的位置是 2k 和 2k+1。如图：</p>
<p><img src="/content/images/2019/HeapRepresentations.png" alt="Heap Representations"></p>
<p>另外，二叉堆<strong>属于</strong>完全二叉树。</p>
<h2 id="二叉堆删除最大节点与插入数据过程"><a href="#二叉堆删除最大节点与插入数据过程" class="headerlink" title="二叉堆删除最大节点与插入数据过程"></a>二叉堆删除最大节点与插入数据过程</h2><h3 id="上浮、下沉操作"><a href="#上浮、下沉操作" class="headerlink" title="上浮、下沉操作"></a>上浮、下沉操作</h3><p>这两个操作是插入、删除 API 的基础操作。</p>
<p><strong>上浮 swim</strong> 是指当某节点的子节点大于其父节点，破坏了堆的有序性，则将这个过大的子节点与它的父节点交换。如果交换之后，该子节点仍然大于交换位置之后的父节点，继续交换。这个过程就被形象化称为上浮。最终，节点上浮到正确的位置，它的父节点大于它，所有子节点小于它。每上浮一次需要 <code>1</code> 次比较。</p>
<p><strong>下沉 sink</strong> 是相反的操作，由上至下比较。如果某节点小于它的子节点，则发生交换。每次下沉需要两次比较。首先比较找出两个子节点中较大的那个，然后比较较大子节点与父节点，如果父节点小于则交换。</p>
<h3 id="删除最大-根节点"><a href="#删除最大-根节点" class="headerlink" title="删除最大/根节点"></a>删除最大/根节点</h3><p>在大端二叉堆中，根节点就是堆中最大元素。将根节点删除/取出之后，把堆中最末尾的元素（也就是树中最大一层最右边的叶子节点）放在根节点的位置，然后对这个节点进行<code>下沉</code>操作。</p>
<p>每次删除操作，需要的时间复杂度最坏为 $\log n$，也就是从根节点一直比较、交换到叶子节点。假设树高度为 h，最坏情况下需要 h 次交换，2h 次比较。与此同时，作为一颗完全二叉树，二叉堆的高度 h 始终小于等于 $\log$~2~$n$，也就是 $\logn$ 复杂度。</p>
<h3 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h3><p>插入的数据将被放在最末端/最右端的叶子节点，然后对其使用上浮操作。最坏情况下需要 h 次比较，h 次交换，所以复杂度也为 $\log n$。</p>
<h2 id="堆排序对数据的初始化：建堆"><a href="#堆排序对数据的初始化：建堆" class="headerlink" title="堆排序对数据的初始化：建堆"></a>堆排序对数据的初始化：建堆</h2><h2 id="优先队列实现注意小细节"><a href="#优先队列实现注意小细节" class="headerlink" title="优先队列实现注意小细节"></a>优先队列实现注意小细节</h2><ol>
<li><p><code>sink</code> 的调用条件是当前被下沉节点的子节点索引<strong>小于等于</strong>优先队列元素数量。否则，在边界条件时，就会导致有元素没有被下沉。举个例子，当队列还有三个元素，<code>star, was, worst</code>， 删除顶端元素之后在顶端插入末尾元素 <code>worst</code>，此时 <code>worst</code> 子节点为 <code>was</code>，索引为 <code>1*2 = 2</code>，大于等于优先队列的元素总数量，<code>sink</code> 操作没有调用，<code>worst</code> 元素先于 <code>was</code> 被取出队列。</p>
</li>
<li><p>在下沉 <code>sink</code> 操作时，在将当前节点与子节点比较之前，应该先比较两个子节点。如果是大顶堆，则选出更大的节点来与父节点比较，小顶堆则选出两者中更小的节点。</p>
</li>
<li><p>在比较两子节点时，也要注意子节点索引不能越界。同样在只有两个元素时进行 <code>sink</code> 操作的情况下，只有一个子节点，试图寻找此子节点的下一个子节点将会超越数组边界。例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sink</span><span class="params">(<span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> j = <span class="number">2</span> * k;</span><br><span class="line">    <span class="keyword">while</span> (j &lt;= N) &#123;</span><br><span class="line">        <span class="keyword">if</span> (j+<span class="number">1</span> &lt;= N &amp;&amp; less((j + <span class="number">1</span>), j)) &#123;</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (less(j, k)) &#123;</span><br><span class="line">            exch(j, k);</span><br><span class="line">            k = j;</span><br><span class="line">            j *= <span class="number">2</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/09/Flask Web Development Notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Rust">
      <meta itemprop="description" content="programming and free market">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/09/Flask Web Development Notes/" itemprop="url">
                  Flask Web Development Notes
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-08-09 22:54:00" itemprop="dateCreated datePublished" datetime="2018-08-09T22:54:00+08:00">2018-08-09</time>
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/技术笔记/" itemprop="url" rel="index"><span itemprop="name">技术笔记</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/技术笔记/读书笔记/" itemprop="url" rel="index"><span itemprop="name">读书笔记</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Flask-Web-Development-Notes"><a href="#Flask-Web-Development-Notes" class="headerlink" title="Flask Web Development Notes"></a>Flask Web Development Notes</h1><blockquote>
<p>这是我暑假看 Miguel 的那本著名狗书时的笔记，书的版本是最新的 second edition。当时看的是原文版，以后会写一篇文章说阅读英语原文的经验</p>
</blockquote>
<h2 id="Ch2-Basic-Application-Structure"><a href="#Ch2-Basic-Application-Structure" class="headerlink" title="Ch2 Basic Application Structure"></a>Ch2 Basic Application Structure</h2><h3 id="Run-an-app"><a href="#Run-an-app" class="headerlink" title="Run an app"></a>Run an app</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> FLASK_APP=name.py</span><br><span class="line"><span class="built_in">export</span> FLASK_DEBUG=1</span><br><span class="line">flask run</span><br></pre></td></tr></table></figure>
<h3 id="Dynamic-route"><a href="#Dynamic-route" class="headerlink" title="Dynamic route"></a>Dynamic route</h3><p>Flask supports the types <code>string</code>, <code>int</code>, <code>float</code>, and <code>path</code> for routes. The <code>path</code> type is a special <code>string</code> type.</p>
<h3 id="Response"><a href="#Response" class="headerlink" title="Response"></a>Response</h3><p><em>view function</em> could take as much as three arguments, <em>status code</em> and a <em>dictionary of headers</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">return</span> <span class="string">'&lt;h1&gt;Bad Request&lt;/h1&gt;'</span>, <span class="number">400</span></span><br></pre></td></tr></table></figure>
<h3 id="Compatibility-with-older-version"><a href="#Compatibility-with-older-version" class="headerlink" title="Compatibility with older version"></a>Compatibility with older version</h3><p><code>app.run(debug=True)</code></p>
<p><code>app.add_url_rule()</code>: builds the map between URL and view function</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flask run --host 0.0.0.0</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install sqlite3 libsqlite3-dev</span><br></pre></td></tr></table></figure>
<h2 id="Ch3-Templates"><a href="#Ch3-Templates" class="headerlink" title="Ch3 Templates"></a>Ch3 Templates</h2><p><em>business logic</em> and <em>presentation logic</em>, Jinja2 takes the work of <em>presentation</em>. More specifically, the application only sends variables to Jinja2, after that how the HTML page is presented is up to Jinja2.</p>
<h3 id="What-this-chapter’s-mainly-about"><a href="#What-this-chapter’s-mainly-about" class="headerlink" title="What this chapter’s mainly about"></a>What this chapter’s mainly about</h3><p>Static web pages. Topics in this chapter:</p>
<ul>
<li>What are templates; how to inherit</li>
<li>How to write URLs in Flask; <code>url_for()</code> helper function; relative &amp; absolute URLs, the latter one less useful</li>
<li>How to send static files (in template format)</li>
<li>Miscellaneous: Bootstrap integration</li>
</ul>
<h2 id="Ch4-Web-Forms"><a href="#Ch4-Web-Forms" class="headerlink" title="Ch4 Web Forms"></a>Ch4 Web Forms</h2><h3 id="Form-classes-（technical"><a href="#Form-classes-（technical" class="headerlink" title="Form classes （technical)"></a>Form classes （technical)</h3><p><code>FlaskForm</code> defines the list of <code>field</code>s in each form, each represented by an object. Each <code>field</code> object have one or more <em>validators</em> attached. A <em>validator</em> is a function. Note the three terms here, <em>FlaskForm, field, validator</em>.</p>
<h3 id="Form-submission-with-GET"><a href="#Form-submission-with-GET" class="headerlink" title="Form submission with GET"></a>Form submission with GET</h3><p>Bad. GET doesn’t have a <em>body</em>, so if submit with GET method, the <em>data</em> will be appended to the URL as a <em>query string</em>, and becomes visible in the browser’s address bar.</p>
<p>Therefore, in <em>view function</em> that deals with forms, add a <code>POST</code> method like that:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/', methods=['GET', 'POST'])</span></span><br></pre></td></tr></table></figure>
<h3 id="Miscellaneous"><a href="#Miscellaneous" class="headerlink" title="Miscellaneous"></a>Miscellaneous</h3><p>This method returns <code>True</code> when form is <del>submitted</del> submitted using POST method, and the data accepted by all <em>field validators</em>; used to <em>determine</em>, whether the form needs to be <em>rendered</em> or <em>processed</em>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">	<span class="comment">###</span></span><br></pre></td></tr></table></figure>
<p>The first and only required argument to <code>url_for()</code> is the <em>endpoint</em> name.  By default, the endpoint of a route is the name of the view function attached to it. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br></pre></td></tr></table></figure>
<h2 id="Ch5-Databases"><a href="#Ch5-Databases" class="headerlink" title="Ch5 Databases"></a>Ch5 Databases</h2><h3 id="Terms"><a href="#Terms" class="headerlink" title="Terms"></a>Terms</h3><p>column: attribute of the entity; row: actual data element that <em>assigns</em> values to columns.</p>
<p>table, record –&gt; collection, document, from Relational to NoSQL</p>
<p><em>primary key</em>: a special <em>column</em>; <em>foreign keys</em>: columns</p>
<h3 id="Sum"><a href="#Sum" class="headerlink" title="Sum"></a>Sum</h3><ul>
<li>With ORM middleman, one doesn’t have to SQL semantics</li>
<li>Apply different URLs in config could migrate from different (relational) databases</li>
<li>Databases migration:<ul>
<li>Framework: <em>Flask-Migrate</em>, the <em>Alembic wrapper</em></li>
<li>Procedures: <code>flask db init</code>, creates a <em>migrations</em> directory (optional, only on a new project); <code>flask db migrate -m &quot;message&quot;</code>, <em>automatically</em> creates <em>migration script</em>, while <code>revision</code> manually; <code>flask db upgrade</code></li>
<li><code>flask db downgrade</code> and <code>... upgrade</code> gives db migrations log history like <em>git</em></li>
</ul>
</li>
</ul>
<h2 id="Ch7-Large-Application-Structure"><a href="#Ch7-Large-Application-Structure" class="headerlink" title="Ch7 Large Application Structure"></a>Ch7 Large Application Structure</h2><h3 id="Add-custom-commands-via-click"><a href="#Add-custom-commands-via-click" class="headerlink" title="Add custom commands via click"></a>Add custom commands via <em>click</em></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.cli.command()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">thatWillBetheNameofCommand</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="string">"""This will be shown in the help messages"""</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<h3 id="Blueprint-detail"><a href="#Blueprint-detail" class="headerlink" title="Blueprint detail"></a>Blueprint detail</h3><ul>
<li><p>In chapter 7 about <em>blueprint</em>, the module where blueprint object is must import its routes’ view functions, because</p>
<blockquote>
<p>Importing these modules causes the routes and error handlers to be associated with the blueprint. </p>
</blockquote>
</li>
<li><p>From Eg.7.7: the blueprint name before <em>endpoint</em> can be omitted, as <code>url_for(&#39;.index&#39;)</code>. <em>Redirects</em> within the same blueprint could use the shorter form, while crossing blueprints requires the fully qualified endpoint name that includes the blueprint name.</p>
</li>
</ul>
<h2 id="Ch8-User-Authentication"><a href="#Ch8-User-Authentication" class="headerlink" title="Ch8 User Authentication"></a>Ch8 User Authentication</h2><blockquote>
<p>Hashing functions are repeatable.</p>
</blockquote>
<ul>
<li><strong>Q:</strong> How could the <code>check_password_hash(hash, password)</code> check pwd without knowing the <em>salt</em> of it?</li>
</ul>
<h3 id="WTForm-write-your-own-validator-with-validate-prefix"><a href="#WTForm-write-your-own-validator-with-validate-prefix" class="headerlink" title="WTForm: write your own validator with validate_ prefix"></a>WTForm: write your own validator with <em>validate_</em> prefix</h3><ul>
<li>for <code>wtforms</code> <em>validate_</em> prefix defines custom validators; while in Python standard library <code>unittest</code> the <em>test_</em> prefix is used.</li>
<li>any function referred the database, is defined in <code>model.py</code>, as methods in those ORM models. They access the database using <code>self.attribute</code>.</li>
</ul>
<h3 id="Flask-Login-detail"><a href="#Flask-Login-detail" class="headerlink" title="Flask-Login detail"></a>Flask-Login detail</h3><p>Flask-Login requires the application to designate a function to be invoked when the extension needs to load a user from the database given its identifier, registered with <code>@login_manager.user_loader</code> decorator.</p>
<p><code>_get_user()</code> searches for a user ID in the <em>user session</em> –&gt; invoke the function registered with the <code>user_loader</code> decorator, with the ID as argument</p>
<h2 id="Ch14-API"><a href="#Ch14-API" class="headerlink" title="Ch14 API"></a>Ch14 API</h2><p>The process of converting an internal representation to a transport format such as JSON is called <strong>serialization</strong>.</p>
<h2 id="Todo"><a href="#Todo" class="headerlink" title="Todo"></a>Todo</h2><ul>
<li><p>[ ] decorators in Python<br>They are functions that takes  a func as an arg then returns another arg</p>
</li>
<li><p>[ ] <strong>OOP</strong> concepts: constructor, method&amp;attribute<br>(so far I <em>assume</em> that) Methods are funcs, attributes are data.</p>
</li>
<li><p>[x] How blocks are really defined in bootstrap/base.html</p>
</li>
<li><p>[ ] what <code>&lt;&gt;</code> means in Python code (<code>&lt;{&#39;key1&#39;: v, &#39;k2&#39;: v2}&gt;</code>)</p>
</li>
<li><p>[x] What is <em>label</em> in HTML<br>makes the form text clickable; same style with it.</p>
</li>
<li><p>[ ] &gt; The remaining class variables are the attributes of the model, defined as instances of the <code>db.Column</code> class.</p>
<p>what is <em>instance, class variable, attribute</em></p>
</li>
<li><p>[ ] <code>with</code> keyword in Python</p>
</li>
<li><p>[x] <code>__name__</code>, <code>__file__</code> and other dunder variable (<code>basedir = os.path.abspath(os.path.dirname(__file__))</code>)</p>
<ul>
<li><code>__name__</code> has two values, <code>&quot;__main__&quot;</code> (when being executed) or the module’s name (when imported). With respect to Object, <code>__name__</code> is the special attribute of a class, function, method, descriptor, or generator instance. </li>
<li><code>__file__</code>, the absolute path of the module</li>
</ul>
</li>
<li><p>[ ] functionality of the <code>__init__.py</code> file in a directory</p>
</li>
<li><p>[ ] <strong>OOP:</strong> <code>@property</code> decorator in a class</p>
</li>
<li><p>[ ] <strong>DB:</strong> <code>users = db.relationship(&#39;User&#39;, backref=&#39;role&#39;, lazy=&#39;dynamic&#39;)</code>. “users” is a <em>column</em> of the table <em>role</em>. What does <code>lazy</code> kwarg mean</p>
</li>
<li><p>[x] <strong>DB:</strong> <code>Role.query.filter_by(name=&#39;Administrator&#39;).first()</code>, type of the return value</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User.query.filter_by(username=<span class="string">'galt'</span>).first()  <span class="comment"># output: &lt;User 'john'&gt;</span></span><br><span class="line">a = User.query.filter_by(username=<span class="string">'galt'</span>).first()</span><br><span class="line">type(a)  <span class="comment"># output: &lt;class 'app.models.User'&gt;</span></span><br></pre></td></tr></table></figure>
<p>On success, return value is the <em>row</em> in the table. <code>a.id</code> would return the <code>id</code> <em>column</em> of user <code>galt</code>.</p>
</li>
</ul>
<hr>
<ul>
<li style="list-style: none"><input type="checkbox"> Linux command <code>export</code></li>
<li style="list-style: none"><input type="checkbox"> <code>form.hidden_tag()</code> element for CSRF protection</li>
<li style="list-style: none"><input type="checkbox" checked> How much freedom does ORM/ODM provide in choosing DB, only different <em>rational databases</em>?<br>Yes.</li>
<li style="list-style: none"><input type="checkbox"> <figure class="highlight plain"><figcaption><span>wtf.quick_form(form) &#125;&#125;```, how will this template be rendered, search keyword in the book</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">  - `&#123;&#123; name &#125;&#125;` construct references a **variable**, a **placeholder**</span><br><span class="line">- [ ] How to initialize `SelectField`, 7.31</span><br><span class="line">- [ ] `Post.query.order_by` will this query affect rows? 8.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### After Flask:</span><br><span class="line"></span><br><span class="line">- [ ] WTForm package *validator* source code, I assume it&apos;s just RegEx</span><br><span class="line"></span><br><span class="line">- [ ] For example, the execution of the `send_async_email()` function can be sent to a [Celery](http://www.celeryproject.org/) task queue. (p.107)</span><br><span class="line"></span><br><span class="line">- [ ] **Decorator:** How different orders affects the registered function</span><br><span class="line"></span><br><span class="line">- [ ] **Thread:** *worker thread* in Flask doc</span><br><span class="line"></span><br><span class="line">- [ ] **Iterator** and that: </span><br><span class="line"></span><br><span class="line">  ```python</span><br><span class="line">  follows = [&#123;&apos;user&apos;: item.follower, &apos;timestamp&apos;: item.timestamp&#125;</span><br><span class="line">  for item in pagination.items]</span><br></pre></td></tr></table></figure></li>
</ul>
<p>Check yourself: </p>
<ul>
<li>How to add a new row in a table, how to change a column of a row</li>
<li>Page 182, how the foreign key of a table is added</li>
</ul>
<hr>
<ul>
<li><p>synopsis: brief summary</p>
</li>
<li><p>delimiter (<em>programming</em>)</p>
</li>
<li><p>miscellaneous</p>
</li>
<li><p><em>callable</em>, page 65</p>
</li>
<li><p>cardinality alchemy, transparent (Ch5)</p>
</li>
<li><blockquote>
<p>build a perfect <strong>replica</strong> of the virtual environment…</p>
</blockquote>
</li>
</ul>
<h2 id="Appendix"><a href="#Appendix" class="headerlink" title="Appendix"></a>Appendix</h2><h3 id="Object-in-Python"><a href="#Object-in-Python" class="headerlink" title="Object in Python"></a>Object in Python</h3><p>type of methods:</p>
<ul>
<li><em>instance method</em>, the 1st argument of it <em>must</em> be <code>self</code>; any method taking <code>self</code> as the 1st arg is a <em>instance method</em></li>
<li><em>class method</em>, <code>@classmethod</code>, <code>cls</code> as the 1st arg. Calling: <code>Obj().count()</code>, where <code>Obj</code> is the name of a class</li>
<li><em>static method</em>， <code>@staticmethod</code>. E.g. <code>Obj().someStaticMethod()</code></li>
</ul>
<p><code>super()</code> in Python2.x takes its own class as the first variable, like <code>super(Child, self).__init__(age, height)</code>. Also the <em>parent</em> shall be defined as <code>class Parent(object)</code>, having <code>object</code> as base class.</p>
<h3 id="REST-API"><a href="#REST-API" class="headerlink" title="REST API"></a>REST API</h3><ul>
<li>more business logic on client side</li>
<li>client could <em>discover</em> resources using different URL compositions</li>
<li>versioning for backward compatibility</li>
</ul>
<h3 id="Compare-to-Mage-Tutorial"><a href="#Compare-to-Mage-Tutorial" class="headerlink" title="Compare to Mage Tutorial"></a>Compare to Mage Tutorial</h3><ol>
<li>_get</li>
<li>plain text and HTML email</li>
<li>from GitHub’s <em>commit</em> history you could view specifically what changed in every commit</li>
</ol>
<h3 id="Test-amp-Caution"><a href="#Test-amp-Caution" class="headerlink" title="Test &amp; Caution"></a>Test &amp; Caution</h3><ol>
<li><p>Think of <strong>boundary values</strong> while designing programs.</p>
<ul>
<li><code>current_user.confirmed</code></li>
<li><code>@login_required</code></li>
<li><code>self.email.lower()</code> ensure that the string is lowercase</li>
<li><code>verify_password(email, password):</code> before loading user from DB to check pwd, <code>email</code> must be checked first not to be <code>&#39;&#39;</code></li>
</ul>
</li>
<li><p>Crucial cases where proxies provided by Flask like<code>current_app</code> can’t fake:</p>
<ul>
<li><code>current_app</code> can’t fake its type as the actual object type</li>
<li><p>when sending <em>Signals</em> or passing data <em>to a background thread</em></p>
<p>best practice:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app = current_app._get_current_object()</span><br><span class="line">my_signal.send(app)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.exc <span class="keyword">import</span> IntegrityError</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">	db.session.commit()</span><br><span class="line"><span class="keyword">except</span> IntegrityError:</span><br><span class="line">	db.session.rollback()</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>form.body.data = post.body</code>; how to render page according to attributes of the user;  Context processors make variables available to all templates during rendering</p>
</li>
<li><p><code>from app.exceptions import</code></p>
</li>
</ol>
<h3 id="The-power-of-Flask-Shell"><a href="#The-power-of-Flask-Shell" class="headerlink" title="The power of Flask Shell"></a>The power of Flask Shell</h3><p>Page 214, static method <code>add_self_follows()</code> that manipulates existed <em>rows</em></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/21/VimCheatsheet/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Rust">
      <meta itemprop="description" content="programming and free market">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/21/VimCheatsheet/" itemprop="url">
                  Vim Cheat Sheet
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-07-21 22:54:00" itemprop="dateCreated datePublished" datetime="2018-07-21T22:54:00+08:00">2018-07-21</time>
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/技术笔记/" itemprop="url" rel="index"><span itemprop="name">技术笔记</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>最近用上了 WSL，巨硬居然在 Win 上允许使用 Linux了<br>修改文件不可避免似乎就要学会 Vim 啊，后来才知道自带 nano</p>
</blockquote>
<h2 id="Motion"><a href="#Motion" class="headerlink" title="Motion"></a>Motion</h2><p><code>h</code>, <code>l</code>: move left and right</p>
<p><code>j</code>, <code>k</code>: move down and up</p>
<p><code>w</code>: next <strong>beginning</strong> of word</p>
<p><code>e</code>, <code>ge</code>: <strong>current, last</strong> <strong>end</strong> of word</p>
<p><code>b</code>, <code>B</code>: <strong>previous beginning</strong> of word and <strong>WORD</strong></p>
<p><code>0</code>, <code>^</code>: to the <strong>beginning of line</strong></p>
<p><code>$</code>: to the <strong>end</strong> of line</p>
<p><code>gg</code>, <code>G</code>: <strong>beginning</strong>, <strong>end</strong> of <strong>file</strong> </p>
<p><code>nG</code>: line n; <code>:set nu</code> to turn on line num</p>
<p><code>f&lt;char&gt;</code>, <code>F&lt;char&gt;</code>: <strong>search</strong> forward, backward</p>
<h2 id="Edit"><a href="#Edit" class="headerlink" title="Edit"></a>Edit</h2><p><code>cw</code>: <strong>C</strong>hange current word that the cursor’s at</p>
<p><code>cc</code>: <em>delete</em> the whole line and enter INSERT mode</p>
<p><code>C</code>: delete till the <strong>end of line</strong>, enter INSERT mode</p>
<p><code>r&lt;char&gt;</code>: <strong>R</strong>eplace cursor with \&lt;char></p>
<p><code>R</code>: replace successively, with each\&lt;char>  typed; <code>Esc</code> to exit</p>
<p><code>un</code> <strong>U</strong>ndo for <strong>n</strong> times</p>
<p><code>U</code> undo all changes in current <strong>line</strong></p>
<p><code>Ctrl</code> + <code>r</code>: redo</p>
<p><code>&gt;&gt;</code>, <code>&lt;&lt;</code>: tab in NORMAL mode</p>
<p><code>:set shiftwidth?</code></p>
<p><code>:ce</code> <strong>center</strong> the line</p>
<p><code>:ri</code>, <code>:le</code>: to the <strong>right</strong>, <strong>left</strong></p>
<h3 id="Search"><a href="#Search" class="headerlink" title="Search"></a>Search</h3><p><code>/</code>, <code>?</code>: search <strong>next</strong>, <strong>last</strong></p>
<p><code>n</code>, <code>N</code>: <strong>next</strong>, <strong>last</strong> result</p>
<h2 id="Insert"><a href="#Insert" class="headerlink" title="Insert"></a>Insert</h2><p><code>i</code>, <code>a</code>: insert <strong>at</strong> and <strong>append</strong> cursor position</p>
<p><code>I</code>, <code>A</code>: insert at the <strong>beginning</strong> and the <strong>end</strong> of current line</p>
<p><code>o</code>, <code>O</code>: <strong>O</strong>pen a new line <strong>after</strong> and <strong>before</strong> current line, and enter INSERT mode</p>
<h2 id="Copy-Paste-and-Cut"><a href="#Copy-Paste-and-Cut" class="headerlink" title="Copy, Paste, and Cut"></a>Copy, Paste, and Cut</h2><p><code>yy</code>: <strong>Y</strong>ank(copy) <strong>whole line</strong></p>
<p><code>yw</code>, <code>ynw</code>: copy one <strong>word</strong>, <strong>n</strong> words</p>
<p><code>y^</code>, <code>y0</code>: copy till the <strong>beginning of line</strong>, current cursor <strong>not</strong> included</p>
<p><code>y$</code>: copy till the <strong>end</strong>, char where the cursor’s at <strong>included</strong></p>
<p><code>yG</code>, <code>y1G</code>: copy till <strong>end</strong>, <strong>beginning</strong> of <strong>file</strong></p>
<p><code>p</code>: (lowercase) paste on <strong>next line</strong></p>
<p><code>P</code>: (uppercase) paste <strong>last line</strong></p>
<p><code>dd</code>: cut</p>
<p><code>ddp</code>: <strong>swap</strong> this and <strong>next</strong> line</p>
<h2 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h2><p><code>x</code>: <strong>D</strong>elete char <strong>under</strong> cursor</p>
<p><code>X</code>: delete char <strong>before</strong> cursor</p>
<p><code>dd</code>: delete the entire line</p>
<p><code>dw</code>: delete word <em>after</em> cursor; <code>w</code> + <code>dw</code></p>
<p><code>D</code>: delete till the end of <strong>line</strong></p>
<p><code>d^</code>: delete till the beginning</p>
<p><code>d1G</code>, <code>dG</code>: delete till the <strong>beginning</strong> and <strong>end</strong> of <strong>file</strong></p>
<h2 id="Repeat"><a href="#Repeat" class="headerlink" title="Repeat"></a>Repeat</h2><p><code>.</code>: repeat last command (under NORMAL mode)</p>
<p><code>N&lt;command&gt;</code>: e.g. 2dd, 10x</p>
<p><code>dnw</code>: delete a word <strong>n</strong> times </p>
<h2 id="Exit"><a href="#Exit" class="headerlink" title="Exit"></a>Exit</h2><p><code>:q</code>: quit</p>
<p><code>:wq</code>, <code>:x</code>: save and exit</p>
<p><code>:wq!</code>: <strong>force</strong> to save and quit</p>
<p><code>:w</code>, <code>:saveas</code></p>
<p><code>Shift</code> + <code>zz</code>: under NORMAL mode, save and exit</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/05/程序员练级指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Rust">
      <meta itemprop="description" content="programming and free market">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/05/程序员练级指南/" itemprop="url">
                  程序员练级指南
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-07-05 23:31:00" itemprop="dateCreated datePublished" datetime="2018-07-05T23:31:00+08:00">2018-07-05</time>
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/读书笔记/" itemprop="url" rel="index"><span itemprop="name">读书笔记</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>终于在极客时间上剁手了<br>这篇是耗子叔的那几篇入门指导的浓缩</p>
</blockquote>
<p>[TOC]</p>
<h1 id="入门篇"><a href="#入门篇" class="headerlink" title="入门篇"></a>入门篇</h1><h2 id="零基础启蒙"><a href="#零基础启蒙" class="headerlink" title="零基础启蒙"></a>零基础启蒙</h2><h3 id="两份入门教程（Python-amp-JS）"><a href="#两份入门教程（Python-amp-JS）" class="headerlink" title="两份入门教程（Python &amp; JS）"></a>两份入门教程（Python &amp; JS）</h3><p>都是从零开始</p>
<ul>
<li><a href="https://book.douban.com/subject/5338024/" target="_blank" rel="noopener">与孩子一起学编程</a>，六、二十章为 GUI</li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Learn/Getting_started_with_the_web" target="_blank" rel="noopener">MDN Web 开发入门</a>，教程带你建立一个网站</li>
</ul>
<h3 id="Python-与-JavaScript-入门语言"><a href="#Python-与-JavaScript-入门语言" class="headerlink" title="Python 与 JavaScript 入门语言"></a>Python 与 JavaScript 入门语言</h3><h4 id="Python-书籍"><a href="#Python-书籍" class="headerlink" title="Python 书籍"></a>Python 书籍</h4><ul>
<li><a href="https://book.douban.com/subject/26836700/" target="_blank" rel="noopener">Python 编程快速上手</a>，控制鼠标、破解 PDF</li>
<li><a href="https://book.douban.com/subject/26829016/" target="_blank" rel="noopener">Python 编程：从入门到实践</a>，“有 Web 项目、代码部署内容”，Django 学习笔记网站，Heroku 部署，若时间有限，这一本</li>
</ul>
<h4 id="JavaScript-在线教程"><a href="#JavaScript-在线教程" class="headerlink" title="JavaScript 在线教程"></a>JavaScript 在线教程</h4><ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript" target="_blank" rel="noopener">MDN JS 教程</a>，“从初级到中级再到高级，十分全面”</li>
<li><a href="http://www.w3school.com.cn/js/" target="_blank" rel="noopener">W3School JS 教程，</a>偏 Web 方向</li>
<li><a href="https://www.liaoxuefeng.com/wiki/001434446689867b27157e896e74d51a89c25cc8b43bdb3000" target="_blank" rel="noopener">廖雪峰 JS 全栈教程</a>，偏应用偏 Web，包括 Node.js</li>
</ul>
<h3 id="操作系统入门-Linux"><a href="#操作系统入门-Linux" class="headerlink" title="操作系统入门 Linux"></a>操作系统入门 Linux</h3><p><a href="https://www.w3cschool.cn/linux/" target="_blank" rel="noopener">W3CSchool Linux 教程</a></p>
<h3 id="Microsoft-Visual-Studio-Code"><a href="#Microsoft-Visual-Studio-Code" class="headerlink" title="(Microsoft) Visual Studio Code"></a>(Microsoft) Visual Studio Code</h3><p><a href="https://legacy.gitbook.com/book/jeasonstudio/vscode-cn-doc/details" target="_blank" rel="noopener">中文手册</a>，不一定非要。吸引我：在终端工具内打印 Debug 信息</p>
<h3 id="Web-编程入门"><a href="#Web-编程入门" class="headerlink" title="Web 编程入门"></a>Web 编程入门</h3><h4 id="前端基础"><a href="#前端基础" class="headerlink" title="前端基础"></a>前端基础</h4><ul>
<li>MDN CSS 文档 与 HTML 文档，参考而不是记忆</li>
<li>JS DOM 与动态网页 <a href="https://www.w3schools.com/js/js_htmldom.asp" target="_blank" rel="noopener">W3Schools 的 JavaScript HTML DOM 教程</a></li>
<li>要点：<ul>
<li>HTML 基本语法</li>
<li>CSS 如何选中 HTML 元素，应用一些基本样式</li>
<li>用 Firefox + Firebug 或 Chrome 查看炫酷网页结构</li>
</ul>
</li>
</ul>
<h4 id="后端（PHP）"><a href="#后端（PHP）" class="headerlink" title="后端（PHP）"></a>后端（PHP）</h4><h3 id="实践项目"><a href="#实践项目" class="headerlink" title="实践项目"></a>实践项目</h3><p>极简 Blog 系统，或是 BBS 系统，支持如下功能：</p>
<ul>
<li>用户登录和注册，无密码找回</li>
<li>用户发帖，仅支持纯文本</li>
<li>评论，纯文本</li>
</ul>
<p>从前端到后端，从 HTML/CSS/JS 到 Python，再到数据库</p>
<p>注意的技术点：</p>
<ul>
<li>用户登录密码不保存为明文</li>
<li>用户登录后，可对自己帖子 “重新编辑”、”删除“，但无权修改其它用户</li>
<li>数据库设计。三张表：用户表，文章表，评论表，<strong>他们之间的关联</strong></li>
</ul>
<h2 id="正式入门"><a href="#正式入门" class="headerlink" title="正式入门"></a>正式入门</h2><h3 id="编程技能"><a href="#编程技能" class="headerlink" title="编程技能"></a>编程技能</h3><p><a href="http://blog.thefirehoseproject.com/posts/learn-to-code-and-be-self-reliant/" target="_blank" rel="noopener">The Key to Accelerating Your Coding Skills</a>，文章</p>
<ul>
<li>编程技巧：Code Complete</li>
<li>编程语言：学习 Java</li>
<li>操作系统：鸟哥的 Linux 私房菜</li>
<li>网络协议：系统了解 HTTP 协议，<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP" target="_blank" rel="noopener">MDN HTTP 文档</a>，关键点：<ul>
<li>HTTP 头、HTTP 请求方法、HTTP 返回码</li>
<li>Cookie，缓存，会话，连接管理</li>
</ul>
</li>
<li>数据库设计：慕课网在线课程；推荐学习 MySQL</li>
<li>前端：jQuery，Bootstrap；Ajax 请求后端 API 接口方式；JS Promise 模式，阮一峰教程</li>
<li>字符编码</li>
</ul>
<h3 id="编程工具"><a href="#编程工具" class="headerlink" title="编程工具"></a>编程工具</h3><ul>
<li><strong>IDE</strong>：Eclipse，<a href="https://www.imooc.com/learn/924" target="_blank" rel="noopener">Intellij IDEA</a>，VS Code</li>
<li><strong>版本管理工具</strong>：Git 使用资料</li>
<li><strong>调试前端</strong>：用 Chrome 调试，资料</li>
<li><strong>数据库设计工具</strong>：MySQL WorkBench，资料</li>
</ul>
<h3 id="实践项目-1"><a href="#实践项目-1" class="headerlink" title="实践项目"></a>实践项目</h3><p>投票系统</p>
<p>业务需求：技术需求：</p>
<h3 id="入门篇小结"><a href="#入门篇小结" class="headerlink" title="入门篇小结"></a>入门篇小结</h3><ul>
<li>1 - 2 年时间</li>
<li>不用精通，能独立做出实践项目即是真正入门（耗子叔对入门的定义）</li>
<li>年薪 20万</li>
</ul>
<h1 id="修养篇"><a href="#修养篇" class="headerlink" title="修养篇"></a>修养篇</h1><h2 id="程序员修养"><a href="#程序员修养" class="headerlink" title="程序员修养"></a>程序员修养</h2><p>Quora 帖子</p>
<h3 id="附录：编程规范"><a href="#附录：编程规范" class="headerlink" title="附录：编程规范"></a>附录：编程规范</h3><h1 id="专业基础篇"><a href="#专业基础篇" class="headerlink" title="专业基础篇"></a>专业基础篇</h1><h2 id="编程语言"><a href="#编程语言" class="headerlink" title="编程语言"></a>编程语言</h2><ul>
<li>C 坑</li>
<li>C ++</li>
<li>Java<ul>
<li>C –&gt; C ++ –&gt; Java</li>
</ul>
</li>
<li>Go</li>
</ul>
<h2 id="理论学科"><a href="#理论学科" class="headerlink" title="理论学科"></a>理论学科</h2><p>”计算机学科最精华的知识，人类智慧的精华“</p>
<h3 id="数据结构与算法"><a href="#数据结构与算法" class="headerlink" title="数据结构与算法"></a>数据结构与算法</h3><ul>
<li>三本书推荐，先后顺序</li>
<li>LeetCode 使用</li>
<li>“如果想要有科班生理论基础”：<ul>
<li>数据结构与算法分析</li>
</ul>
</li>
<li>小结</li>
</ul>
<h2 id="系统知识"><a href="#系统知识" class="headerlink" title="系统知识"></a>系统知识</h2><p>Wireshark 数据包分析实战</p>
<h3 id="系统知识小程序"><a href="#系统知识小程序" class="headerlink" title="系统知识小程序"></a>系统知识小程序</h3><h3 id="实践项目-2"><a href="#实践项目-2" class="headerlink" title="实践项目"></a>实践项目</h3><ul>
<li>实现一个 telnet 版本的聊天服务器<ul>
<li><code>telnet ip:port</code>的方式连接服务器</li>
<li><strong>新连接</strong>需要用户名和密码登录，无则注册</li>
<li><em>然后</em>可以选择一个聊天室加入聊天</li>
<li><strong>管理员</strong>有权创建删除聊天室，<strong>普通人员</strong>只有 加入、退出、查询、聊天室</li>
<li>聊天室人数限制；每个人发出来的其他人都能看到</li>
</ul>
</li>
<li>简单的 HTTP 服务器<ul>
<li>解释浏览器传来的 HTTP 协议，只处理 URL path</li>
<li><em>然后</em>列出所代理的目录</li>
<li>浏览器上可以浏览目录里的文件，和下级目录</li>
<li><em>点击文件</em>，则文件传给浏览器（浏览器可自动显示图片、PDF、等）</li>
<li><em>点击子目录</em>，则进入子目录，并列出文件</li>
</ul>
</li>
<li>生产者 / 消费者消息队列服务</li>
</ul>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><ul>
<li>还有热情与成就感：恭喜，超过了绝大多数人；50 万</li>
<li>术业有专攻，建议的方向</li>
</ul>
<h1 id="软件设计篇"><a href="#软件设计篇" class="headerlink" title="软件设计篇"></a>软件设计篇</h1><h2 id="软件设计"><a href="#软件设计" class="headerlink" title="软件设计"></a>软件设计</h2><h1 id="高手成长篇"><a href="#高手成长篇" class="headerlink" title="高手成长篇"></a>高手成长篇</h1><h2 id="系统底层知识"><a href="#系统底层知识" class="headerlink" title="系统底层知识"></a>系统底层知识</h2>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/24/Unicode, UTF-8, 以及 UTF-16/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Rust">
      <meta itemprop="description" content="programming and free market">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rust Shrugged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/24/Unicode, UTF-8, 以及 UTF-16/" itemprop="url">
                  Unicode, UTF-8, 以及 UTF-16
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-06-24 00:00:00" itemprop="dateCreated datePublished" datetime="2018-06-24T00:00:00+08:00">2018-06-24</time>
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/技术笔记/" itemprop="url" rel="index"><span itemprop="name">技术笔记</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Unicode-UTF-8-以及-UTF-16"><a href="#Unicode-UTF-8-以及-UTF-16" class="headerlink" title="Unicode, UTF-8, 以及 UTF-16"></a>Unicode, UTF-8, 以及 UTF-16</h1><p>对不起，但是必须要说，要想完全地搞懂 Unicode 编码，光看这篇文章是肯定不够的，你要自己去维基上看一系列文章。首推 <a href="https://en.wikipedia.org/wiki/Character_encoding" target="_blank" rel="noopener">Character encoding</a> 条目。</p>
<h2 id="基本术语"><a href="#基本术语" class="headerlink" title="基本术语"></a>基本术语</h2><p>来自维基百科的 <a href="https://en.wikipedia.org/wiki/Character_encoding" target="_blank" rel="noopener">character encoding（字符编码）</a> 词条：</p>
<p>Terminology related to code unit:</p>
<ul>
<li>A <em>character</em> is a minimal unit of text that has semantic value.</li>
<li>A <em>character set</em> is a collection of characters that might be used by multiple languages.</li>
</ul>
<p><em>Example:</em> The Latin character set is used by English and most European languages, though the Greek character set is used only by the Greek language.</p>
<ul>
<li>A <em>coded character set</em> is a character set in which each character corresponds to a unique number.</li>
<li>A <em>code point</em> of a coded character set is any allowed value in the character set.</li>
<li>A <em>code unit</em> is a bit sequence used to encode each character of a repertoire within a given encoding form.</li>
</ul>
<p>几个关键术语对应的翻译：code point，码点；code unit，编码单元。所以，一个字符（character）是具有语义的最小文本单元，更多的是一个语言学的术语；一个<em>字符集</em>（character set）是可能被好几种语言使用的字符的集合，比如拉丁语字符集同时被英语和大多数欧洲语言使用。一个<em>编码字符集</em>（coded character set）是一个字符集，其中每一个字符都对应于一个唯一的数字。一个编码字符集的<em>码点</em>（code point）是指这个字符集中所有的数字值，每一个码点对应一个字符。一个<em>编码单元</em>是一个在给定的字符编码表下，给字符编码的字节序列。</p>
<h2 id="Unicode-具体实现过程"><a href="#Unicode-具体实现过程" class="headerlink" title="Unicode 具体实现过程"></a>Unicode 具体实现过程</h2><h3 id="Unicode-四层模型"><a href="#Unicode-四层模型" class="headerlink" title="Unicode 四层模型"></a>Unicode 四层模型</h3><p>如果你能看到这，恭喜，接下来就会简单很多。Unicode 与传统的诸如 ASCII，摩斯电码用的一个重要不同在于，它们都是把字符（character）与字节序列直接对应。而对于 Unicode 来说，它会经过以下几个模型的处理：</p>
<p><strong>character –(CCS)–&gt; code point –(CEF)–&gt; code unit –(CES)–&gt; byte stream</strong></p>
<p>一个字符（character）经过编码字符集（CCS, coded character set）的映射，转化为码点（code point）。码点为<strong>十六进制</strong>，像这样：<code>U+20AC</code>，转化为字符是欧元的标志：<code>€</code>。</p>
<p>码点经过<strong>字符编码表</strong>（CEF, character encoding form）的处理，转化为编码单元（code unit）。编码单元仍然是<strong>十六进制</strong>。举例来说，同一个字符<code>a</code>，它的编码单元在 UTF-32 中是<code>00000061</code>，在 UTF-16中是 <code>0061</code>，在 UTF-8 中是 <code>61</code>。</p>
<p>最后，编码单元被 <strong>CES</strong> (Character Encoding Scheme) 转化为在机器中储存的二进制字节。”CES“ 是什么呢，举例来说，我们平常说的 UTF-8，UTF-16 其实都是 CES。</p>
<h3 id="从码点到-UTF-16"><a href="#从码点到-UTF-16" class="headerlink" title="从码点到 UTF-16"></a>从码点到 UTF-16</h3><p>从<code>U+0000</code>到<code>U+FFFF</code>为基本多语种平面（BMP），可以用两个字节表示。对于高于这个范围的，用 ”代理对“ 来间接表示。低代理项的范围为<code>U+D800</code>至 <code>U+DBFF</code>，高代理项为<code>U+DC00</code>至<code>U+DFFF</code>，一共是2048个位置。这些位置其实是位于 BMP 的保留范围。</p>
<p>从码点到 UTF-16 编码单元的解码过程：</p>
<ol>
<li>把码点减去<code>0x10000</code></li>
<li>对于高代理项（high surrogate）：<ol>
<li>地板除，除以<code>0x400</code></li>
<li>加上<code>0xD800</code></li>
</ol>
</li>
<li>对于低代理项（low surrogate）：<ol>
<li>取余数，取除以<code>0x400</code>后的余数</li>
<li>加上<code>0xDC00</code></li>
</ol>
</li>
</ol>
<p>写成直观公式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">difference = codepoint - 0x10000</span><br><span class="line">H = difference // 0x400 + 0xD800</span><br><span class="line">L = difference % 0x400 + 0xDC00</span><br></pre></td></tr></table></figure>
<p>从 UTF-16 编码单元到码点的编码可以反向推算。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">codepoint = difference + 0x10000</span><br><span class="line">difference = (H - 0xD800) * 0x400 + (L - 0xDC00)</span><br></pre></td></tr></table></figure>
<h4 id="UTF-16-与-UCS-2-兼容问题"><a href="#UTF-16-与-UCS-2-兼容问题" class="headerlink" title="UTF-16 与 UCS-2 兼容问题"></a>UTF-16 与 UCS-2 兼容问题</h4><p>Unicode 标准规定了从<code>U+D800</code>到<code>U+DFFF</code>为 reserved range，保留位。UTF-16 就是利用这一保留区段来对基本平面 BMP 以外的辅助平面进行映射。需要注意的是，虽然标准规定了这一区段不可使用，但是实际使用中，在 UCS-2 的年代是用到了这一区段的。因此在许多编码解码的应用中，如果遇到保留区段的码点，会先对这个做检查，看该码点后是否能构成代理对，而不是直接按标准，把这个定义为编码错误。</p>
<h3 id="从码点到-UTF-8"><a href="#从码点到-UTF-8" class="headerlink" title="从码点到 UTF-8"></a>从码点到 UTF-8</h3>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Rust</p>
              <p class="site-description motion-element" itemprop="description">programming and free market</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives">
                
                    <span class="site-state-item-count">9</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">8</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">14</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Rust</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Pisces</a> v6.4.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.1"></script>



  



  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
